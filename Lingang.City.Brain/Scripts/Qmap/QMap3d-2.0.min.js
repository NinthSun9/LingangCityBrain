/*
 QMap3DJS_2.0+, A JS library Encapsulation for QMap3D OCX Engine.
 (c) 2013-2017 QMAP
*/
!function(window,document,undefined){function expose(){var e=window.Q3D;Q3D.noConflict=function(){return window.Q3D=e,this},window.Q3D=Q3D}var Q3D={version:"2.0+"};"object"==typeof module&&"object"==typeof module.exports?module.exports=Q3D:"function"==typeof define&&define.amd&&define(Q3D),"undefined"!=typeof window&&expose(),Q3D.Enums={ValueTypeCLSID:{QVector2:"8974ca38-d123-4516-9f49-c35ab5038a8b",QVector2I:"b8d6c462-0d1e-41cb-ab4c-0c0bdf090356",QVector3:"406e2212-9d78-45db-a2d5-cb326e9e7f3f",QVector3d:"8c53eb01-4520-4793-a4a6-0d1f61e8b51c",QGlobalVec3d:"bd2e69e3-8bec-46c4-a7db-35944c51bc3d",QColourValue:"2d90ae9b-31c8-45df-99f3-5af1687e035f"},device:{KEYBOARD:0,MOUSE:1,MULTITOUCH:2},mouse:{LBUTTON:0,MBUTTON:1,RBUTTON:2,WHEEL:4,LDCLICK:5,RDCLICK:6},multiTouch:{TRANS:1,CLOSETO:2,RAMBLE:3,YPS:4},keyboard:{ALL:{ctrlId:-1,wparam:-1},NUM_0:{ctrlId:0,wparam:48},NUM_1:{ctrlId:1,wparam:49},NUM_2:{ctrlId:2,wparam:50},NUM_3:{ctrlId:3,wparam:51},NUM_4:{ctrlId:4,wparam:52},NUM_5:{ctrlId:5,wparam:53},NUM_6:{ctrlId:6,wparam:54},NUM_7:{ctrlId:7,wparam:55},NUM_8:{ctrlId:8,wparam:56},NUM_9:{ctrlId:9,wparam:57},A:{ctrlId:10,wparam:65},B:{ctrlId:11,wparam:66},C:{ctrlId:12,wparam:67},D:{ctrlId:13,wparam:68},E:{ctrlId:14,wparam:69},F:{ctrlId:15,wparam:70},G:{ctrlId:16,wparam:71},H:{ctrlId:17,wparam:72},I:{ctrlId:18,wparam:73},J:{ctrlId:19,wparam:74},K:{ctrlId:20,wparam:75},L:{ctrlId:21,wparam:76},M:{ctrlId:22,wparam:77},N:{ctrlId:23,wparam:78},O:{ctrlId:24,wparam:79},P:{ctrlId:25,wparam:80},Q:{ctrlId:26,wparam:81},R:{ctrlId:27,wparam:82},S:{ctrlId:28,wparam:83},T:{ctrlId:29,wparam:84},U:{ctrlId:30,wparam:85},V:{ctrlId:31,wparam:86},W:{ctrlId:32,wparam:87},X:{ctrlId:33,wparam:88},Y:{ctrlId:34,wparam:89},Z:{ctrlId:35,wparam:90},F1:{ctrlId:36,wparam:112},F2:{ctrlId:37,wparam:113},F3:{ctrlId:38,wparam:114},F4:{ctrlId:39,wparam:115},F5:{ctrlId:40,wparam:116},F6:{ctrlId:41,wparam:117},F7:{ctrlId:42,wparam:118},F8:{ctrlId:43,wparam:119},F9:{ctrlId:44,wparam:120},F10:{ctrlId:45,wparam:121},F11:{ctrlId:46,wparam:122},F12:{ctrlId:47,wparam:123},ESCAPE:{ctrlId:48,wparam:27},ACCENT:{ctrlId:49,wparam:192},BACK:{ctrlId:50,wparam:0},ENTER:{ctrlId:51,wparam:13},SPACE:{ctrlId:52,wparam:32},LCTRL:{ctrlId:53,wparam:17},RCTRL:{ctrlId:54,wparam:17},LALT:{ctrlId:55,wparam:0},RALT:{ctrlId:56,wparam:0},LSHIFT:{ctrlId:57,wparam:16},RSHIFT:{ctrlId:58,wparam:16},INSERT:{ctrlId:59,wparam:45},DELETE:{ctrlId:60,wparam:46},HOME:{ctrlId:61,wparam:36},END:{ctrlId:62,wparam:35},PAGEUP:{ctrlId:63,wparam:33},PAGEDOWN:{ctrlId:64,wparam:34},LEFT:{ctrlId:65,wparam:37},RIGHT:{ctrlId:66,wparam:39},UP:{ctrlId:67,wparam:38},DOWN:{ctrlId:68,wparam:40},KP_0:{ctrlId:69,wparam:96},KP_1:{ctrlId:70,wparam:97},KP_2:{ctrlId:71,wparam:98},KP_3:{ctrlId:72,wparam:99},KP_4:{ctrlId:73,wparam:100},KP_5:{ctrlId:74,wparam:101},KP_6:{ctrlId:75,wparam:102},KP_7:{ctrlId:76,wparam:103},KP_8:{ctrlId:77,wparam:104},KP_9:{ctrlId:78,wparam:105}},actionType:{TRANS_LEFTX:6,TRANS_RIGHT:7,TRANS_FORTH:9,TRANS_BACKX:10,TRANS_UPXXX:11,TRANS_DOWNX:12,TRANS_UDLRX:25,TRANS_SCENE:14,TRANS_EARTH:34,TRANS_ORTHO:38,SCALED_CENTER:26,SCALES_CENTER:27,SCALED_SCREEN:13,SCALES_SCREEN:28,SCALEE_SCREEN:36,SCALEE_CENTER:37,SCALEX_ORTHOX:40,CAMERA_CLOSETO:22,ROTATES_CAMERA:15,ROTATET_CAMERA:29,ROTATES_SCREEN:21,ROTATET_SCREEN:30,ROTATES_CENTER:31,ROTATET_CENTER:32,ROTATES_FIXPNT:45,ROTATET_FIXPNT:46,ROTATES_EARTHX:35,ROTATET_EARTHX:36,ROTATEX_ORTHOX:39,RAMBLE_KEEPORI:20,RAMBLE_HEADUPX:33,OBJECTSELECT_MOVAUX:17,OBJECTSELECT_ROTAUX:18,OBJECTSELECT_SCAAUX:19,YPSS_CENTER:41,YPSS_SCREEN:23,YPST_CENTER:43,YPST_SCREEN:44,THIRD_ROTATE:100,THIRD_WHEEL:101,THIRD_MOVELEFT:102,THIRD_MOVERIGHT:103,THIRD_MOVEFORTH:104,THIRD_MOVEBACK:105,THIRD_MOVEUP:106,THIRD_MOVEDOWN:107,THIRD_MOVETO:108,THIRD_CAMERAROTATE:109,THIRD_TURNLEFT:110,THIRD_TURNRIGHT:111,THIRD_LOOKUP:112,THIRD_LOOKDOWN:113},actionMsg:{LIMIT_AUX:1,LIMIT_SELECT:2,SWITCH_INERTIA:3,SWITCH_LOCATOR:4,SET_INERTIA_PARAMETER:5,SET_INERTIA_DURATION:6,SET_TRANS_LIMITDRAGANGLE:7,SET_TRANS_LIMITMAPDISTANCE:8,SET_TRANS_LOOKUPMODE:9,SET_TRANS_SHORTESTDISTANCE:10,SET_TRANS_LIMITDRAGDISTANCE:11,SET_TRANS_STATICSPEED:12,SET_SCALE_STATICSPEED:13,SET_SCALE_DYNAMICSPEED:14,SET_SCALE_FORWARDSPEEDBUMP:15,SET_SCALE_BACKWARDSPEEDBUMP:16,SET_SCALE_SPEEDBUMPRATE:17,SET_SCALE_BACKWARDLIMIT:18,SET_YPS_SCALERATIO:19,SET_PITCHMIN:20,SET_PITCHMAX:21,SET_YAW_SPEED:22,SET_PITCH_SPEED:23,SWITCH_PITCH:24,SET_FIXPNT:25,SET_RAMBLE_TRANSLATESPEED:26,SET_RAMBLE_ROTATESPEED:27,SWITCH_USAGE:28},sceneNodeType:{SNODE_Invalid:-1,SNODE_Group:0,SNODE_LocalCamera:3,SNODE_Light:4,SNODE_Model:5,SNODE_ParticleSystem:6,SNODE_Billboard:8,SNODE_POI:14,SNODE_EnvMap:17,SNODE_Line:19,SNODE_LocalViewCamera:20,SNODE_VecModel:24,SNODE_CullAreaNode:26,SNODE_CullPlane:30,SNODE_Traffic:31,SNODE_Decal:32},lightType:{Point:0,Parallel:1,Spotlight:2},vecModelType:{QPolygon:0,QBuilding:1,QPyramid:2,QCylinder:3,QCone:4,QPipe:5,QSphere:6,QArrow:7,QJunction:8,QRoadway:9,QRailway:10,QWalls:11,QPrism:12},resourceType:{MESH:0,GEOMETRY:1,SKELETON:2,ANINODE:3,ANISKIN:4,ANITEX:5,PARTISYS:6,MATERIAL:7,TEXTURE:8,ANICLR:9,MAX:10,VIDEO:16},decalModeType:{OpBlendAlpha:0,OpBlendColor:1,OpAdd:2,OpModulate:3,DestTarget:0,DestGBuffer:256},decalNormalFlipMode:{None:0,X:1,Y:2,XY:3},orientationType:{Self:0,Parent:1,World:2},actorTrackType:{TransformMove:0,TransformRotate:1,TransformScale:2,ColorDiffuse:3,ColorDiffuseIntensity:4,ColorSpecular:5,ColorEmissive:6,ColorAlpha:7,Visible:8,VisibleDerived:9,TransformMoveAbs:10,TransformRotateAbs:11,Order:12},actorKeyType:{KeyAuto:0,KeyFloat:1,KeyVector2:2,KeyVector3:3,KeyQuaternion:4,KeyColourValue:5,VecLine:6,VecCircle:7,KeyVector3d:8},curveCtrlType:{Point:0,Linear:1,Bessel:2},timeCtrlType:{Linear:0,EaseIn:1,EaseOut:2},playerType:{Node:0,Material:1,Sky:2,Environment:3},fadeType:{fadeIn:0,fadeOut:1,fadeFlash:2},nodeContainerType:{Alpha:0,Color:1,Visible:2,Material:3},materialApplyMode:{Multiply:0,Add:1,Subtract:2,Replace:3},textureUnit:{DIFFUSE:1684629094,SPECULAR:1936745827,NORMAL:1852797549,LIGHT:1818847080,EDGE:1701078885,EMISSIVE:1701669235},poiImagePositionType:{POI_LOCATE_NONE:0,POI_LOCATE_LEFT:1,POI_LOCATE_HCENTER:2,POI_LOCATE_RIGHT:3,POI_LOCATE_TOP:256,POI_LOCATE_VCENTER:512,POI_LOCATE_BOTTOM:768,POI_LOCATE_LEFTTOP:257,POI_LOCATE_LEFTBOTTOM:769,POI_LOCATE_RIGHTTOP:259,POI_LOCATE_RIGHTBOTTOM:771,POI_LOCATE_CUSTOM:-1},nodeOrientationType:{Self:0,Parent:1,World:2},poiLayOut:{Left:0,Top:1,Right:2,Bottom:3,Center:4,LeftTop:768,LeftBottom:1024,RightTop:770,RightBottom:1026,TopLeft:257,TopRight:513,BottomLeft:259,BottomRight:515,LeftCustom:1280,TopCustom:1281,RightCustom:1282,BottomCustom:1283},poiUIType:{Normal:0,CameraOriented:1,CameraOrientedKeepSize:2},auxControlType:{AXIS_X:1,AXIS_Y:2,AXIS_Z:4,PLANE_XOY:16,PLANE_YOZ:32,PLANE_ZOX:64},auxOperateType:{Hide:0,Translate:1,Rotate:2,Scale:3},lineType:{StraightLine:0,Bessel:1,Parabola:2},camViewType:{Front:0,Top:1,Side:2,Axis:3},videoSourceType:{VIDSRC_LOCAL:0,VIDSRC_NETSTREAM:1},exitType:{SaveAndExit:1,DeleteAndExit:2},heatMapCalcType:{NearBy:1,Average:2,SquaredWeighted:3,RangeAttenuation:4},DecalTexFillMode:{FillOnly:1,FrameOnly:2,FillAndFrame:3},DecalMode:{OpBlendAlpha:0,OpBlendColor:1,OpAdd:3,OpModulate:4}},Q3D.Util={extend:function(e){var t,n,a,o;for(n=1,a=arguments.length;n<a;n++){o=arguments[n];for(t in o)e[t]=o[t]}return e},deepExtend:function(e,t){for(name in t)copy=t[name],copy instanceof Array?this.deepExtend(e[name],copy):copy instanceof Object?this.deepExtend(e[name],copy):e[name]=t[name];return e},deepCopy:function(e){var t={};for(var n in e)t[n]="object"==typeof e[n]?this.deepCopy(e[n]):e[n];return t},jQueryExtend:function(){var e,t,n,a,o=arguments[0]||{},i=1,r=arguments.length,s=!1;for("boolean"==typeof o&&(s=o,o=arguments[i]||{},i++),"object"==typeof o||this.isFunction(o)||(o={}),i===r&&(o=this,i--);i<r;i++)if(null!=(e=arguments[i]))for(t in e)n=o[t],a=e[t],o!==a&&(s&&a&&"object"==typeof a&&!a.nodeType?this.isArray(a)?o[t]=a.concat():this.isQMapObj(a)?o[t]=a:o[t]=this.jQueryExtend(s,n||{},a):a!==undefined&&(o[t]=a));return o},create:Object.create||function(){function e(){}return function(t){return e.prototype=t,new e}}(),bind:function(e,t){var n=Array.prototype.slice;if(e.bind)return e.bind.apply(e,n.call(arguments,1));var a=n.call(arguments,2);return function(){return e.apply(t,a.length?a.concat(n.call(arguments)):arguments)}},stamp:function(e){return e._qmap3d_id=e._qmap3d_id||++Q3D.Util.lastId,e._qmap3d_id},lastId:0,throttle:function(e,t,n){var a,o,i,r;return r=function(){a=!1,o&&(i.apply(n,o),o=!1)},i=function(){a?o=arguments:(e.apply(n,arguments),setTimeout(r,t),a=!0)}},wrapNum:function(e,t,n){var a=t[1],o=t[0],i=a-o;return e===a&&n?e:((e-o)%i+i)%i+o},falseFn:function(){return!1},formatNum:function(e,t){var n=Math.pow(10,t||5);return Math.round(e*n)/n},trim:function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")},splitWords:function(e){return Q3D.Util.trim(e).split(/\s+/)},setOptions:function(e,t){e.hasOwnProperty("options")||(e.options=e.options?Q3D.Util.create(e.options):{});for(var n in t)e.options[n]=t[n];return e.options},getParamString:function(e,t,n){var a=[];for(var o in e)a.push(encodeURIComponent(n?o.toUpperCase():o)+"="+encodeURIComponent(e[o]));return(t&&t.indexOf("?")!==-1?"&":"?")+a.join("&")},template:function(e,t){return e.replace(Q3D.Util.templateRe,function(e,n){var a=t[n];if(a===undefined)throw new Error("No value provided for variable "+e);return"function"==typeof a&&(a=a(t)),a})},templateRe:/\{ *([\w_\-]+) *\}/g,isArray:Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},isFunction:function(e){return"function"==typeof e},isNumber:function(e){return"number"==typeof e&&isFinite(e)},isInteger:function(e){return"number"==typeof e&&e%1===0},isDefined:function(e){return"undefined"!=typeof e},isQMapObj:function(e,t){try{if("string"==typeof e.getCLSID())return t===undefined||"string"==typeof t&&e.getCLSID()==t}catch(e){}return!1},isJson:function(e){return"object"==typeof e&&"[object object]"==Object.prototype.toString.call(e).toLowerCase()&&!e.length},indexOf:function(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return n;return-1},emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="},function(){function e(e){return window["webkit"+e]||window["moz"+e]||window["ms"+e]}function t(e){var t=+new Date,a=Math.max(0,16-(t-n));return n=t+a,window.setTimeout(e,a)}var n=0,a=window.requestAnimationFrame||e("RequestAnimationFrame")||t,o=window.cancelAnimationFrame||e("CancelAnimationFrame")||e("CancelRequestAnimationFrame")||function(e){window.clearTimeout(e)};Q3D.Util.requestAnimFrame=function(e,n,o){return o&&a===t?void e.call(n):a.call(window,Q3D.bind(e,n))},Q3D.Util.cancelAnimFrame=function(e){e&&o.call(window,e)}}(),Q3D.extend=Q3D.Util.extend,Q3D.bind=Q3D.Util.bind,Q3D.stamp=Q3D.Util.stamp,Q3D.setOptions=Q3D.Util.setOptions,Q3D.DomUtil={get:function(e){return"string"==typeof e?document.getElementById(e):e},getIdByScript:function(e){for(var t=document.getElementsByTagName("script"),n=t.length-1;n>=0;n--)if(t[n].event.indexOf(e)>-1)return t[n].getAttribute("for");return null},getStyle:function(e,t){var n=e.style[t]||e.currentStyle&&e.currentStyle[t];if((!n||"auto"===n)&&document.defaultView){var a=document.defaultView.getComputedStyle(e,null);n=a?a[t]:null}return"auto"===n?null:n},create:function(e,t,n){var a=document.createElement(e);return a.className=t||"",n&&n.appendChild(a),a},remove:function(e){var t=e.parentNode;t&&t.removeChild(e)},empty:function(e){for(;e.firstChild;)e.removeChild(e.firstChild)},toFront:function(e){e.parentNode.appendChild(e)},toBack:function(e){var t=e.parentNode;t.insertBefore(e,t.firstChild)},hasClass:function(e,t){if(e.classList!==undefined)return e.classList.contains(t);var n=Q3D.DomUtil.getClass(e);return n.length>0&&new RegExp("(^|\\s)"+t+"(\\s|$)").test(n)},addClass:function(e,t){if(e.classList!==undefined)for(var n=Q3D.Util.splitWords(t),a=0,o=n.length;a<o;a++)e.classList.add(n[a]);else if(!Q3D.DomUtil.hasClass(e,t)){var i=Q3D.DomUtil.getClass(e);Q3D.DomUtil.setClass(e,(i?i+" ":"")+t)}},removeClass:function(e,t){e.classList!==undefined?e.classList.remove(t):Q3D.DomUtil.setClass(e,Q3D.Util.trim((" "+Q3D.DomUtil.getClass(e)+" ").replace(" "+t+" "," ")))},setClass:function(e,t){e.className.baseVal===undefined?e.className=t:e.className.baseVal=t},getClass:function(e){return e.className.baseVal===undefined?e.className:e.className.baseVal},setOpacity:function(e,t){"opacity"in e.style?e.style.opacity=t:"filter"in e.style&&Q3D.DomUtil._setOpacityIE(e,t)},_setOpacityIE:function(e,t){var n=!1,a="DXImageTransform.Microsoft.Alpha";try{n=e.filters.item(a)}catch(e){if(1===t)return}t=Math.round(100*t),n?(n.Enabled=100!==t,n.Opacity=t):e.style.filter+=" progid:"+a+"(opacity="+t+")"},testProp:function(e){for(var t=document.documentElement.style,n=0;n<e.length;n++)if(e[n]in t)return e[n];return!1},setTransform:function(e,t,n){var a=t||new Q3D.Point(0,0);e.style[Q3D.DomUtil.TRANSFORM]=(Q3D.Browser.ie3d?"translate("+a.x+"px,"+a.y+"px)":"translate3d("+a.x+"px,"+a.y+"px,0)")+(n?" scale("+n+")":"")},setPosition:function(e,t){e._leaflet_pos=t,Q3D.Browser.any3d?Q3D.DomUtil.setTransform(e,t):(e.style.left=t.x+"px",e.style.top=t.y+"px")},getPosition:function(e){return e._leaflet_pos||new Q3D.Point(0,0)}},function(){Q3D.DomUtil.TRANSFORM=Q3D.DomUtil.testProp(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]);var e=Q3D.DomUtil.TRANSITION=Q3D.DomUtil.testProp(["webkitTransition","transition","OTransition","MozTransition","msTransition"]);if(Q3D.DomUtil.TRANSITION_END="webkitTransition"===e||"OTransition"===e?e+"End":"transitionend","onselectstart"in document)Q3D.DomUtil.disableTextSelection=function(){Q3D.DomEvent.on(window,"selectstart",Q3D.DomEvent.preventDefault)},Q3D.DomUtil.enableTextSelection=function(){Q3D.DomEvent.off(window,"selectstart",Q3D.DomEvent.preventDefault)};else{var t=Q3D.DomUtil.testProp(["userSelect","WebkitUserSelect","OUserSelect","MozUserSelect","msUserSelect"]);Q3D.DomUtil.disableTextSelection=function(){if(t){var e=document.documentElement.style;this._userSelect=e[t],e[t]="none"}},Q3D.DomUtil.enableTextSelection=function(){t&&(document.documentElement.style[t]=this._userSelect,delete this._userSelect)}}Q3D.DomUtil.disableImageDrag=function(){Q3D.DomEvent.on(window,"dragstart",Q3D.DomEvent.preventDefault)},Q3D.DomUtil.enableImageDrag=function(){Q3D.DomEvent.off(window,"dragstart",Q3D.DomEvent.preventDefault)},Q3D.DomUtil.preventOutline=function(e){for(;e.tabIndex===-1;)e=e.parentNode;e&&e.style&&(Q3D.DomUtil.restoreOutline(),this._outlineElement=e,this._outlineStyle=e.style.outline,e.style.outline="none",Q3D.DomEvent.on(window,"keydown",Q3D.DomUtil.restoreOutline,this))},Q3D.DomUtil.restoreOutline=function(){this._outlineElement&&(this._outlineElement.style.outline=this._outlineStyle,delete this._outlineElement,delete this._outlineStyle,Q3D.DomEvent.off(window,"keydown",Q3D.DomUtil.restoreOutline,this))}}(),function(){var e=navigator.userAgent.toLowerCase(),t="ActiveXObject"in window,n=e.indexOf("webkit")!==-1,a=e.indexOf("chrome")!==-1,o=e.indexOf("gecko")!==-1&&!n&&!window.opera&&!t,i=0===navigator.platform.indexOf("Win"),r=!window.PointerEvent&&window.MSPointerEvent,s=window.PointerEvent||r,l=!window.L_NO_TOUCH&&(s||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch);Q3D.Browser={ie:t,ielt9:t&&!document.addEventListener,ie11:t&&!document.attachEvent,edge:"msLaunchUri"in navigator&&!("documentMode"in document),webkit:n,gecko:o,chrome:a,safari:!a&&e.indexOf("safari")!==-1,win:i,touch:!!l,msPointer:!!r,pointer:!!s}}(),Q3D.Class=function(){},Q3D.Class.extend=function(e){var t=function(){this.initialize&&this.initialize.apply(this,arguments),this.callInitHooks()},n=t.__super__=this.prototype,a=Q3D.Util.create(n);a.constructor=t,t.prototype=a;for(var o in this)this.hasOwnProperty(o)&&"prototype"!==o&&(t[o]=this[o]);return e.statics&&(Q3D.extend(t,e.statics),delete e.statics),e.includes&&(Q3D.Util.extend.apply(null,[a].concat(e.includes)),delete e.includes),a.options&&(e.options=Q3D.Util.extend(Q3D.Util.create(a.options),e.options)),Q3D.extend(a,e),a._initHooks=[],a.callInitHooks=function(){if(!this._initHooksCalled){n.callInitHooks&&n.callInitHooks.call(this),this._initHooksCalled=!0;for(var e=0,t=a._initHooks.length;e<t;e++)a._initHooks[e].call(this)}},t},Q3D.Class.include=function(e){return Q3D.extend(this.prototype,e),this},Q3D.Class.mergeOptions=function(e){return Q3D.extend(this.prototype.options,e),this},Q3D.Class.addInitHook=function(e){var t=Array.prototype.slice.call(arguments,1),n="function"==typeof e?e:function(){this[e].apply(this,t)};return this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(n),this},Q3D.Evented=Q3D.Class.extend({_keyUpFn:function(e,t){var n=mapObj._keyEvents.OnKeyUp;if(n){for(var a=0,o=n.length;a<o;a++)if(n[a].key.wparam==e){n[a].enabled&&n[a].fn(e,t);break}for(var a=0,o=n.length;a<o;a++)if(n[a].key.wparam==-1)return void(n[a].enabled&&n[a].fn(e,t))}},_keyDownFn:function(e,t){var n=mapObj._keyEvents.OnKeyDown;if(n){for(var a=0,o=n.length;a<o;a++)if(n[a].key.wparam==e){n[a].enabled&&n[a].fn(e,t);break}for(var a=0,o=n.length;a<o;a++)if(n[a].key.wparam==-1)return void(n[a].enabled&&n[a].fn(e,t))}},_notifyMouseButtonClickFn:function(e){var t=mapObj._widgetEvents.onNotifyMouseButtonClick;if(t)for(var n=0,a=t.length;n<a;n++)if(t[n].key==e.getName())return void(t[n].enabled&&t[n].fn(e))},_movieClipInstancePassFrameFn:function(e,t){var n=mapObj._widgetEvents.onMovieClipInstancePassFrame;if(n)for(var a=0,o=n.length;a<o;a++)if(n[a].key==e.getCName()+"/"+t)return void(n[a].enabled&&n[a].fn(e,t))},_actCtrlObjAniEnd:function(e){var t=mapObj._widgetEvents.onActCtrlObjAniEnd;if(t)for(var n=0,a=t.length;n<a;n++)if(t[n].key==e.getBinderAsNode().getName())return void(t[n].enabled&&t[n].fn(e))},_widgetCloseFn:function(e){var t=mapObj._widgetEvents.onWidgetClose;if(t)for(var n=0,a=t.length;n<a;n++)if(t[n].key==e)return t[n].enabled&&t[n].fn(e),mapObj.detachUIEvent("onWidgetClose",e),void mapObj.detachUIEvent("onUserNotifyEX",e)},_videoCtrlCloseFn:function(e){var t=mapObj._widgetEvents.onVideoCtrlClose;if(t)for(var n=0,a=t.length;n<a;n++)if(t[n].key==e)return t[n].enabled&&t[n].fn(e),void mapObj.detachUIEvent("onVideoCtrlClose",e)},_sceneNodeAllResourceCompletedFn:function(e){var t=mapObj._widgetEvents.onSceneNodeAllResourceCompleted;if(t)for(var n=0,a=t.length;n<a;n++)if(t[n].key==mapObj.getSceneNodeFullName(e))return t[n].enabled&&t[n].fn(e),void mapObj.detachUIEvent("onSceneNodeAllResourceCompleted",mapObj.getSceneNodeFullName(e))},_userNotifyEXFn:function(e,t,n){var a=mapObj._widgetEvents.onUserNotifyEX;if(a)for(var o=0,i=a.length;o<i;o++)if(a[o].key==e)return void(a[o].enabled&&a[o].fn(e,t,n))},_processInputParam:function(e,t,n,a,o,i){var r=!1,s=!1;switch(e){case 5:case 6:case 20:r=!0,s=!1;break;case 9:case 10:case 24:r=!1,s=!0;break;case 13:case 14:case 28:r=!0,s=!0}var l=Q3D.vector2I(t,n).get(),c=mapObj._map3d.getWorldManager().getMainCamera(0),u=c.getCrossCoord(l,65),d=c.pickNearsetSceneNode(l,65),p=null==d||null==u?null:d.getArea().toLocalPos(u),m={logX:t,logY:n,groundX:null==u?0:u.x,groundY:null==u?0:u.y,groundZ:null==u?0:u.z,NearestNode:d,ScreenCoord:l,GroundCoord:u,AreaCoord:p,ShiftPressDown:r,CtrlPressDown:s};if(mapObj._enableDebug&&console){console.log("========================================================================================");var h=new Date;if(console.log("操作时间："+h.getHours()+":"+h.getMinutes()+":"+h.getSeconds()),null!=m.GroundCoord){console.log("当前点击位置平面坐标："+m.GroundCoord.x.toFixed(6)+","+m.GroundCoord.y.toFixed(6)+","+m.GroundCoord.z.toFixed(6));var y=Q3D.vector3d(m.GroundCoord),g=Q3D.globalVec3d(y.toGlobalVec3d());console.log("当前点击位置经纬度坐标："+g.longitude.toFixed(6)+","+g.latitude.toFixed(6)+","+g.height.toFixed(6))}null!=m.NearestNode&&(console.log("当前区域："+m.NearestNode.getArea().getName()),console.log('当前点击选中节点：("'+m.NearestNode.getArea().getName()+"/"+m.NearestNode.getName()+'")'),console.log("当前点击选中节点父节点："+(null==m.NearestNode.getParent()?"节点为根节点":'("'+m.NearestNode.getParent().getArea().getName()+"/"+m.NearestNode.getParent().getName()+'")'))),console.log("========================================================================================")}return m},_OnLButtonDownFn:function(e,t,n,a,o,i){var r=mapObj._mouseEvents.OnLButtonDown;if(r)for(var s=mapObj._processInputParam(e,t,n,a,o,i),l=0,c=r.length;l<c;l++)if(r[l].name==mapObj._mouseEventNames.OnLButtonDown)return void(r[l].enabled&&r[l].fn(s))},_OnRButtonDownFn:function(e,t,n,a,o,i){var r=mapObj._mouseEvents.OnRButtonDown;if(r)for(var s=mapObj._processInputParam(e,t,n,a,o,i),l=0,c=r.length;l<c;l++)if(r[l].name==mapObj._mouseEventNames.OnRButtonDown)return void(r[l].enabled&&r[l].fn(s))},_OnMButtonDownFn:function(e,t,n,a,o,i){var r=mapObj._mouseEvents.OnMButtonDown;if(r)for(var s=mapObj._processInputParam(e,t,n,a,o,i),l=0,c=r.length;l<c;l++)if(r[l].name==mapObj._mouseEventNames.OnMButtonDown)return void(r[l].enabled&&r[l].fn(s))},_OnLButtonUpFn:function(e,t,n,a,o,i){var r=mapObj._mouseEvents.OnLButtonUp;if(r)for(var s=mapObj._processInputParam(e,t,n,a,o,i),l=0,c=r.length;l<c;l++)if(r[l].name==mapObj._mouseEventNames.OnLButtonUp)return void(r[l].enabled&&r[l].fn(s))},_OnRButtonUpFn:function(e,t,n,a,o,i){var r=mapObj._mouseEvents.OnRButtonUp;if(r)for(var s=mapObj._processInputParam(e,t,n,a,o,i),l=0,c=r.length;l<c;l++)if(r[l].name==mapObj._mouseEventNames.OnRButtonUp)return void(r[l].enabled&&r[l].fn(s))},_OnMButtonUpFn:function(e,t,n,a,o,i){var r=mapObj._mouseEvents.OnMButtonUp;if(r)for(var s=mapObj._processInputParam(e,t,n,a,o,i),l=0,c=r.length;l<c;l++)if(r[l].name==mapObj._mouseEventNames.OnMButtonUp)return void(r[l].enabled&&r[l].fn(s))},_OnLButtonDblClkFn:function(e,t,n,a,o,i){var r=mapObj._mouseEvents.OnLButtonDblClk;if(r)for(var s=mapObj._processInputParam(e,t,n,a,o,i),l=0,c=r.length;l<c;l++)if(r[l].name==mapObj._mouseEventNames.OnLButtonDblClk)return void(r[l].enabled&&r[l].fn(s))},_OnRButtonDblClkFn:function(e,t,n,a,o,i){var r=mapObj._mouseEvents.OnRButtonDblClk;if(r)for(var s=mapObj._processInputParam(e,t,n,a,o,i),l=0,c=r.length;l<c;l++)if(r[l].name==mapObj._mouseEventNames.OnRButtonDblClk)return void(r[l].enabled&&r[l].fn(s))},_OnMouseWheelFn:function(e,t,n,a,o,i){var r=mapObj._mouseEvents.OnMouseWheel;if(r)for(var s=mapObj._processInputParam(e,t,n,a,o,i),l=0,c=r.length;l<c;l++)if(r[l].name==mapObj._mouseEventNames.OnMouseWheel)return void(r[l].enabled&&r[l].fn(s))},_mouseMoveMethod:function(e){var t=mapObj._mouseEvents.OnMouseMove;if(t)for(var n=e.split(","),a=mapObj._processInputParam(parseInt(n[0]),parseInt(n[1]),parseInt(n[2]),parseInt(n[3]),parseInt(n[4]),parseInt(n[5])),o=0,i=t.length;o<i;o++)if(t[o].name==mapObj._mouseEventNames.OnMouseMove)return void(t[o].enabled&&t[o].fn(a))},_OnMouseMoveFn:function(e,t,n,a,o,i){var r=(new Date).getTime();r-mapObj._lastMousemoveTime<=mapObj._mousemoveTime||(mapObj._lastMousemoveTime=r,setTimeout("mapObj._mouseMoveMethod('"+e+","+t+","+n+","+a+","+o+","+i+"')",mapObj._mousemoveTime))},_attachEventForIE11:function(e,t,n){var a=/^function\s?([^\s(]*)/,o=/\(\)|\(.+\)/,i=n.toString().replace("{","\r\n{").match(o)[0],r=n.name;if(!r){var s=n.toString().match(a);r=s&&s.length>1?s[1]:""}var l;try{l=document.createElement("script"),l.setAttribute("for",e.id)}catch(t){l=document.createElement('<script for="'+e.id+'">')}return l.event=t+i,""==r?l.appendChild(document.createTextNode("("+n+")"+i+";")):l.appendChild(document.createTextNode(r+i+";")),document.body.appendChild(l),l},_detachEventForIE11:function(e,t,n){for(var a=document.getElementsByTagName("script"),o=a.length-1;o>=0;o--)a[o].getAttribute("for")===e.id&&a[o].event.indexOf(t)>-1&&Q3D.DomUtil.remove(a[o])},_eventBind:function(flag,type,fn,context){var newFn=fn,eventType=type.toUpperCase();switch(eventType){case"ONKEYUP":newFn=this._keyUpFn;break;case"ONKEYDOWN":newFn=this._keyDownFn;break;case"ONLBUTTONDOWN":newFn=this._OnLButtonDownFn;break;case"ONRBUTTONDOWN":newFn=this._OnRButtonDownFn;break;case"ONMBUTTONDOWN":newFn=this._OnMButtonDownFn;break;case"ONLBUTTONUP":newFn=this._OnLButtonUpFn;break;case"ONRBUTTONUP":newFn=this._OnRButtonUpFn;break;case"ONMBUTTONUP":newFn=this._OnMButtonUpFn;break;case"ONLBUTTONDBLCLK":newFn=this._OnLButtonDblClkFn;break;case"ONRBUTTONDBLCLK":newFn=this._OnRButtonDblClkFn;break;case"ONMOUSEWHEEL":newFn=this._OnMouseWheelFn;break;case"ONMOUSEMOVE":newFn=this._OnMouseMoveFn,this._lastMousemoveTime=0,this._mousemoveTime=100;break;case"ONNOTIFYMOUSEBUTTONCLICK":newFn=this._notifyMouseButtonClickFn;break;case"ONWIDGETCLOSE":newFn=this._widgetCloseFn;break;case"ONUSERNOTIFYEX":newFn=this._userNotifyEXFn;break;case"ONMOVIECLIPINSTANCEPASSFRAME":newFn=this._movieClipInstancePassFrameFn;break;case"ONACTCTRLOBJANIEND":newFn=this._actCtrlObjAniEnd;break;case"ONVIDEOCTRLCLOSE":newFn=this._videoCtrlCloseFn;break;case"ONSCENENODEALLRESOURCECOMPLETED":newFn=this._sceneNodeAllResourceCompletedFn}flag?Q3D.Browser.ie?context.attachEvent?context.attachEvent(type,newFn):this._attachEventForIE11(context,type,newFn):eval("window."+type+" = "+newFn):Q3D.Browser.ie?context.detachEvent?context.detachEvent(type,newFn):this._detachEventForIE11(context,type,newFn):eval("window."+type+" = null; ")},on:function(e,t,n){if("object"==typeof e)for(var a in e)this._on(a,e[a],t);else{e=Q3D.Util.splitWords(e);for(var o=0,i=e.length;o<i;o++)this._on(e[o],t,n)}return this},off:function(e,t,n){if(e)if("object"==typeof e)for(var a in e)this._off(a,e[a],t);else{e=Q3D.Util.splitWords(e);for(var o=0,i=e.length;o<i;o++)this._off(e[o],t,n)}else delete this._events;return this},_on:function(e,t,n){this._events=this._events||{};var a=this._events[e];a||(a=[],this._events[e]=a),n=n===this?undefined:mapObj._map3d;var o={fn:t,ctx:n},i=a;i.length&&this._off(e,i[0].fn,i[0].ctx),i.push(o),this._eventBind(!0,e,o.fn,o.ctx)},_off:function(e,t,n){var a,o,i;if(this._events&&(a=this._events[e])){if(n=n===this?undefined:mapObj._map3d,!t){for(o=0,i=a.length;o<i;o++)this._eventBind(!1,e,a[o].fn,n);return void delete this._events[e]}if(a){var r=t.toString().replace(/\s+/g,"").replace(/[\r\n]/g,"").toLowerCase();for(o=0,i=a.length;o<i;o++){var s=a[o],l=a[o].fn.toString().replace(/\s+/g,"").replace(/[\r\n]/g,"").toLowerCase();if(s.ctx===n&&l===r)return this._eventBind(!1,e,s.fn,n),s.fn=Q3D.Util.falseFn,this._firingCount&&(this._events[e]=a=a.slice()),void a.splice(o,1)}}}},fire:function(e,t,n){if(!this.listens(e,n))return this;var a=Q3D.Util.extend({},t,{type:e,target:this});if(this._events){var o=this._events[e];if(o){this._firingCount=this._firingCount+1||1;for(var i=0,r=o.length;i<r;i++){var s=o[i];s.fn.call(s.ctx||this,a)}this._firingCount--}}return n&&this._propagateEvent(a),this},listens:function(e,t){var n=null,a=e.toUpperCase();switch(a){case"ONKEYUP":case"ONKEYDOWN":n=this._keyEvents&&this._keyEvents[e];break;case"ONLBUTTONDOWN":case"ONRBUTTONDOWN":case"ONMBUTTONDOWN":case"ONLBUTTONUP":case"ONRBUTTONUP":case"ONMBUTTONUP":case"ONLBUTTONDBLCLK":case"ONRBUTTONDBLCLK":case"ONMOUSEWHEEL":case"ONMOUSEMOVE":n=this._mouseEvents&&this._mouseEvents[e];break;case"ONNOTIFYMOUSEBUTTONCLICK":case"ONWIDGETCLOSE":case"ONVIDEOCTRLCLOSE":case"ONMOVIECLIPINSTANCEPASSFRAME":case"ONACTCTRLOBJANIEND":case"ONUSERNOTIFYEX":n=this._widgetEvents&&this._widgetEvents[e];break;default:n=this._events&&this._events[e]}return!(!n||!n.length)},once:function(e,t,n){if("object"==typeof e){for(var a in e)this.once(a,e[a],t);return this}var o=Q3D.bind(function(){this.off(e,t,n).off(e,o,n)},this);return this.on(e,t,n).on(e,o,n)},attachKeyEvent:function(e,t,n){this._keyEvents=this._keyEvents||{};var a=this._keyEvents[e];a||(a=[],this._keyEvents[e]=a);for(var o={key:t,fn:n,enabled:!0},i=a,r=0,s=i.length;r<s;r++)if(i[r].key===t)return;return 0==i.length&&this._eventBind(!0,e,o.fn,mapObj._map3d),i.push(o),this},detachKeyEvent:function(e,t){var n,a,o;if(this._keyEvents&&(n=this._keyEvents[e],n&&n.length)){if(!t)return this._eventBind(!1,e,"OnKeyUp"==e?this._keyUpFn:this._keyDownFn,mapObj._map3d),void delete this._keyEvents[e];if(n)for(a=0,o=n.length;a<o;a++){var i=n[a];if(i.key===t)return 1==n.length&&this._eventBind(!1,e,"OnKeyUp"==e?this._keyUpFn:this._keyDownFn,mapObj._map3d),void n.splice(a,1)}return this}},setKeyEvent:function(e,t,n){var a,o,i;if(this._keyEvents&&(a=this._keyEvents[e])){for(o=0,i=a.length;o<i;o++){var r=a[o];if(r.key===t)return void(r.enabled=n)}return this}},getKeyEventStatus:function(e,t){var n,a,o;if(!this._keyEvents)return null;if(n=this._keyEvents[e],!n)return!1;for(a=0,o=n.length;a<o;a++){var i=n[a];if(i.key===t)return i.enabled}return!1},attachUIEvent:function(e,t,n){this._widgetEvents=this._widgetEvents||{};var a=this._widgetEvents[e];a||(a=[],this._widgetEvents[e]=a);for(var o={key:t,fn:n,enabled:!0},i=a,r=0,s=i.length;r<s;r++)if(i[r].key===t)return;return 0==i.length&&this._eventBind(!0,e,o.fn,mapObj._map3d),i.push(o),this},detachUIEvent:function(e,t){var n,a,o;if(this._widgetEvents&&(n=this._widgetEvents[e],n&&n.length)){var i=null;switch(e){case"onNotifyMouseButtonClick":i=this._notifyMouseButtonClickFn;break;case"onWidgetClose":i=this._widgetCloseFn;break;case"onUserNotifyEX":i=this._userNotifyEXFn;break;case"onMovieClipInstancePassFrame":i=this._movieClipInstancePassFrameFn;break;case"onActCtrlObjAniEnd":i=this._actCtrlObjAniEnd;break;case"onVideoCtrlClose":i=this._videoCtrlCloseFn;break;case"onSceneNodeAllResourceCompleted":i=this._sceneNodeAllResourceCompletedFn}if(!t)return this._eventBind(!1,e,i,mapObj._map3d),void delete this._widgetEvents[e];if(n)for(a=0,o=n.length;a<o;a++){var r=n[a];if(r.key===t)return 1==n.length&&this._eventBind(!1,e,i,mapObj._map3d),void n.splice(a,1)}return this}},attachMouseEvent:function(e,t,n){this._mouseEvents=this._mouseEvents||{},this._mouseEventNames=this._mouseEventNames||{},this._mouseEventNames[e]=t;var a=this._mouseEvents[e];a||(a=[],this._mouseEvents[e]=a);for(var o={fn:n,name:t,enabled:!0},i=a,r=0,s=i.length;r<s;r++)if(i[r].name===t){if(!n){o.fn=i[r].fn;break}return}return 0==i.length&&this._eventBind(!0,e,o.fn,mapObj._map3d),n&&i.push(o),this},detachMouseEvent:function(e,t){var n,a,o;if(this._mouseEvents&&(n=this._mouseEvents[e],n&&n.length)){if(!t)return this._eventBind(!1,e,n[0].fn,mapObj._map3d),void delete this._mouseEvents[e];if(n)for(a=0,o=n.length;a<o;a++){var i=n[a];if(i.name===t){if(this._mouseEventNames[e]==t)if(1==n.length)this._eventBind(!1,e,n[a].fn,mapObj._map3d),delete this._mouseEvents[e];else{var r=a;r=--r<0?r+n.length:r,this._mouseEventNames[e]=n[r].name}return n.splice(a,1),void(0==n.length&&delete n)}}return this}},getMouseEventStatus:function(e,t){var n,a,o;if(!this._mouseEvents)return null;if(n=this._mouseEvents[e],!n)return null;for(a=0,o=n.length;a<o;a++){var i=n[a];if(i.name===t)return i.enabled}return null},setMouseEvent:function(e,t,n){var a,o,i;if(this._mouseEvents&&(a=this._mouseEvents[e])){for(o=0,i=a.length;o<i;o++){var r=a[o];if(r.name===t)return void(r.enabled=n)}return this}}}),window.mapObj=null,Q3D.Map=Q3D.Evented.extend({options:{Id:"map",SERVER_PATH:null,DATA_PATH:null,DOWNLOAD_TYPE:"REAL",CONFIG_NAME:null,LICENSE_SVR:null,WINDOWLESS:!1,LOADING:!0,OPACITY:1,MarginRightBottom:[0,0],OnLoadBefore:null,OnLoadEnd:null,OnUIInitEnd:null,DefaultMouseEvent:{},OnInitialFail:null,LowestEngineVersionNeed:{version:"2, 8, 0, 0",callback:null}},initialize:function(e,t){if(this.options=Q3D.setOptions(this,t),null==this.options.CONFIG_NAME)throw new Error("没有设置配置文件");if(null==this.options.SERVER_PATH)throw new Error("没有设置场景文件下载地址");this._initContainer(e),this.options.LOADING&&(this._mapUI=new Q3D.QMapV2Custom($("#"+this._map3d.id)),this._mapUI.ProcessLoading(this.options.MarginRightBottom)),setTimeout(function(){try{this._map3d.logo=0,this._map3d.setInitPara("SERVER_PATH",this.options.SERVER_PATH),this._map3d.setInitPara("CONFIG_NAME",this.options.CONFIG_NAME),this._map3d.setInitPara("DOWNLOAD_TYPE",this.options.DOWNLOAD_TYPE),
this._map3d.setInitPara("THREAD_COUNT",4),null!=this.options.LICENSE_SVR&&this._map3d.setLicenseSvr(this.options.LICENSE_SVR),this.options.LOADING&&(this._map3d.setHibernateTime(0),this._map3d.setCreateAreaListener(),this._map3d.setUISystemEventListener(),this._map3d.setEngineListener());var e=this._map3d.init();if(1!=e&&!Q3D.Browser.gecko)return void this.showNotice("提示","引擎初始化失败，请检查参数设置后关闭已经开启的引擎页面后重试");if(parseInt(this.options.LowestEngineVersionNeed.version.replace(new RegExp(/,| |，/g),""))>parseInt(this._map3d.getVersion().replace(new RegExp(/, /g),"")))return Q3D.Util.isFunction(this.options.LowestEngineVersionNeed.callback)&&this.options.LowestEngineVersionNeed.callback(),this.showNotice("提示","您的引擎版本过低，请下载安装最新版本"),mapObj._mapUI.InitHelpDiaLog({MessageHTML:"引擎初始化失败，请关闭已经开启的引擎页面后重试。",NeedSetup:!0}),void mapObj._mapUI.ShowHelpDialog();Q3D.Util.isFunction(this.options.OnLoadBefore)&&this.options.OnLoadBefore(),Q3D.Util.isFunction(this.options.OnUIInitEnd)&&this.on("onQUISystemInit",function(){mapObj.options.OnUIInitEnd(),mapObj.off("onQUISystemInit")});var t=this._map3d.getInputManager();t.createActionEx(Q3D.Enums.actionType.TRANS_LEFTX),t.createActionEx(Q3D.Enums.actionType.TRANS_RIGHT),t.createActionEx(Q3D.Enums.actionType.TRANS_FORTH),t.createActionEx(Q3D.Enums.actionType.TRANS_BACKX),t.createActionEx(Q3D.Enums.actionType.TRANS_UPXXX),t.createActionEx(Q3D.Enums.actionType.TRANS_DOWNX),t.createActionEx(Q3D.Enums.actionType.TRANS_UDLRX),t.createActionEx(Q3D.Enums.actionType.TRANS_SCENE),t.createActionEx(Q3D.Enums.actionType.SCALED_CENTER),t.createActionEx(Q3D.Enums.actionType.SCALES_CENTER),t.createActionEx(Q3D.Enums.actionType.SCALED_SCREEN),t.createActionEx(Q3D.Enums.actionType.SCALES_SCREEN),t.createActionEx(Q3D.Enums.actionType.CAMERA_CLOSETO),t.createActionEx(Q3D.Enums.actionType.ROTATES_CAMERA),t.createActionEx(Q3D.Enums.actionType.ROTATET_CAMERA),t.createActionEx(Q3D.Enums.actionType.ROTATES_SCREEN),t.createActionEx(Q3D.Enums.actionType.ROTATET_SCREEN),t.createActionEx(Q3D.Enums.actionType.ROTATES_CENTER),t.createActionEx(Q3D.Enums.actionType.ROTATET_CENTER),t.createActionEX(Q3D.Enums.actionType.ROTATES_FIXPNT),t.createActionEX(Q3D.Enums.actionType.ROTATET_FIXPNT),t.createActionEx(Q3D.Enums.actionType.RAMBLE_KEEPORI),t.createActionEx(Q3D.Enums.actionType.OBJECTSELECT_MOVAUX),t.createActionEx(Q3D.Enums.actionType.OBJECTSELECT_ROTAUX),t.createActionEx(Q3D.Enums.actionType.OBJECTSELECT_SCAAUX),t.createActionEx(Q3D.Enums.actionType.YPSS_SCREEN),t.createActionEx(Q3D.Enums.actionType.YPST_SCREEN),t.createActionEx(Q3D.Enums.actionType.YPSS_CENTER),t.createActionEx(Q3D.Enums.actionType.YPST_CENTER),t.createActionEx(Q3D.Enums.actionType.THIRD_ROTATE),t.createActionEx(Q3D.Enums.actionType.THIRD_WHEEL),t.createActionEx(Q3D.Enums.actionType.THIRD_MOVELEFT),t.createActionEx(Q3D.Enums.actionType.THIRD_MOVERIGHT),t.createActionEx(Q3D.Enums.actionType.THIRD_MOVEFORTH),t.createActionEx(Q3D.Enums.actionType.THIRD_MOVEBACK),t.createActionEx(Q3D.Enums.actionType.THIRD_MOVEUP),t.createActionEx(Q3D.Enums.actionType.THIRD_MOVEDOWN),t.createActionEx(Q3D.Enums.actionType.THIRD_MOVETO),t.createActionEx(Q3D.Enums.actionType.THIRD_CAMERAROTATE),t.createActionEx(Q3D.Enums.actionType.THIRD_TURNLEFT),t.createActionEx(Q3D.Enums.actionType.THIRD_TURNRIGHT),t.createActionEx(Q3D.Enums.actionType.THIRD_LOOKUP),t.createActionEx(Q3D.Enums.actionType.THIRD_LOOKDOWN),t.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.LEFT.ctrlId,Q3D.Enums.actionType.TRANS_LEFTX),t.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.RIGHT.ctrlId,Q3D.Enums.actionType.TRANS_RIGHT),t.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.UP.ctrlId,Q3D.Enums.actionType.TRANS_FORTH),t.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.DOWN.ctrlId,Q3D.Enums.actionType.TRANS_BACKX),t.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.LBUTTON,Q3D.Enums.actionType.TRANS_SCENE),t.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.MBUTTON,Q3D.Enums.actionType.RAMBLE_KEEPORI),t.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.RBUTTON,Q3D.Enums.actionType.ROTATES_SCREEN),t.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.WHEEL,Q3D.Enums.actionType.SCALED_SCREEN),t.bindControlAction(Q3D.Enums.device.MULTITOUCH,Q3D.Enums.multiTouch.TRANS,Q3D.Enums.actionType.TRANS_SCENE),t.bindControlAction(Q3D.Enums.device.MULTITOUCH,Q3D.Enums.multiTouch.RAMBLE,Q3D.Enums.actionType.RAMBLE_KEEPORI),t.bindControlAction(Q3D.Enums.device.MULTITOUCH,Q3D.Enums.multiTouch.YPS,Q3D.Enums.actionType.YPSS_SCREEN),this.options.LOADING&&(this.on("onPreGroupPrepare",function(e){mapObj._mapUI.TriggerLoading(null,"系统配置文件解析完毕...",2,100),mapObj._map3d.setResourceGroupListener(e)}),this.on("onAllSceneFilesFirstLoadCompleted",function(e){mapObj._mapUI.TriggerLoading(null,"场景文件解析完毕...",90,100)}),this.on("onAreasFirstLoadProcess",function(e,t,n){mapObj._mapUI.TriggerLoading(null,"正在加载场景节点...",90+t/n*5,100)}),this.on("onAllAreasFirstLoadCompleted",function(e,t){t?mapObj._mapUI.TriggerLoading(null,"加载时间过长，将直接进入界面...",100,100):mapObj._mapUI.TriggerLoading(null,"加载完成，将直接进入界面...",100,100),mapObj.off("onResourceLoaded"),mapObj.off("onResourceGroupFailed"),mapObj.off("onResourceGroupPackResLoaded"),mapObj.off("onResourceGroupPackResFailed"),mapObj.off("onResourceGroupAllCompleted"),mapObj.off("onAllSceneFilesFirstLoadCompleted"),mapObj.off("onAreasFirstLoadProcess"),mapObj.off("onAllAreasFirstLoadCompleted"),mapObj.off("onPreGroupPrepare"),mapObj._map3d.setHibernateTime(300),Q3D.Util.isFunction(mapObj.options.OnLoadEnd)&&mapObj.options.OnLoadEnd()}),this.on("onResourceLoaded",function(e,t,n,a){mapObj._mapUI.TriggerLoading(e,t.getName(),5+n/a*80,100)}),this.on("onResourceGroupFailed",function(e,t){mapObj._mapUI.TriggerLoadingFailed(e,t.getName())}),this.on("onResourceGroupPackResLoaded",function(e,t,n,a){mapObj._mapUI.TriggerLoading(e,t,5+n/a*80,100)}),this.on("onResourceGroupPackResFailed",function(e,t,n,a){mapObj._mapUI.TriggerLoadingFailed(e,t)}),this.on("onResourceGroupAllCompleted",function(e,t,n,a){mapObj._mapUI.TriggerLoading(e,"所有资源文件解析完毕...",85,100)}),mapObj._mapUI.TriggerLoading(null,"系统启动...",1,100));var n=this._map3d.loadSln();if(1!=n)return void this.showNotice("提示","引擎加载失败，请检查参数设置后关闭已经开启的引擎页面后重试");this.options.LOADING&&(mapObj._mapUI.TriggerLoading(null,"系统配置文件解析完毕...",5,100),this.options.WINDOWLESS&&(document.getElementById("progressbarWrapper").style.position="absolute",document.getElementById("progressbarWrapper").style.opacity=this.options.OPACITY)),this.attachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.Y,function(e,t){if(1==t){var n=this._map3d.getWorldManager();1==n.isFpsEnabled()?n.disableFps():n.enableFps()}}.bind(this)),this.attachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.F2,function(e,t){1==t&&this.showNotice("提示","当前控件版本号：V"+this._map3d.getVersion())}.bind(this)),this.attachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.F9,function(e,t){1==t&&(this._enableDebug=!this._enableDebug,console&&console.log("调试模式"+(this._enableDebug?"开启":"关闭")),this._enableDebug?this.attachMouseEvent("OnLButtonDown","_justfortest_",function(e){}):this.detachMouseEvent("OnLButtonDown","_justfortest_"))}.bind(this)),this.attachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.F8,function(e,t){if(this._enableDebug&&console){console.log("===================当前主摄像机信息开始===================");var n=new Date,a=this._map3d.getWorldManager(),o=a.getMainCamera(0),i=Q3D.vector3d(o.getAbsPos()),r=Q3D.globalVec3d(i.toGlobalVec3d()),s=o.getOrientation(2);console.log("操作时间 : "+n.getHours()+":"+n.getMinutes()+":"+n.getSeconds()),console.log("主摄像机当前位置(平面坐标) : "+i.x+","+i.y+","+i.z),console.log("主摄像机当前位置(经纬度坐标) : "+r.longitude.toFixed(6)+","+r.latitude.toFixed(6)+","+r.height.toFixed(6)),console.log("主摄像机当前角度 : "+s.x+","+s.y+","+s.z),console.log("主摄像机当前俯仰偏航角 : "+o.fetchRotPitch()+","+o.fetchRotYaw()),console.log("===================当前主摄像机信息结束===================")}}.bind(this));var a,o,i;"undefined"!=typeof document.hidden?(a="hidden",i="visibilitychange",o="visibilityState"):"undefined"!=typeof document.mozHidden?(a="mozHidden",i="mozvisibilitychange",o="mozVisibilityState"):"undefined"!=typeof document.msHidden?(a="msHidden",i="msvisibilitychange",o="msVisibilityState"):"undefined"!=typeof document.webkitHidden&&(a="webkitHidden",i="webkitvisibilitychange",o="webkitVisibilityState"),document.addEventListener(i,function(){"hidden"===document[o]?mapObj._map3d.enable(0):mapObj._map3d.enable(1)},!1)}catch(e){mapObj._mapUI.InitHelpDiaLog({MessageHTML:"引擎初始化失败，请关闭已经开启的引擎页面后重试。",NeedSetup:!0}),mapObj._mapUI.ShowHelpDialog()}finally{return}}.bind(this),500)},_initContainer:function(e){var t=this._container=Q3D.DomUtil.get(e);if(!t)throw new Error("Map container not found.");if(t._qmap3d_id)throw new Error("Map container is already initialized.");this._containerId=Q3D.Util.stamp(t);var n=e+"_qmap3d",a=null;a=Q3D.Browser.ie?this.AC_AX_RunContent("id",n,"classid","CLSID:DB7C6663-F12F-4BEC-960D-194E6EB3BDAA","width","100%","height","100%","WindowLess",this.options.WINDOWLESS?"1":"0"):this.AC_AX_RunContent("id",n,"clsid","{DB7C6663-F12F-4BEC-960D-194E6EB3BDAA}","type","application/QMap-activex","width","100%","height","100%","WindowLess",this.options.WINDOWLESS?"1":"0","event_OnLButtonDown","OnLButtonDown","event_OnLButtonUp","OnLButtonUp","event_OnRButtonDown","OnRButtonDown","event_OnRButtonUp","OnRButtonUp","event_OnLButtonDblClk","OnLButtonDblClk","event_OnMouseMove","OnMouseMove","event_OnMouseWheel","OnMouseWheel","event_OnRButtonDblClk","OnRButtonDblClk","event_OnMButtonDown","OnMButtonDown","event_OnMButtonUp","OnMButtonUp","event_OnKeyUp","OnKeyUp","event_OnKeyDown","OnKeyDown","event_onCreateArea","onCreateArea","event_onCreateSceneNode","onCreateSceneNode","event_onBuildSceneNode","onBuildSceneNode","event_onDestroySceneNode","onDestroySceneNode","event_onResourceAllCompleted","onResourceAllCompleted","event_onResourceAlreadyAllCompleted","onResourceAlreadyAllCompleted","event_onAnimationEnd","onAnimationEnd","event_onCameraCircleAniEnd","onCameraCircleAniEnd","event_onAnimationKeyFrame","onAnimationKeyFrame","event_onPreGroupPrepare","onPreGroupPrepare","event_onGroupFileComplete","onGroupFileComplete","event_onResourceLoaded","onResourceLoaded","event_onResourceGroupFailed","onResourceGroupFailed","event_onResourceGroupPackResLoaded","onResourceGroupPackResLoaded","event_onResourceGroupPackResFailed","onResourceGroupPackResFailed","event_onResourceGroupAllCompleted","onResourceGroupAllCompleted","event_onAreasFirstLoadProcess","onAreasFirstLoadProcess","event_onAllAreasFirstLoadCompleted","onAllAreasFirstLoadCompleted","event_onTimeTrigger","onTimeTrigger","event_onCameraFlyToEnd","onCameraFlyToEnd","event_onCameraUpdate","onCameraUpdate","event_onSceneNodeAllResourceCompleted","onSceneNodeAllResourceCompleted","event_onSceneNodeDestroyed","onSceneNodeDestroyed","event_OnDestroy","OnDestroy","event_onWidgetClose","onWidgetClose","event_onVideoCtrlClose","onVideoCtrlClose","event_onUserNotify","onUserNotify","event_onUserNotifyEX","onUserNotifyEX","event_onQUISystemInit","onQUISystemInit","event_onNotifyMouseButtonClick","onNotifyMouseButtonClick","event_onMovieClipInstancePassFrame","onMovieClipInstancePassFrame","event_onMovieClipInstanceRewind","onMovieClipInstanceRewind","event_onMovieClipInstanceStop","onMovieClipInstanceStop","event_onActCtrlObjAniEnd","onActCtrlObjAniEnd"),this._container&&a&&(this._container.innerHTML=a,this._map3d=Q3D.DomUtil.get(e+"_qmap3d"))},AC_AddExtension:function(e,t){return e.indexOf("?")!=-1?e.replace(/\?/,t+"?"):e+t},AC_Generateobj:function(e,t,n){var a="<object ";for(var o in e)a+=o+'="'+e[o]+'" ';a+=">";for(var o in t)a+='<param name="'+o+'" value="'+t[o]+'" /> ';a+="<embed ";for(var o in n)a+=o+'="'+n[o]+'" ';return a+=" ></embed></object>"},AC_GetArgs:function(e,t,n,a,o){var i=new Object;i.embedAttrs=new Object,i.params=new Object,i.objAttrs=new Object;for(var r=0;r<e.length;r+=2){var s=e[r].toLowerCase();switch(s){case"classid":break;case"pluginspage":i.embedAttrs[e[r]]=e[r+1];break;case"src":case"movie":e[r+1]=AC_AddExtension(e[r+1],t),i.embedAttrs.src=e[r+1],i.params[n]=e[r+1];break;case"onafterupdate":case"onbeforeupdate":case"onblur":case"oncellchange":case"onclick":case"ondblClick":case"ondrag":case"ondragend":case"ondragenter":case"ondragleave":case"ondragover":case"ondrop":case"onfinish":case"onfocus":case"onhelp":case"onmousedown":case"onmouseup":case"onmouseover":case"onmousemove":case"onmouseout":case"onkeypress":case"onkeydown":case"onkeyup":case"onload":case"onlosecapture":case"onpropertychange":case"onreadystatechange":case"onrowsdelete":case"onrowenter":case"onrowexit":case"onrowsinserted":case"onstart":case"onscroll":case"onbeforeeditfocus":case"onactivate":case"onbeforedeactivate":case"ondeactivate":case"type":case"codebase":i.objAttrs[e[r]]=e[r+1];break;case"width":case"height":case"align":case"vspace":case"hspace":case"class":case"title":case"accesskey":case"name":case"id":case"tabindex":i.embedAttrs[e[r]]=i.objAttrs[e[r]]=e[r+1];break;default:i.embedAttrs[e[r]]=i.params[e[r]]=e[r+1]}}return i.objAttrs.classid=a,o&&(i.embedAttrs.type=o),i},AC_AX_RunContent:function(){var e=this.AC_AX_GetArgs(arguments);return this.AC_Generateobj(e.objAttrs,e.params,e.embedAttrs)},AC_AX_GetArgs:function(e){var t=new Object;t.embedAttrs=new Object,t.params=new Object,t.objAttrs=new Object;for(var n=0;n<e.length;n+=2){var a=e[n].toLowerCase();switch(a){case"pluginspage":case"src":t.embedAttrs[e[n]]=e[n+1];break;case"data":case"codebase":case"classid":case"id":case"onafterupdate":case"onbeforeupdate":case"onblur":case"oncellchange":case"onclick":case"ondblClick":case"ondrag":case"ondragend":case"ondragenter":case"ondragleave":case"ondragover":case"ondrop":case"onfinish":case"onfocus":case"onhelp":case"onmousedown":case"onmouseup":case"onmouseover":case"onmousemove":case"onmouseout":case"onkeypress":case"onkeydown":case"onkeyup":case"onload":case"onlosecapture":case"onpropertychange":case"onreadystatechange":case"onrowsdelete":case"onrowenter":case"onrowexit":case"onrowsinserted":case"onstart":case"onscroll":case"onbeforeeditfocus":case"onactivate":case"onbeforedeactivate":case"ondeactivate":case"type":case"clsid":t.objAttrs[e[n]]=e[n+1];break;case"width":case"height":case"align":case"vspace":case"hspace":case"class":case"title":case"accesskey":case"name":case"tabindex":t.embedAttrs[e[n]]=t.objAttrs[e[n]]=e[n+1];break;default:t.embedAttrs[e[n]]=t.params[e[n]]=e[n+1]}}return t},getOcx:function(){return mapObj._map3d?mapObj._map3d:null},showNotice:function(e,t){var n=window.Notification||window.mozNotification||window.webkitNotification;return n?n.requestPermission(function(a){if("granted"==a){var o="_qmap3d_"+Math.random(),i=new n(e,{dir:"auto",lang:"zh-CN",tag:o,body:t});i.onclick=function(){window.focus()},i.onerror=function(){console.log("HTML5桌面消息出错！！！")},i.onshow=function(){setTimeout(function(){i.close()},2e3)},i.onclose=function(){console.log("HTML5桌面消息关闭！！！")}}}):(console.log("您的浏览器不支持桌面消息"),alert(t)),this},toggleFPS:function(){var e=mapObj._map3d.getWorldManager();return 1==e.isFpsEnabled()?e.disableFps():e.enableFps(),this},loadArea:function(e){return mapObj._map3d.getWorldManager().loadIndieArea(0,e),this},unloadArea:function(e){return mapObj._map3d.getWorldManager().unloadIndieArea(0,e),this},getArea:function(e){return mapObj._map3d.getWorldManager().getArea(e)},getSceneNode:function(e,t){var n=t===undefined?e:e+"/"+t;return mapObj._map3d.getWorldManager().getSceneNode(n)},getSceneNodeFullName:function(e){var t=e.getArea().getName(),n=e.getName();return t+"/"+n},getAllSceneNodeNames:function(e){for(var t=[],n=mapObj._map3d.getWorldManager().findSceneNodeList(e),a=n.firstNode();a;)t.push(a.getFullName()),a=n.nextNode();return n.release(),t},destroySceneNode:function(e,t,n){if("undefined"==typeof t){var a=e.split("/");t=a[a.length-1],e=a[0]}var o=this.getArea(e);return o?(n=n||!1,"destroySceneNodeDelay"in o&&n?o.destroySceneNodeDelay(t):o.destroySceneNode(t),this):null},createCommonNode:function(e,t){var n=e.split("/"),a=n.length;if(a<2||a>3)return null;var o=n[0],i=this.getArea(o);if(!i)return null;var r=null,s=null;if(2==a?s=n[1]:(r=n[1],s=n[2]),null!=this.getSceneNode(o,s)||3==a&&!this.getSceneNode(o,r))return null;var l=null;if(2==a)l=i.createTopNode(t,s);else{var c=this.getSceneNode(o,r);l=c.createChildNode(t,s,0)}return l},enableEditMode:function(e,t,n){var a={CustomEditAuxEnable:!1,CustomEditAux:{Translate:{AXIS_X:!0,AXIS_Y:!0,AXIS_Z:!0,PLANE_XOY:!0,PLANE_YOZ:!0,PLANE_ZOX:!0},Rotate:{AXIS_X:!0,AXIS_Y:!0,AXIS_Z:!0,PLANE_XOY:!0,PLANE_YOZ:!0,PLANE_ZOX:!0},Scale:{AXIS_X:!0,AXIS_Y:!0,AXIS_Z:!0,PLANE_XOY:!0,PLANE_YOZ:!0,PLANE_ZOX:!0}},OnSaved:null,OnCanceled:null,OnDeleted:null};Q3D.Util.jQueryExtend(!0,a,n);try{var o=this.getSceneNode(e);if(!o)return null;switch(this._editedNodeName||this.exitEditMode(Q3D.Enums.exitType.SaveAndExit),this._editedNodePath=e,this.attachMouseEvent("OnLButtonDown","_showNode",function(e){var t=this._map3d.getInputManager();null!=e.NearestNode&&e.NearestNode.getName().indexOf(this._editedNodePath.split("/")[1])>-1?(t.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.LBUTTON,this._editedMode),t.sendActionMsg(this._editedMode,Q3D.Enums.actionMsg.LIMIT_AUX,1,0)):t.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.LBUTTON,Q3D.Enums.actionType.TRANS_SCENE)}.bind(this)),t=t||Q3D.Enums.auxOperateType.Translate){case Q3D.Enums.auxOperateType.Translate:this._editedMode=Q3D.Enums.actionType.OBJECTSELECT_MOVAUX;break;case Q3D.Enums.auxOperateType.Rotate:this._editedMode=Q3D.Enums.actionType.OBJECTSELECT_ROTAUX;break;case Q3D.Enums.auxOperateType.Scale:this._editedMode=Q3D.Enums.actionType.OBJECTSELECT_SCAAUX}if(a.CustomEditAuxEnable){var i=null,r=null;switch(t){case 1:i=a.CustomEditAux.Translate;break;case 2:i=a.CustomEditAux.Rotate;break;case 3:i=a.CustomEditAux.Scale}if(null!=i){for(var s in i)i[s]&&(r+=Q3D.Enums.auxControlType[s]);o.showAuxEx(t,r,1)}}else o.showAux(t,1);var l=this._map3d.getInputManager();l.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.LBUTTON,Q3D.Enums.actionType.OBJECTSELECT_MOVAUX),l.sendActionMsg(this._editedMode,Q3D.Enums.actionMsg.LIMIT_AUX,1,0);var c={Translate:o.getPosition(),Rotate:o.getOrientation(0),Scale:o.getScale(0)};this.attachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.NUM_1,function(e,t){o.showAux(Q3D.Enums.auxOperateType.Translate,1),this._editedMode=Q3D.Enums.actionType.OBJECTSELECT_MOVAUX}.bind(this)),this.attachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.NUM_2,function(e,t){o.showAux(Q3D.Enums.auxOperateType.Rotate,1),this._editedMode=Q3D.Enums.actionType.OBJECTSELECT_ROTAUX}.bind(this)),this.attachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.NUM_3,function(e,t){o.showAux(Q3D.Enums.auxOperateType.Scale,1),this._editedMode=Q3D.Enums.actionType.OBJECTSELECT_SCAAUX}.bind(this)),this.attachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.ESCAPE,function(e,t){o.showAux(Q3D.Enums.auxOperateType.Hide,1),o.setPosition(c.Translate),o.setOrientation(c.Rotate,0),o.setScale(c.Scale),l.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.LBUTTON,Q3D.Enums.actionType.TRANS_SCENE),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.NUM_1),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.NUM_2),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.NUM_3),this.detachMouseEvent("OnLButtonDown","_showNode"),this._editedNodeName=null,Q3D.Util.isFunction(a.OnCanceled)&&a.OnCanceled(o),setTimeout(function(){this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.ESCAPE),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.DELETE),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.ENTER)}.bind(this),50)}.bind(this)),this.attachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.DELETE,function(e,t){o.showAux(Q3D.Enums.auxOperateType.Hide,1),this.destroySceneNode(o.getArea().getName(),o.getName()),l.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.LBUTTON,Q3D.Enums.actionType.TRANS_SCENE),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.NUM_1),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.NUM_2),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.NUM_3),this.detachMouseEvent("OnLButtonDown","_showNode"),this._editedNodeName=null,Q3D.Util.isFunction(a.OnDeleted)&&a.OnDeleted(o),setTimeout(function(){this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.ESCAPE),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.DELETE),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.ENTER)}.bind(this),50)}.bind(this)),this.attachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.ENTER,function(e,t){o.showAux(Q3D.Enums.auxOperateType.Hide,1),l.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.LBUTTON,Q3D.Enums.actionType.TRANS_SCENE),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.NUM_1),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.NUM_2),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.NUM_3),this.detachMouseEvent("OnLButtonDown","_showNode"),this._editedNodeName=null,Q3D.Util.isFunction(a.OnSaved)&&a.OnSaved(o),setTimeout(function(){this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.ESCAPE),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.DELETE),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.ENTER)}.bind(this),50)}.bind(this))}catch(e){return null}return this},exitEditMode:function(e){var t=this._editedNodePath;if(!t)return null;var n=this.getSceneNode(t);if(!n)return null;if(mapObj.getMouseEventStatus("OnLButtonDown","_showNode")){if(e==Q3D.Enums.exitType.SaveAndExit)n.showAux(Q3D.Enums.auxOperateType.Hide,1);else if(e==Q3D.Enums.exitType.DeleteAndExit){var a=t.split("/");this.destroySceneNode(a[0],a[1])}this._map3d.getInputManager().bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.LBUTTON,Q3D.Enums.actionType.TRANS_SCENE),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.NUM_1),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.NUM_2),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.NUM_3),this.detachMouseEvent("OnLButtonDown","_showNode"),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.ESCAPE),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.DELETE),this.detachKeyEvent("OnKeyUp",Q3D.Enums.keyboard.ENTER)}return this},getHtmlWidget:function(e){if(!e)return null;var t=mapObj._map3d.getExternUIWidgetSys();return t?"getHtmlWidget"in t?t.getHtmlWidget(e):t.createHtmlWidget(e,"",""):null},destroyMovieClipInstance:function(e){return mapObj._map3d.getWorldManager().destroyMovieClipInstance(e),this},destroyAllMovieClipInstances:function(){return mapObj._map3d.getWorldManager().destroyAllMovieClipInstances(),this},destroyMovieClip:function(e){return mapObj._map3d.getWorldManager().destroyMovieClip(e),this},destroyAllMovieClips:function(){return mapObj._map3d.getWorldManager().destroyAllMovieClips(),this},destroyContainer:function(e){return mapObj._map3d.getWorldManager().destroyContainer(e),this},destroyAllContainers:function(){return mapObj._map3d.getWorldManager().destroyAllContainer(),this},addPOIByJson:function(e){return mapObj._map3d.addPOIByJson(e),this},addContainerByJson:function(e,t){return mapObj._map3d.addContainerByJson(t),Q3D.nodeContainer(e)},saveImageAsBase64:function(e){var t=e?"jpg":"png",n="data:image/"+t+";base64,"+mapObj._map3d.saveImageEx(t);return n.replace(/\r\n/g,"")},saveImageAsFile:function(e){return mapObj._map3d.saveImage(e)},saveFrameAsBase64:function(e){var t=e?"jpg":"png",n="data:image/"+t+";base64,"+mapObj._map3d.saveCurrentFrameAsBase64(t);return n.replace(/\r\n/g,"")},saveFrameAsFile:function(e){return mapObj._map3d.saveCurrentFrameAsFile(e)},queryByRay:function(e,t){var n=t.clone().subtract(e),a=n.distanceTo(Q3D.vector3d(0,0,0));n.divide(Q3D.vector3d(a,a,a));var o=Q3D.vector3(n.x,n.y,n.z),i=Q3D.vector3d(0,0,0).get();if(i=mapObj._map3d.getWorldManager().pickNearestSceneNodeByRayEx(0,e.get(),o.get(),-1),!i)return 0;var r=Q3D.vector3d(i.x,i.y,i.z);if(0!=r.x||0!=r.y||0!=r.z){if(t.equals(r,.1)||e.equals(r,.1))return-1;var s=r.subtract(e).distanceTo(Q3D.vector3d(0,0,0));if(s<a)return 1}return!1},enableTooltip:function(e,t){var n=e||500;return t&&(mapObj._map3d.setTooltipListener(n),mapObj.on("onSceneNodeTooltip",t)),this},disableTooltip:function(){return mapObj._map3d.removeTooltipListener(),mapObj.off("onSceneNodeTooltip"),this}}),Q3D.map=function(e,t){return window.mapObj=new Q3D.Map(e,t),window.mapObj},Q3D.Vector2=function(e,t){if(!mapObj)throw new Error("无效的引擎对象，引擎对象未初始化！");if(isNaN(e)||isNaN(t))throw new Error("无效的QVector2对象: ("+e+", "+t+")");this.x=+e,this.y=+t},Q3D.Vector2.prototype={get:function(){return this.update(),this._qVector2},equals:function(e,t){if(!e)return!1;var n=Math.max(Math.abs(this.x-e.x),Math.abs(this.y-e.y));return n<=(t===undefined?1e-9:t)},toString:function(e){return"QVector2("+Q3D.Util.formatNum(this.x,e)+", "+Q3D.Util.formatNum(this.y,e)+")"},distanceTo:function(e){if(e){var t=e.x-this.x,n=e.y-this.y;return Math.sqrt(t*t+n*n)}return null},add:function(e){return e&&(this.x+=e.x,this.y+=e.y),this},subtract:function(e){return e&&(this.x-=e.x,this.y-=e.y),this},multiply:function(e){return e&&(this.x*=e.x,this.y*=e.y),this},divide:function(e){if(e){if(0==e.x||0==e.y)throw new Error("除数为0");this.x/=e.x,this.y/=e.y}return this},clone:function(){return new Q3D.Vector2(this.x,this.y)},update:function(){return null==this._qVector2&&(this._qVector2=mapObj._map3d.createObject("QMap3DCtl.QVector2")),this._qVector2.x=this.x,this._qVector2.y=this.y,this}},Q3D.vector2=function(e,t){return e instanceof Q3D.Vector2?e:Q3D.Util.isArray(e)&&"object"!=typeof e[0]?2===e.length?new Q3D.Vector2(e[0],e[1]):null:"object"==typeof e&&"x"in e&&"y"in e?new Q3D.Vector2(e.x,e.y):2==arguments.length&&"number"==typeof e&&"number"==typeof t?new Q3D.Vector2(e,t):new Q3D.Vector2(0,0)},String.prototype.toVector2=function(){try{return Q3D.vector2(parseFloat(this.split(",")[0]),parseFloat(this.split(",")[1]))}catch(e){return null}},Q3D.Vector2I=function(e,t){if(!mapObj)throw new Error("无效的引擎对象，引擎对象未初始化！");if(!Q3D.Util.isInteger(e)||!Q3D.Util.isInteger(t))throw new Error("无效的QVector2I对象: ("+e+", "+t+")");this.x=+e,this.y=+t},Q3D.Vector2I.prototype={get:function(){return this.update(),this._qVector2I},equals:function(e,t){if(!e)return!1;var n=Math.max(Math.abs(this.x-e.x),Math.abs(this.y-e.y));return n<=(t===undefined?1e-9:t)},toString:function(e){return"QVector2I("+Q3D.Util.formatNum(this.x,e)+", "+Q3D.Util.formatNum(this.y,e)+")"},distanceTo:function(e){if(e){var t=e.x-this.x,n=e.y-this.y;return Math.sqrt(t*t+n*n)}return null},add:function(e){return e&&(this.x+=e.x,this.y+=e.y),this},subtract:function(e){return e&&(this.x-=e.x,this.y-=e.y),this},multiply:function(e){return e&&(this.x*=e.x,this.y*=e.y),this},divide:function(e){if(e){if(0==e.x||0==e.y)throw new Error("除数为0");this.x/=e.x,this.y/=e.y}return this},clone:function(){return new Q3D.Vector2I(this.x,this.y)},update:function(){return null==this._qVector2I&&(this._qVector2I=mapObj._map3d.createObject("QMap3DCtl.QVector2I")),this._qVector2I.x=this.x,this._qVector2I.y=this.y,this}},Q3D.vector2I=function(e,t){return e instanceof Q3D.Vector2I?e:Q3D.Util.isArray(e)&&"object"!=typeof e[0]?2===e.length?new Q3D.Vector2I(e[0],e[1]):null:"object"==typeof e&&"x"in e&&"y"in e?new Q3D.Vector2I(e.x,e.y):2==arguments.length&&"number"==typeof e&&"number"==typeof t?new Q3D.Vector2I(e,t):new Q3D.Vector2I(0,0)},String.prototype.toVector2I=function(){try{return Q3D.vector2I(parseInt(this.split(",")[0]),parseInt(this.split(",")[1]))}catch(e){return null}},Q3D.Vector3=function(e,t,n){if(!mapObj)throw new Error("无效的引擎对象，引擎对象未初始化！");if(isNaN(e)||isNaN(t)||isNaN(n))throw new Error("无效的QVector3对象: ("+e+", "+t+", "+n+")");this.x=+e,this.y=+t,this.z=+n},Q3D.Vector3.prototype={get:function(){return this.update(),this._qVector3},equals:function(e,t){if(!e)return!1;var n=Math.max(Math.abs(this.x-e.x),Math.abs(this.y-e.y),Math.abs(this.z-e.z));return n<=(t===undefined?1e-9:t)},toString:function(e){return"QVector3("+Q3D.Util.formatNum(this.x,e)+", "+Q3D.Util.formatNum(this.y,e)+", "+Q3D.Util.formatNum(this.z,e)+")"},distanceTo:function(e){if(e){var t=e.x-this.x,n=e.y-this.y,a=e.z-this.z;return Math.sqrt(t*t+n*n+a*a)}return null},add:function(e){return e&&(this.x+=e.x,this.y+=e.y,this.z+=e.z),this},subtract:function(e){return e&&(this.x-=e.x,this.y-=e.y,this.z-=e.z),this},multiply:function(e){return e&&(this.x*=e.x,this.y*=e.y,this.z*=e.z),this},divide:function(e){if(e){if(0==e.x||0==e.y||0==e.z)throw new Error("除数为0");this.x/=e.x,this.y/=e.y,this.z/=e.z}return this},clone:function(){return new Q3D.Vector3(this.x,this.y,this.z)},toGlobalPos:function(e){var t=mapObj._map3d.getWorldManager().getArea(e);return t?t.toGlobalPos(this.get()):null},toGlobalVec3d:function(e){var t=mapObj._map3d.getWorldManager().getArea(e);if(t){var n=t.toGlobalPos(this.get()),a=mapObj._map3d.getMath();return a.vec3DToGlobalVec3D(n)}return null},update:function(){return null==this._qVector3&&(this._qVector3=mapObj._map3d.createObject("QMap3DCtl.QVector3")),this._qVector3.x=this.x,this._qVector3.y=this.y,this._qVector3.z=this.z,this}},Q3D.vector3=function(e,t,n){return e instanceof Q3D.Vector3?e:Q3D.Util.isArray(e)&&"object"!=typeof e[0]?3===e.length?new Q3D.Vector3(e[0],e[1],e[2]):null:"object"==typeof e&&"x"in e&&"y"in e&&"z"in e?new Q3D.Vector3(e.x,e.y,e.z):3==arguments.length&&"number"==typeof e&&"number"==typeof t&&"number"==typeof n?new Q3D.Vector3(e,t,n):new Q3D.Vector3(0,0,0)},String.prototype.toVector3=function(){try{return Q3D.vector3(parseFloat(this.split(",")[0]),parseFloat(this.split(",")[1]),parseFloat(this.split(",")[2]))}catch(e){return null}},Q3D.Vector3d=function(e,t,n){if(!mapObj)throw new Error("无效的引擎对象，引擎对象未初始化！");if(isNaN(e)||isNaN(t)||isNaN(n))throw new Error("无效的QVector3d对象: ("+e+", "+t+", "+n+")");this.x=+e,this.y=+t,this.z=+n},Q3D.Vector3d.prototype={get:function(){return this.update(),this._qVector3d},equals:function(e,t){if(!e)return!1;var n=Math.max(Math.abs(this.x-e.x),Math.abs(this.y-e.y),Math.abs(this.z-e.z));return n<=(t===undefined?1e-9:t)},toString:function(e){return"QVector3d("+Q3D.Util.formatNum(this.x,e)+", "+Q3D.Util.formatNum(this.y,e)+", "+Q3D.Util.formatNum(this.z,e)+")"},distanceTo:function(e){if(e){var t=e.x-this.x,n=e.y-this.y,a=e.z-this.z;return Math.sqrt(t*t+n*n+a*a)}return null},add:function(e){return e&&(this.x+=e.x,this.y+=e.y,this.z+=e.z),this},subtract:function(e){return e&&(this.x-=e.x,this.y-=e.y,this.z-=e.z),this},multiply:function(e){return e&&(this.x*=e.x,this.y*=e.y,this.z*=e.z),this},divide:function(e){if(e){if(0==e.x||0==e.y||0==e.z)throw new Error("除数为0");this.x/=e.x,this.y/=e.y,this.z/=e.z}return this},clone:function(){return new Q3D.Vector3d(this.x,this.y,this.z)},toLocalPos:function(e){var t=mapObj._map3d.getWorldManager().getArea(e);return t?t.toLocalPos(this.get()):null},toGlobalVec3d:function(){var e=mapObj._map3d.getMath();return e.vec3DToGlobalVec3D(this.get())},update:function(){return null==this._qVector3d&&(this._qVector3d=mapObj._map3d.createObject("QMap3DCtl.QVector3d")),this._qVector3d.x=this.x,this._qVector3d.y=this.y,this._qVector3d.z=this.z,this}},Q3D.vector3d=function(e,t,n){return e instanceof Q3D.Vector3d?e:Q3D.Util.isArray(e)&&"object"!=typeof e[0]?3===e.length?new Q3D.Vector3d(e[0],e[1],e[2]):null:"object"==typeof e&&"x"in e&&"y"in e&&"z"in e?new Q3D.Vector3d(e.x,e.y,e.z):3==arguments.length&&"number"==typeof e&&"number"==typeof t&&"number"==typeof n?new Q3D.Vector3d(e,t,n):new Q3D.Vector3d(0,0,0)},String.prototype.toVector3d=function(){try{return Q3D.vector3d(parseFloat(this.split(",")[0]),parseFloat(this.split(",")[1]),parseFloat(this.split(",")[2]))}catch(e){return null}},Q3D.GlobalVec3d=function(e,t,n){if(!mapObj)throw new Error("无效的引擎对象，引擎对象未初始化！");if(isNaN(e)||isNaN(t)||isNaN(n))throw new Error("无效的QGlobalVec3d对象: ("+e+", "+t+", "+n+")");this.longitude=+e,this.latitude=+t,this.height=+n},Q3D.GlobalVec3d.prototype={get:function(){return this.update(),this._qGlobalVec3d},equals:function(e,t){if(!e)return!1;var n=Math.max(Math.abs(this.longitude-e.longitude),Math.abs(this.latitude-e.latitude),Math.abs(this.height-e.height));return n<=(t===undefined?1e-9:t);
},toString:function(e){return"QGlobalVec3d("+Q3D.Util.formatNum(this.longitude,e)+", "+Q3D.Util.formatNum(this.latitude,e)+", "+Q3D.Util.formatNum(this.height,e)+")"},toGlobalPos:function(){var e=mapObj._map3d.getMath();return e.globalVec3DtoVec3D(this.get())},toLocalPos:function(e){var t=mapObj._map3d.getMath(),n=t.globalVec3DtoVec3D(this.get()),a=mapObj._map3d.getWorldManager().getArea(e);return a?a.toLocalPos(n):null},clone:function(){return new Q3D.GlobalVec3d(this.longitude,this.latitude,this.height)},update:function(){return null==this._qGlobalVec3d&&(this._qGlobalVec3d=mapObj._map3d.createObject("QMap3DCtl.QGlobalVec3d")),this._qGlobalVec3d.longitude=this.longitude,this._qGlobalVec3d.latitude=this.latitude,this._qGlobalVec3d.height=this.height,this}},Q3D.globalVec3d=function(e,t,n){return e instanceof Q3D.GlobalVec3d?e:Q3D.Util.isArray(e)&&"object"!=typeof e[0]?3===e.length?new Q3D.GlobalVec3d(e[0],e[1],e[2]):null:"object"==typeof e&&"longitude"in e&&"latitude"in e&&"height"in e?new Q3D.GlobalVec3d(e.longitude,e.latitude,e.height):3==arguments.length&&"number"==typeof e&&"number"==typeof t&&"number"==typeof n?new Q3D.GlobalVec3d(e,t,n):new Q3D.GlobalVec3d(0,0,0)},String.prototype.toGlobalVec3d=function(){try{return Q3D.globalVec3d(parseFloat(this.split(",")[0]),parseFloat(this.split(",")[1]),parseFloat(this.split(",")[2]))}catch(e){return null}},Q3D.ColourValue=function(e,t,n,a){if(!mapObj)throw new Error("无效的引擎对象，引擎对象未初始化！");if(isNaN(e)||isNaN(t)||isNaN(n)||isNaN(a))throw new Error("无效的QColourValue对象: ("+e+", "+t+", "+n+", "+a+")");this.r=+e,this.g=+t,this.b=+n,this.a=+a},Q3D.ColourValue.prototype={_toHex:function(e){return e<16?"0"+e.toString(16).toUpperCase():e.toString(16).toUpperCase()},get:function(){return this.update(),this._qColurValue},toString:function(e){return"QColourValue("+Q3D.Util.formatNum(this.r,e)+", "+Q3D.Util.formatNum(this.g,e)+", "+Q3D.Util.formatNum(this.b,e)+", "+Q3D.Util.formatNum(this.a,e)+")"},toWebColor:function(){return"#"+this._toHex(parseInt(255*this.r))+this._toHex(parseInt(255*this.g))+this._toHex(parseInt(255*this.b))},clone:function(){return new Q3D.ColourValue(this.r,this.g,this.b,this.a)},revise:function(){return this.r=Math.pow(this.r,1/2.2),this.g=Math.pow(this.g,1/2.2),this.b=Math.pow(this.b,1/2.2),this},update:function(){return null==this._qColurValue&&(this._qColurValue=mapObj._map3d.createObject("QMap3DCtl.QColourValue")),this._qColurValue.r=this.r,this._qColurValue.g=this.g,this._qColurValue.b=this.b,this._qColurValue.a=this.a,this}},Q3D.colourValue=function(e,t,n,a){if(e instanceof Q3D.ColourValue)return e;if(Q3D.Util.isArray(e)&&"object"!=typeof e[0])return 4===e.length?new Q3D.ColourValue(e[0],e[1],e[2],e[3]):null;if("object"==typeof e&&"r"in e&&"g"in e&&"b"in e&&"a"in e)return new Q3D.ColourValue(e.r,e.g,e.b,e.a);if(2==arguments.length&&"string"==typeof arguments[0]&&!isNaN(arguments[1])){var o=e.indexOf("#")!=-1?e.replace(/#/g,""):e,i=parseInt(o.substr(0,2),16)/255,r=parseInt(o.substr(2,2),16)/255,s=parseInt(o.substr(4,2),16)/255;return new Q3D.ColourValue(i,r,s,t)}return 4==arguments.length&&"number"==typeof e&&"number"==typeof t&&"number"==typeof n&&"number"==typeof a?new Q3D.ColourValue(e,t,n,a):new Q3D.ColourValue(0,0,0,1)},String.prototype.toColourValue=function(){try{return Q3D.colourValue(this.toString(),1)}catch(e){return null}},Q3D.ArcVertex=function(e,t,n,a,o){if(!mapObj)throw new Error("无效的引擎对象，引擎对象未初始化！");if(isNaN(e)||isNaN(t)||isNaN(n)||isNaN(a)||isNaN(o))throw new Error("无效的QArcVertex对象: ("+e+", "+t+", "+n+", "+a+", "+o+")");if(+a<1||+o<0)throw new Error("无效的QArcVertex对象: ("+e+", "+t+", "+n+", "+a+", "+o+")");this.x=e,this.y=t,this.z=n,this.r=a,this.d=o},Q3D.ArcVertex.prototype={get:function(){return this.update(),this._qArcVertex},getRadius:function(){return this.r},getdAngle:function(){return this.d},getPos:function(){return Q3D.vector3(this.x,this.y,this.z).get()},equals:function(e,t){if(!e)return!1;var n=Math.max(Math.abs(this.x-e.x),Math.abs(this.y-e.y),Math.abs(this.z-e.z),Math.abs(this.r-e.r),Math.abs(this.d-e.d));return n<=(t===undefined?1e-9:t)},toString:function(e){return"QArcVertex("+Q3D.Util.formatNum(this.x,e)+", "+Q3D.Util.formatNum(this.y,e)+", "+Q3D.Util.formatNum(this.z,e)+", "+Q3D.Util.formatNum(this.r,e)+", "+Q3D.Util.formatNum(this.d,e)+")"},add:function(e){return e&&(this.x+=e.x,this.y+=e.y,this.z+=e.z),this},subtract:function(e){return e&&(this.x-=e.x,this.y-=e.y,this.z-=e.z),this},multiply:function(e){return e&&(this.x*=e.x,this.y*=e.y,this.z*=e.z),this},divide:function(e){if(e){if(0==e.x||0==e.y||0==e.z)throw new Error("除数为0");this.x/=e.x,this.y/=e.y,this.z/=e.z}return this},clone:function(){return new Q3D.arcVertex(this.x,this.y,this.z,this.r,this.d)},update:function(){return null==this._qArcVertex&&(this._qArcVertex=mapObj._map3d.createObject("QMap3DCtl.QArcVertex")),this._qArcVertex.setPos(Q3D.vector3(this.x,this.y,this.z).get()),this._qArcVertex.setRadius(this.r),this._qArcVertex.setdAngle(this.d),this}},Q3D.arcVertex=function(e,t,n,a,o){return e instanceof Q3D.ArcVertex?e:Q3D.Util.isArray(e)&&"object"!=typeof e[0]?5===e.length?new Q3D.ArcVertex(e[0],e[1],e[2],e[3],e[4]):null:"object"==typeof e&&"x"in e&&"y"in e&&"z"in e&&"r"in e&&"d"in e?new Q3D.ArcVertex(e.x,e.y,e.z,e.r,e.d):arguments.length<5?null:new Q3D.ArcVertex(e,t,n,a,o)},String.prototype.toArcVertex=function(){try{return Q3D.arcVertex(parseFloat(this.split(",")[0]),parseFloat(this.split(",")[1]),parseFloat(this.split(",")[2]),parseFloat(this.split(",")[3]),parseFloat(this.split(",")[4]))}catch(e){return null}},Q3D.GlobalCamera=function(){if(!mapObj)throw new Error("无效的引擎对象，引擎对象未初始化！");this._gc=mapObj._map3d.getWorldManager().getMainCamera(0)},Q3D.GlobalCamera.prototype={_addBox:function(e,t,n,a){null!=mapObj.getSceneNode(e,t)&&mapObj.destroySceneNode(e,t);var o=[];return o.push(Q3D.vector3(n.x,n.y,n.z)),o.push(Q3D.vector3(a.x,n.y,n.z)),o.push(Q3D.vector3(a.x,n.y,a.z)),o.push(Q3D.vector3(n.x,n.y,a.z)),mapObj.createPrism(e+"/"+t,{Points:o,WallAlpha:0,CeilAlpha:0,Height:a.y-n.y})},get:function(){return this._gc},getAbsPos:function(){return this._gc.getAbsPos()},getOrientation:function(){return this._gc.getOrientation(Q3D.Enums.orientationType.World)},setFOVy:function(e){return this._gc.setFOVy(e),this},setClipDistance:function(e,t){return this._gc.setNearClipDistance(e),this._gc.setFarClipDistance(t),this},getCameraInfo:function(){var e=parseInt(this._gc.getFOVy()),t=this._gc.getNearClipDistance(),n=this._gc.getFarClipDistance();return[e,t,n]},flyTo:function(e,t,n,a){return mapObj.off("onCameraFlyToEnd"),a&&Q3D.Util.isFunction(a)&&(mapObj._map3d.setFlyToListener(this._gc),mapObj.on("onCameraFlyToEnd",a)),t=t||Q3D.vector3(this.getOrientation()),n=Q3D.Util.isNumber(n)?n:0,this._gc.flyTo(e.get(),t.get(),n),this},flyToByDistance:function(e,t,n,a,o){n=n||Q3D.vector3(this.getOrientation()),t=Q3D.Util.isNumber(t)?t:20;var i=mapObj._map3d.getMath().eulerToDirection(n.get()),r=Q3D.vector3d(i.x*t+e.x,i.y*t+e.y,i.z*t+e.z);this.flyTo(r,n,a,o)},flyToByClick:function(e,t,n,a){var o=document.getElementById(e).clientWidth,i=document.getElementById(e).clientHeight,r=Q3D.vector2I(o/2,i/2),s=Q3D.vector3d(this._gc.getCrossCoord(r.get(),-1)),l=Q3D.vector3(this.getOrientation()),c=Q3D.vector3d(this.getAbsPos()),u=c.clone().subtract(s),d=t.clone().add(u);this.flyTo(d,l,n,a)},flyToPos:function(e,t,n,a,o,i,r){mapObj.off("onCameraFlyToEnd"),r&&Q3D.Util.isFunction(r)&&(mapObj._map3d.setFlyToListener(this._gc),mapObj.on("onCameraFlyToEnd",r)),n=Q3D.Util.isNumber(n)?n:50,a=Q3D.Util.isNumber(a)?a:-45,o=Q3D.Util.isNumber(o)?o:0,i=Q3D.Util.isNumber(i)?i:0;var s=Q3D.globalVec3d(e,t,n).toGlobalPos(),l=this._gc.makeRotByYawPitch(a,o);return this._gc.flyTo(s,l,i),this},flyToNode:function(e,t,n,a){return mapObj.off("onCameraFlyToEnd"),a&&Q3D.Util.isFunction(a)&&(mapObj._map3d.setFlyToListener(this._gc),mapObj.on("onCameraFlyToEnd",a)),t=t||Q3D.vector3(this.getOrientation()),n=Q3D.Util.isNumber(n)?n:0,this._gc.flyToNode(e,t.get(),n),this},flyToAxisView:function(e,t,n,a){mapObj.off("onCameraFlyToEnd"),a&&Q3D.Util.isFunction(a)&&(mapObj._map3d.setFlyToListener(this._gc),mapObj.on("onCameraFlyToEnd",a)),t=Q3D.Util.isNumber(t)?t:10,n=Q3D.Util.isNumber(n)?n:0;var o=Q3D.vector3d(e.getAbsPos()),i=o.clone().add(Q3D.vector3d(t,t,t));return this._gc.flyToViaLookAt(i.get(),o.get(),Q3D.vector3(0,1,0).get(),n),this},flyToCamView:function(e,t,n,a,o,i){mapObj.off("onCameraFlyToEnd"),i&&Q3D.Util.isFunction(i)&&(mapObj._map3d.setFlyToListener(this._gc),mapObj.on("onCameraFlyToEnd",i)),a=a||Q3D.Enums.camViewType.Front,o=Q3D.Util.isNumber(o)?o:0,this._addBox(e,"#Box",t,n);var r=mapObj._map3d.getWorldManager(),s=r.getArea(e),l=r.createEmptySceneNodeList();l.addNode(mapObj.getSceneNode(e,"#Box"));var c=null,u=null;switch(a){case Q3D.Enums.camViewType.Front:u=Q3D.vector3(0,0,0).get(),c=this._gc.calcFullVisiblePos(l,u,0),this._gc.flyTo(c,u,o);break;case Q3D.Enums.camViewType.Top:u=Q3D.vector3(-90,0,0).get(),c=this._gc.calcFullVisiblePos(l,u,0),this._gc.flyTo(c,u,o);break;case Q3D.Enums.camViewType.Side:u=Q3D.vector3(0,90,0).get(),c=this._gc.calcFullVisiblePos(l,u,0),this._gc.flyTo(c,u,o);break;case Q3D.Enums.camViewType.Axis:var d=s.toGlobalPos(t.get()),p=Q3D.vector3d(d);d=s.toGlobalPos(n.get());var m=Q3D.vector3d(d),h=m.subtract(p),y=Q3D.vector3d(h.x,h.y,h.z).multiply(Q3D.vector3d(1.2,1.2,1.2)),g=p.clone().add(y);this._gc.flyToViaLookAt(g.get(),p.get(),Q3D.vector3(0,1,0).get(),o)}return l.release(),mapObj.destroySceneNode(e,"#Box"),this},flyToCamViewEx:function(e,t,n,a,o){mapObj.off("onCameraFlyToEnd"),o&&Q3D.Util.isFunction(o)&&(mapObj._map3d.setFlyToListener(this._gc),mapObj.on("onCameraFlyToEnd",o)),t=t||Q3D.Enums.camViewType.Front,n=Q3D.Util.isNumber(n)?n:10,a=Q3D.Util.isNumber(a)?a:0;var i=e.clone(),r=null;switch(t){case Q3D.Enums.camViewType.Front:r=i.clone().add(Q3D.vector3d(0,0,n)),this._gc.flyToViaLookAt(r.get(),i.get(),Q3D.vector3(0,1,0).get(),a);break;case Q3D.Enums.camViewType.Top:r=i.clone().add(Q3D.vector3d(0,n,0)),this._gc.flyToViaLookAt(r.get(),i.get(),Q3D.vector3(0,0,1).get(),a);break;case Q3D.Enums.camViewType.Side:r=i.clone().add(Q3D.vector3d(n,0,0)),this._gc.flyToViaLookAt(r.get(),i.get(),Q3D.vector3(0,1,0).get(),a);break;case Q3D.Enums.camViewType.Axis:r=i.clone().add(Q3D.vector3d(n/Math.sqrt(2),n/Math.sqrt(2),n/Math.sqrt(2))),this._gc.flyToViaLookAt(r.get(),i.get(),Q3D.vector3(0,1,0).get(),a)}return this},flyToBy3Steps:function(e,t,n,a,o){var i=Q3D.vector3d(this.getAbsPos());mapObj._flyToByStepData=mapObj._flyToByStepData||{};var a=Q3D.Util.isNumber(a)?a:1e3;if(Q3D.Util.isArray(n)){if(3!==n.length)return void console.log("飞行时间参数个数不正确");mapObj._flyToByStepData._times=n}else{var r=Math.abs(i.y-a),s=Math.sqrt((e.x-i.x)*(e.x-i.x)+(e.z-i.z)*(e.z-i.z)),l=Math.abs(e.y-a),c=r+s+l;if(c<1e-9||n<.001)return this.flyTo(e,t,n,o),this;mapObj._flyToByStepData._times=[Math.max(r/c*n,.5),Math.max(s/c*n,.5),Math.max(l/c*n,.5)]}mapObj._flyToByStepData._targetPosV3d=e,mapObj._flyToByStepData._targetOri=t,mapObj._flyToByStepData._fn=o,i.y=a;var u=this.get().fetchRotYaw(),d=Q3D.vector3(this.get().makeRotByYawPitch(-30,u));return this.flyTo(i,d,mapObj._flyToByStepData._times[0],function(){setTimeout(function(){var e=Q3D.globalCamera(),t=e.getAbsPos(),n=mapObj._flyToByStepData._targetPosV3d,a=Q3D.vector3d(n.x,t.y,n.z);e.flyTo(a,Q3D.vector3(e.getOrientation()),mapObj._flyToByStepData._times[1],function(){setTimeout(function(){var e=Q3D.globalCamera(),t=mapObj._flyToByStepData._targetPosV3d,n=mapObj._flyToByStepData._targetOri;e.flyTo(t,n,mapObj._flyToByStepData._times[2],function(){var e=mapObj._flyToByStepData._fn;e&&Q3D.Util.isFunction(e)&&e(),mapObj.off("onCameraFlyToEnd"),delete mapObj._flyToByStepData})},100)})},100)}),this},flyToBy4Steps:function(e,t,n,a,o){var i=Q3D.vector3d(this.getAbsPos());mapObj._flyToByStepData=mapObj._flyToByStepData||{};var a=Q3D.Util.isNumber(a)?a:1e3;if(Q3D.Util.isArray(n)){if(4!==n.length)return void console.log("飞行时间参数个数不正确");mapObj._flyToByStepData._times=n}else{var r=Math.abs(i.y-a),s=Math.sqrt((e.x-i.x)*(e.x-i.x)+(e.z-i.z)*(e.z-i.z)),l=Math.abs(e.y-a),c=Math.min(r,s,l),u=r+s+l+c;if(u<1e-9||n<.001)return this.flyTo(e,t,n,o),this;mapObj._flyToByStepData._times=[Math.max(r/u*n,.5),Math.max(s/u*n,.5),Math.max(l/u*n,.5),Math.max(c/u*n,.5)]}mapObj._flyToByStepData._targetPosV3d=e,mapObj._flyToByStepData._targetOri=t,mapObj._flyToByStepData._fn=o,i.y=a;var d=this.get().fetchRotYaw(),p=Q3D.vector3(this.get().makeRotByYawPitch(-30,d));return this.flyTo(i,p,mapObj._flyToByStepData._times[0],function(){setTimeout(function(){var e=Q3D.globalCamera(),t=e.getAbsPos(),n=mapObj._flyToByStepData._targetPosV3d,a=Q3D.vector3d(n.x,t.y,n.z);e.flyTo(a,Q3D.vector3(e.getOrientation()),mapObj._flyToByStepData._times[1],function(){setTimeout(function(){var e=Q3D.globalCamera(),t=mapObj._flyToByStepData._targetPosV3d;e.flyTo(t,Q3D.vector3(e.getOrientation()),mapObj._flyToByStepData._times[2],function(){setTimeout(function(){var e=Q3D.globalCamera(),t=mapObj._flyToByStepData._targetPosV3d,n=mapObj._flyToByStepData._targetOri;e.flyTo(t,n,mapObj._flyToByStepData._times[3],function(){var e=mapObj._flyToByStepData._fn;e&&Q3D.Util.isFunction(e)&&e(),mapObj.off("onCameraFlyToEnd"),delete mapObj._flyToByStepData})},100)})},100)})},100)}),this},flyToMakeSureVisible:function(e,t,n,a,o){for(var i=mapObj._map3d.getWorldManager().createEmptySceneNodeList(),r=0;r<e.length;++r)i.addNode(mapObj.getSceneNode(e[r]));var s=this._gc;n=Q3D.Util.isNumber(n)?n:0;var l=t?t:Q3D.vector3(-90,0,0),c=s.calcFullVisiblePos(i,l.get(),n);return this.flyTo(Q3D.vector3d(c),l,a,o),i.release(),this},startCircleFly:function(e,t,n,a,o,i){return mapObj.off("onCameraCircleAniEnd"),i&&Q3D.Util.isFunction(i)&&(mapObj._map3d.setFlyToListener(this._gc),mapObj.on("onCameraCircleAniEnd",i)),n=Q3D.Util.isNumber(n)?n:1,a=Q3D.Util.isNumber(a)?a:1,o=o?1:0,this._gc.playCircleAni(e.get(),t.get(),n*Math.abs(a),a,o),this},stopCircleFly:function(){return this._gc.stopCircleAni(),this},startCircleFlyEx:function(e,t,n,a,o){n=Q3D.Util.isNumber(n)?n:1,a=Q3D.Util.isNumber(a)?a:1,o=o?1:0;var i="circlefly_"+this._gc.getFullName()+"_movieclip",r="circlefly_"+this._gc.getFullName()+"_movieclip_inst",s=Q3D.movieClip(i,50),l=Q3D.movieClipInstance(r,s),c=s.get(),u=c.addIActor("circlefly"),d=u.addITrack(Q3D.Enums.actorTrackType.TransformMoveAbs,Q3D.Enums.actorKeyType.VecCircle).asVecCircleTrack();return d.setCircleCenter(t.get()),d.setStartPos(e.get()),d.lockOrientation(1),d.setBeginFrame(0),d.setFrames(n*Math.abs(a)*50),d.setRounds(a),l.get().setPlayer("circlefly",Q3D.Enums.playerType.Node,this._gc.getFullName()),l.get().setLoop(o),l},stopCircleFlyEx:function(){var e=mapObj._map3d.getWorldManager(),t=e.getMovieClipInstance("circlefly_"+this._gc.getFullName()+"_movieclip_inst");if(t){t.stop(),t.gotoFrame(0);var n=t.getMovieClipCName();e.destroyMovieClipInstance(t.getCName()),e.destroyMovieClip(n)}return this},onCameraUpdate:function(e,t,n){if(t&&!Q3D.Util.isFunction(t))throw new Error("无效的回调函数");return e?(mapObj._map3d.setCameraListener(this._gc),mapObj._lastCameraUpdateTime||(mapObj._lastCameraUpdateTime=0,mapObj._cbFn=t,mapObj._interval=n),mapObj.on("onCameraUpdate",function(){var e=(new Date).getTime();e-mapObj._lastCameraUpdateTime<=mapObj._interval||(mapObj._lastCameraUpdateTime=e,Q3D.Util.isDefined(mapObj._cbFn)&&mapObj._cbFn())})):(mapObj._map3d.removeCameraListener(this._gc),mapObj.off("onCameraUpdate",t),delete mapObj._lastCameraUpdateTime,delete mapObj._cbFn,delete mapObj._interval),this},calRelativePos:function(e){var t=mapObj.getSceneNode(e).toLocalPos(this.getAbsPos());return console.log("当前主摄像机相对于目标节点的位置: "+t.x+","+t.y+","+t.z),t}},Q3D.globalCamera=function(){return new Q3D.GlobalCamera},Q3D.InputManager=function(){if(!mapObj)throw new Error("无效的引擎对象，引擎对象未初始化！");this._im=mapObj._map3d.getInputManager()},Q3D.InputManager.prototype={get:function(){return this._im},setLocator:function(e){return e?this._im.showLocator():this._im.hideLocator(),this},setInertia:function(e,t){return e?(this._im.enableInertia(),this._im.setInertiaDuration(isNaN(t)?1:t)):this._im.disableInertia(),this},setPitch:function(e,t){if(e){var n=Q3D.globalCamera().get().fetchRotPitch();if(this._im.enablePitch(),Q3D.Util.isArray(t)&&2===t.length){t.sort(function(e,t){return e>t?1:-1}),t[0]=Math.max(t[0],-90),t[1]=Math.min(t[1],90);var a=n;parseInt(t[0])==parseInt(t[1])?a=t[0]:n<t[0]?a=t[0]:n>t[1]&&(a=t[1]);var o=Q3D.globalCamera().get().fetchRotYaw(),i=Q3D.globalCamera().get().makeRotByYawPitch(a,o),r=Q3D.globalCamera().getAbsPos();Q3D.globalCamera().get().flyTo(r,i,.5),this._im.setPitchRange(t[0],t[1])}else this._im.setPitchRange(-90,90)}else this._im.disablePitch();return this},setDefaultPlaneHeight:function(e){return this._im.setActionBaseplaneHeight(isNaN(e)?0:e),this},setDynamicSpeed:function(e,t){return this._im.sendActionMsg(Q3D.Enums.actionType.SCALED_SCREEN,Q3D.Enums.actionMsg.SET_SCALE_DYNAMICSPEED,0,isNaN(e)?.2:e),this._im.sendActionMsg(Q3D.Enums.actionType.RAMBLE_KEEPORI,Q3D.Enums.actionMsg.SET_RAMBLE_TRANSLATESPEED,0,isNaN(t)?1:t),this},setKeyboardMoveSpeed:function(e){return this._im.setSpeed(e),this},setCommonSpeed:function(e,t,n){return this._im.sendActionMsg(e,t,0,isNaN(n)?.1:n),this},setLimitBox:function(e,t){var n=mapObj._map3d.getInputActionRestrictionManager();return e?n.setCurRestriction(t):n.setCurRestriction(-1),n=null,this},setFixedPointRotate:function(e,t){return e?(this._im.sendActionMsg(Q3D.Enums.actionType.ROTATET_FIXPNT,Q3D.Enums.actionMsg.SET_FIXPNT,0,t.get()),this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.RBUTTON,Q3D.Enums.actionType.ROTATET_FIXPNT)):this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.RBUTTON,Q3D.Enums.actionType.ROTATET_SCREEN),this},setFirstPersonRotate:function(e){return e?this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.RBUTTON,Q3D.Enums.actionType.ROTATET_CAMERA):this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.RBUTTON,Q3D.Enums.actionType.ROTATET_SCREEN),this},setThirdPersonOperation:function(e,t,n){if(e){if(t===undefined)return mapObj.showNotice("提示","输入参数无效!"),this;n=n||"",this._im.setInputType(1,t,n),this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.LBUTTON,Q3D.Enums.actionType.THIRD_CAMERAROTATE),this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.MBUTTON,Q3D.Enums.actionType.THIRD_MOVETO),this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.RBUTTON,Q3D.Enums.actionType.THIRD_ROTATE),this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.WHEEL,Q3D.Enums.actionType.THIRD_WHEEL),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.A.ctrlId,Q3D.Enums.actionType.THIRD_MOVELEFT),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.D.ctrlId,Q3D.Enums.actionType.THIRD_MOVERIGHT),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.W.ctrlId,Q3D.Enums.actionType.THIRD_MOVEFORTH),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.S.ctrlId,Q3D.Enums.actionType.THIRD_MOVEBACK),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.Q.ctrlId,Q3D.Enums.actionType.THIRD_MOVEDOWN),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.E.ctrlId,Q3D.Enums.actionType.THIRD_MOVEUP),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.LEFT.ctrlId,Q3D.Enums.actionType.THIRD_TURNLEFT),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.RIGHT.ctrlId,Q3D.Enums.actionType.THIRD_TURNRIGHT),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.DOWN.ctrlId,Q3D.Enums.actionType.THIRD_LOOKDOWN),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.UP.ctrlId,Q3D.Enums.actionType.THIRD_LOOKUP)}else this._im.setInputType(0,"",""),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.A.ctrlId,Q3D.Enums.actionType.TRANS_LEFTX),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.D.ctrlId,Q3D.Enums.actionType.TRANS_RIGHT),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.W.ctrlId,Q3D.Enums.actionType.TRANS_FORTH),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.S.ctrlId,Q3D.Enums.actionType.TRANS_BACKX),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.Q.ctrlId,Q3D.Enums.actionType.TRANS_DOWNX),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.E.ctrlId,Q3D.Enums.actionType.TRANS_UPXXX),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.LEFT.ctrlId,Q3D.Enums.actionType.TRANS_LEFTX),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.RIGHT.ctrlId,Q3D.Enums.actionType.TRANS_RIGHT),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.UP.ctrlId,Q3D.Enums.actionType.TRANS_FORTH),this._im.bindControlAction(Q3D.Enums.device.KEYBOARD,Q3D.Enums.keyboard.DOWN.ctrlId,Q3D.Enums.actionType.TRANS_BACKX),this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.LBUTTON,Q3D.Enums.actionType.TRANS_SCENE),this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.MBUTTON,Q3D.Enums.actionType.RAMBLE_KEEPORI),this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.RBUTTON,Q3D.Enums.actionType.ROTATET_SCREEN),this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.WHEEL,Q3D.Enums.actionType.SCALED_SCREEN);return this},setThirdPersonBind:function(e,t){var n=mapObj.getSceneNode(t);return n?(e?(this._im.bindNode(n),this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.LBUTTON,Q3D.Enums.actionType.THIRD_CAMERAROTATE),this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.RBUTTON,Q3D.Enums.actionType.THIRD_ROTATE),this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.WHEEL,Q3D.Enums.actionType.THIRD_WHEEL)):(this._im.unbindNode(),this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.LBUTTON,Q3D.Enums.actionType.TRANS_SCENE),this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.RBUTTON,Q3D.Enums.actionType.ROTATET_SCREEN),this._im.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.WHEEL,Q3D.Enums.actionType.SCALED_SCREEN)),this):this},enableAllActions:function(e,t){t=t||[];for(var n=[Q3D.Enums.actionType.TRANS_LEFTX,Q3D.Enums.actionType.TRANS_RIGHT,Q3D.Enums.actionType.TRANS_FORTH,Q3D.Enums.actionType.TRANS_BACKX,Q3D.Enums.actionType.TRANS_DOWNX,Q3D.Enums.actionType.TRANS_UPXXX,Q3D.Enums.actionType.CAMERA_CLOSETO,Q3D.Enums.actionType.TRANS_SCENE,Q3D.Enums.actionType.RAMBLE_KEEPORI,Q3D.Enums.actionType.ROTATES_SCREEN,Q3D.Enums.actionType.SCALED_SCREEN,Q3D.Enums.actionType.YPSS_SCREEN],a=function(e,t){for(var n=e.concat(),a=0;a<t.length;a++)n.indexOf(t[a])===-1?n.push(t[a]):0;return n},o=a(n,t),i=0,r=o.length;i<r;++i)this._im.enableAction(o[i],e);return this}},Q3D.inputManager=function(){return new Q3D.InputManager},Q3D.LayerGroup=function(){if(!mapObj)throw new Error("无效的引擎对象，引擎对象未初始化！")},Q3D.LayerGroup.prototype={getLayer:function(e){return mapObj._map3d.getWorldManager().getLayer(e)},setLayerAttributes:function(e,t){var n={ShowOrder:0,IsHeightHideCtrl:!1,MinHeight:-5e3,MaxHeight:5e3,IsForbidSelect:!1,IsForbidOperation:!1};Q3D.extend(n,t);var a=this.getLayer(e);return!!a&&(a.setOrder(n.ShowOrder),n.IsHeightHideCtrl?(a.enableHideHeight(1),a.setHideHeight(n.MinHeight,n.MaxHeight)):a.enableHideHeight(0),a.setForbidSelect(n.IsForbidSelect?1:0),a.setForbidOperation(n.IsForbidOperation?1:0),!0)},getAllLayerNames:function(){var e=[],t=mapObj._map3d.getWorldManager().getAllLayers(),n=t.firstLayer();if(n)for(e.push(n.getLayerName());;){if(n=t.nextLayer(),!n)break;e.push(n.getLayerName())}return t.release(),e},getLayerAllNodeNames:function(e){var t=[],n=this.getLayer(e);if(!n)return t;var a=n.getLayerAllNodes(),o=a.firstNode();if(o)for(t.push(o.getFullName());;){if(o=a.nextNode(),!o)break;t.push(o.getFullName())}return a.release(),t},createLayers:function(e){if(!Q3D.Util.isArray(e)||"string"!=typeof e[0])return!1;var t=mapObj._map3d.getWorldManager(),n=e.length;return e.forEach(function(e){t.getLayer(e)&&n--}),!(n<e.length)&&(e.forEach(function(e){t.createLayer(e)}),!0)},toggleLayers:function(e){if(Q3D.Util.isArray(e)&&"string"==typeof e[0]){var t=mapObj._map3d.getWorldManager();e.forEach(function(e){var n=t.getLayer(e);n&&n.setVisible(1==n.isVisible()?0:1)})}return this},setLayersVisible:function(e,t){if(Q3D.Util.isArray(e)&&"string"==typeof e[0]){var n=mapObj._map3d.getWorldManager();e.forEach(function(e){var a=n.getLayer(e);a&&a.setVisible(t?1:0)})}return this},addSceneNodesToLayer:function(e,t){var n=this.getLayer(e);return n||(this.createLayers([e]),n=this.getLayer(e)),Q3D.Util.isArray(t)&&"string"==typeof t[0]&&t.forEach(function(e){var t=mapObj._map3d.getWorldManager().getSceneNode(e);t&&""==t.getLayerName()&&n.addSceneNodebyName(e)}),this},removeSceneNodesFromLayer:function(e,t){var n=this.getLayer(e);return!!n&&("undefined"==typeof t?n.removeAllNodes():Q3D.Util.isArray(t)&&"string"==typeof t[0]&&t.forEach(function(e){var t=mapObj._map3d.getWorldManager().getSceneNode(e);t&&n.removeNode(t)}),!0)},moveSceneNodesBetweenLayers:function(e,t){var n=this.getLayer(e),a=this.getLayer(t);if(!n||!a)return!1;var o=n.getLayerAllNodes();return this.moveSceneNodesToLayer(o,t)},moveSceneNodesToLayer:function(e,t){var n=this.getLayer(t);n||(this.createLayers([t]),n=this.getLayer(t));var a=e.firstNode();if(a)for(n.moveSceneNode(a);;){if(a=e.nextNode(),!a)break;n.moveSceneNode(a)}return e.release(),!0}},Q3D.layerGroup=function(){return new Q3D.LayerGroup},Q3D.MovieClip=function(e,t){if(!mapObj)throw new Error("无效的引擎对象，引擎对象未初始化！");this._mcName=e;var n=mapObj._map3d.getWorldManager();this._mc=n.getMovieClip(e),this._mc||(this._mc=n.createMovieClip(e)),this._mc.setFPS(t)},Q3D.MovieClip.prototype={get:function(){return this._mc},getTotalFrameLength:function(){return this._mc.getTimeLength()*this._mc.getFPS()},getFPS:function(){return this._mc.getFPS()},getFrameFromTime:function(e){var t=this._mc.getTimeLength();return e>t||e<0?-1:e*this._mc.getFPS()},getTimeFromFrame:function(e){var t=this.getTotalFrameLength();return e>t||e<0?-1:e/this._mc.getFPS()},removeActor:function(e){return this._mc.removeActor(e),this},removeAllActors:function(){return this._mc.removeAllActors(),this},hasActor:function(e){return null!=this._mc.getIActor(e)},addActorTranslateAnimation:function(e,t){var n=t.length;if(n<2)return null;var a=this._mc.getIActor(e);a||(a=this._mc.addIActor(e));for(var o=a.addITrack(Q3D.Enums.actorTrackType.TransformMove,Q3D.Enums.actorKeyType.KeyAuto).asKeyTrack(),i=0;i<t.length;i++){var r=o.addIKey(t[i].Key);r||(r=o.addIKey(t[i].Key+1)),r.setKeyIPointAsQVector3(t[i].Pos.get()),0==i?r.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.EaseIn):i==n-1?r.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.EaseOut):(r.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),r.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear))}return this},_addActorTranslateGravityAnimation:function(e,t){var n=t.length;if(n<2)return null;var a=this._mc.getIActor(e);a||(a=this._mc.addIActor(e));for(var o=a.addITrack(Q3D.Enums.actorTrackType.TransformMove,Q3D.Enums.actorKeyType.KeyAuto).asKeyTrack(),i=0;i<t.length;i++){var r=o.addIKey(t[i].Key);r||(r=o.addIKey(t[i].Key+1)),r.setKeyIPointAsQVector3(t[i].Pos.get()),i%2==0&&(r.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.EaseIn),i>0&&r.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.EaseOut))}return this},addActorTrackControlPoint:function(e,t,n,a){var o=this._mc.getIActor(e);if(!o)return null;var i=o.getITrack(Q3D.Enums.actorTrackType.TransformMove);if(!i)return null;var r=i.asKeyTrack(),s=r.getIKey(t);return s?(a?(s.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Bessel),s.setRightCtrlIPointAsQVector3(n.get())):(s.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Bessel),s.setLeftCtrlIPointAsQVector3(n.get())),this):null},addActorRotateAnimation:function(e,t){var n=t.length;if(n<2)return null;var a=this._mc.getIActor(e);a||(a=this._mc.addIActor(e));for(var o=a.addITrack(Q3D.Enums.actorTrackType.TransformRotate,Q3D.Enums.actorKeyType.KeyAuto).asKeyTrack(),i=0;i<t.length;i++){var r=o.addIKey(t[i].Key);if(r||(r=o.addIKey(t[i].Key+1)),r.setKeyIPointAsQVector3(t[i].Rotate.get()),0==i){var s=t[i].Rotate.clone(),l=t[i+1].Rotate.clone();s.equals(l)?r.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Point):r.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear)}else if(i==n-1){var s=t[i].Rotate.clone(),c=t[i-1].Rotate.clone();s.equals(c)?r.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Point):r.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear)}else{var s=t[i].Rotate.clone(),l=t[i+1].Rotate.clone(),c=t[i-1].Rotate.clone();s.equals(c)?r.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Point):r.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),s.equals(l)?r.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Point):r.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear)}}return this},addActorScaleAnimation:function(e,t){var n=t.length;if(n<2)return null;var a=this._mc.getIActor(e);a||(a=this._mc.addIActor(e));for(var o=a.addITrack(Q3D.Enums.actorTrackType.TransformScale,Q3D.Enums.actorKeyType.KeyAuto).asKeyTrack(),i=0;i<t.length;i++){var r=o.addIKey(t[i].Key);if(r||(r=o.addIKey(t[i].Key+1)),r.setKeyIPointAsQVector3(t[i].Scale.get()),0==i){var s=t[i].Scale.clone(),l=t[i+1].Scale.clone();s.equals(l)?r.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Point):r.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear)}else if(i==n-1){var s=t[i].Scale.clone(),c=t[i-1].Scale.clone();s.equals(c)?r.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Point):r.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear)}else{var s=t[i].Scale.clone(),l=t[i+1].Scale.clone(),c=t[i-1].Scale.clone();s.equals(c)?r.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Point):r.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),s.equals(l)?r.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Point):r.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear)}}return this},_addFadeInAnimation:function(e,t,n){var a=this._mc.getIActor(e);a?a.destroyTrack(Q3D.Enums.actorTrackType.ColorAlpha):a=this._mc.addIActor(e);var o=a.addITrack(Q3D.Enums.actorTrackType.ColorAlpha,Q3D.Enums.actorKeyType.KeyAuto).asKeyTrack(),i=o.addIKey(0);return i.setKeyIPointAsFloat(0),i=o.addIKey(t*this._mc.getFPS()),i.setKeyIPointAsFloat(n||1),i.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.EaseOut),this},_addFadeOutAnimation:function(e,t,n){var a=this._mc.getIActor(e);a?a.destroyTrack(Q3D.Enums.actorTrackType.ColorAlpha):a=this._mc.addIActor(e);var o=a.addITrack(Q3D.Enums.actorTrackType.ColorAlpha,Q3D.Enums.actorKeyType.KeyAuto).asKeyTrack(),i=o.addIKey(0);return i.setKeyIPointAsFloat(n||1),i.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.EaseIn),i=o.addIKey(t*this._mc.getFPS()),i.setKeyIPointAsFloat(0),this},_addTransparentFlashAnimation:function(e,t,n,a){var o=this._mc.getIActor(e);o?o.destroyTrack(Q3D.Enums.actorTrackType.ColorAlpha):o=this._mc.addIActor(e);var i=o.addITrack(Q3D.Enums.actorTrackType.ColorAlpha,Q3D.Enums.actorKeyType.KeyAuto).asKeyTrack(),r=0;key=i.addIKey(r),key.setKeyIPointAsFloat(t);for(var s=0;s<a;s++)key=i.addIKey(r+n*this._mc.getFPS()),key.setKeyIPointAsFloat(0),key=i.addIKey(r+2*n*this._mc.getFPS()),key.setKeyIPointAsFloat(t),r+=2*n*this._mc.getFPS();return this},_addColorFlashAnimation:function(e,t,n,a,o,i){var r=this._mc.getIActor(e),s=i?Q3D.Enums.actorTrackType.ColorEmissive:Q3D.Enums.actorTrackType.ColorDiffuse;r?r.destroyTrack(s):r=this._mc.addIActor(e);var l=r.addITrack(s,Q3D.Enums.actorKeyType.KeyAuto).asKeyTrack(),c=0,u=l.addIKey(c);u.setKeyIPointAsQColourValue(t);for(var d=0;d<o;d++)u=l.addIKey(c+a*this._mc.getFPS()),u.setKeyIPointAsQColourValue(n),u=l.addIKey(c+2*a*this._mc.getFPS()),u.setKeyIPointAsQColourValue(t),c+=2*a*this._mc.getFPS();return this}},Q3D.movieClip=function(e,t){return new Q3D.MovieClip(e,t)},Q3D.MovieClipInstance=function(e,t){if(!mapObj)throw new Error("无效的引擎对象，引擎对象未初始化！");
var n=mapObj._map3d.getWorldManager();this._mcInst=n.getMovieClipInstance(e),this._mcInst?(this._mcInst.setMovieClip(t.get().getCName()),this._mcInst.gotoFrame(0),this._mcInst.clearAllPlayers()):(this._mcInst=n.createMovieClipInstance(e),this._mcInst.setMovieClip(t.get().getCName()),mapObj._map3d.setMovieClipInstanceEventListener(this._mcInst)),this._mc=t,this._nodespos={},this._nodesmat=[]},Q3D.MovieClipInstance.prototype={get:function(){return this._mcInst},getMovieClip:function(){return this._mc},getCName:function(){return this._mcInst.getCName()},getMovieClipCName:function(){return this._mcInst.getMovieClipCName()},init:function(){this._mcInst.clearAllPlayers(),this._mcInst.setLoop(0),this._mcInst.gotoFrame(0),this._nodespos={},this._nodesmat=[]},setTransformPlayer:function(e,t){var n=t.getFullName();for(var a in this._nodespos)if(a==n)return!1;return this._mcInst.setPlayer(e,Q3D.Enums.playerType.Node,n),this._nodespos[n]=t.getPosition(),!0},setMaterialFadePlayer:function(e,t,n,a){var o=e.getNodeType();if(o!=Q3D.Enums.sceneNodeType.SNODE_Model&&o!=Q3D.Enums.sceneNodeType.SNODE_VecModel)return!1;var i=null;i=o==Q3D.Enums.sceneNodeType.SNODE_Model?e.asModel():e.asVecModel(),i.makeAloneMaterialsEx(2);for(var r=0;r<=i.getMaterialCount()-1;r++){var s=i.getMaterial(r);if(null!=s){var l=s.getAlpha();s.setAlphaBlendEnable(1),t==Q3D.Enums.fadeType.fadeIn?this._mc._addFadeInAnimation(s.getName(),n,l):t==Q3D.Enums.fadeType.fadeOut?this._mc._addFadeOutAnimation(s.getName(),n,l):this._mc._addTransparentFlashAnimation(s.getName(),l,n,a),this._mcInst.setPlayer(s.getName(),Q3D.Enums.playerType.Material,s.getName())}}var c=e.getFullName();return this._nodesmat.indexOf(c)==-1&&this._nodesmat.push(c),!0},setMaterialColorFlashPlayer:function(e,t,n,a,o){var i=e.getNodeType();if(i!=Q3D.Enums.sceneNodeType.SNODE_Model&&i!=Q3D.Enums.sceneNodeType.SNODE_VecModel)return!1;var r=null;r=i==Q3D.Enums.sceneNodeType.SNODE_Model?e.asModel():e.asVecModel(),r.makeAloneMaterialsEx(2);for(var s=0;s<=r.getMaterialCount()-1;s++){var l=r.getMaterial(s);if(null!=l){l.setAlphaBlendEnable(1);var c=o?l.getEmissiveColor():l.getDiffuseColor();this._mc._addColorFlashAnimation(l.getName(),c,t.get(),n,a,o),this._mcInst.setPlayer(l.getName(),Q3D.Enums.playerType.Material,l.getName())}}var u=e.getFullName();return this._nodesmat.indexOf(u)==-1&&this._nodesmat.push(u),!0},setPlayOptions:function(e,t){return this._mcInst.stop(),this._mcInst.setLoop(t?1:0),this._mcInst.gotoFrame(e?e:0),this},play:function(){return this._mcInst.play(),this},pause:function(){return this._mcInst.pause(),this},replay:function(){return this._mcInst.replay(),this},stop:function(){return this._mcInst.stop(),this},currFrame:function(){return this._mcInst.getCurrFrameNo()},currTime:function(){return this._mcInst.getCurrTickTime()},nextFrame:function(e){var t=this._mcInst.getCurrFrameNo();return this._mcInst.gotoFrame(t+(e?e:1)),this},nextTime:function(e){var t=this._mcInst.getCurrTickTime();return this._mcInst.gotoTime(t+(e?e:1)),this},prevFrame:function(e){var t=this._mcInst.getCurrFrameNo();return this._mcInst.gotoFrame(t-(e?e:1)),this},prevTime:function(e){var t=this._mcInst.getCurrTickTime();return this._mcInst.gotoTime(t-(e?e:1)),this},getFPS:function(){return this._mc.getFPS()},changePlaySpeed:function(e){var t=this._mcInst.getCurrFrameNo();return this._mc.get().setFPS(e),this._mcInst.gotoFrame(t),this},onMovieClipInstancePassFrame:function(e,t){return t&&Q3D.Util.isFunction(t)&&(mapObj.attachUIEvent("onMovieClipInstancePassFrame",this._mcInst.getCName()+"/"+e,t),this._mcInst.registerFrameEvent(e)),this},clearMovieClipInstancePassFrame:function(e){var t=this.getCName();if(mapObj._widgetEvents!=undefined){var n=mapObj._widgetEvents.onMovieClipInstancePassFrame;if(n)for(var a=0,o=n.length;a<o;a++){var i=n[a].key.split("/");if(i[0]==t&&i[i.length-1]==e){this._mcInst.unregisterFrameEvent(e),mapObj.detachUIEvent("onMovieClipInstancePassFrame",n[a].key);break}}}return this},_clearMovieClipInstanceOnLastFrame:function(e,t){this.onMovieClipInstancePassFrame(e,function(n,a){t&&Q3D.Util.isFunction(t)&&t(n,a);var o=n.getCName();setTimeout(function(){mapObj.clearMovieClip(o,e,!1)},100)})},restoreAllNodes:function(){this._mcInst.stop(),this._mcInst.gotoFrame(0),this._mcInst.clearAllPlayers();var e=mapObj._map3d.getWorldManager();for(var t in this._nodespos)e.getSceneNode(t).setPosition(this._nodespos[t]);return this._nodespos={},this._nodesmat.forEach(function(t){var n=e.getSceneNode(t);n.getNodeType()==Q3D.Enums.sceneNodeType.SNODE_Model?n.asModel().restoreAloneMaterials():n.asVecModel().restoreAloneMaterials()}),this._nodesmat=[],this}},Q3D.movieClipInstance=function(e,t){return new Q3D.MovieClipInstance(e,t)},Q3D.NodeContainer=function(e){if(!mapObj)throw new Error("无效的引擎对象，引擎对象未初始化！");var t=mapObj._map3d.getWorldManager();this._nc=t.getContainer(e),null==this._nc&&(this._nc=t.createContainer(e)),this._targetVal=null,this._ncType=null},Q3D.NodeContainer.prototype={get:function(){return this._nc},_doAction:function(e,t){t!=undefined&&this._nc.setMaterialModifyMode(t),this._ncType==Q3D.Enums.nodeContainerType.Alpha?e?this._nc.setMaterialAlpha(this._targetVal):this._nc.restoreAllMaterials():this._ncType==Q3D.Enums.nodeContainerType.Color?e?this._nc.setMaterialColor(this._targetVal.get()):this._nc.restoreAllMaterials():this._ncType==Q3D.Enums.nodeContainerType.Visible?e?this._nc.setNodeVisible(this._targetVal):this._nc.restoreAllNodeProperties():this._ncType==Q3D.Enums.nodeContainerType.Material&&(e?this._nc.setNodeReplaceMaterial(this._targetVal):this._nc.restoreAllNodeProperties())},setTargetVal:function(e,t,n){return this._ncType=e,this._targetVal=t,this._doAction(!0,n),this},addSceneNode:function(e){return this._nc.addSceneNode(e),this},addSceneNodeFromLayer:function(e){return this._nc.addSceneNodeFromLayer(e),this},addSceneNodeFromArea:function(e){return this._nc.addSceneNodeFromArea(e),this},loadFromFile:function(e,t){return this._nc.loadFromFile(e,asyc?1:0),this},removeSceneNode:function(e){return this._nc.removeSceneNode(e),this},clear:function(){return this._nc.clear(),this},restore:function(){return this._nc.restoreAllMaterials(),this._nc.restoreAllNodeProperties(),this}},Q3D.nodeContainer=function(e){return new Q3D.NodeContainer(e)},Q3D.Map.include({cameraRoamByFile:function(e,t,n,a){var o="TestLocalCamera_"+mapObj.guid(),i=this.createCommonNode(e+"/"+o,Q3D.Enums.sceneNodeType.SNODE_LocalCamera);if(n=n||Q3D.vector3d(Q3D.globalCamera().getAbsPos()),a=a||Q3D.vector3(Q3D.globalCamera().getOrientation()),i.setPosition(n.get()),i.setOrientation(a.get(),Q3D.Enums.nodeOrientationType.World),null!=i){var r=Q3D.globalCamera();mapObj._gcAbsPos=Q3D.vector3d(r.getAbsPos()),mapObj._gcOrientation=Q3D.vector3(r.getOrientation()),mapObj._localCamera=i.asCamera().asLocalCamera(),mapObj._localCamera.setNodeAnimationName(t),mapObj._localCamera.enableBind(1);var s=i.getNodeAnimationState();if(null==s)return;return s.setLoop(0),s.setAutoPlay(1),mapObj._map3d.setOnAnimationEndListener(s),mapObj.off("onCameraFlyToEnd"),mapObj.on("onAnimationEnd",function(e){mapObj._localCamera.enableBind(0),Q3D.globalCamera().flyTo(mapObj._gcAbsPos,mapObj._gcOrientation,.5),setTimeout(function(){mapObj._localCamera.getArea().destroySceneNode(mapObj._localCamera.getName()),mapObj._localCamera=null,mapObj.off("onAnimationEnd")},100)}),s.play(),mapObj._localCamera}},stopCameraRoam:function(){return mapObj._localCamera&&(mapObj._localCamera.getNodeAnimationState().stop(),mapObj._localCamera.enableBind(0),Q3D.globalCamera().flyTo(mapObj._gcAbsPos,mapObj._gcOrientation,.5),mapObj.off("onAnimationEnd"),mapObj._localCamera.getArea().destroySceneNode(mapObj._localCamera.getName()),mapObj._localCamera=null),this},cameraRoamByMovieClipFile:function(e,t,n){var a=50,o=n+"_mc",i=n+"_mci";this.clearMovieClip(i);var r=mapDiv.getOcx().getWorldManager();r.loadMovieClip(t,0);var s=Q3D.movieClip(o,a),l=Q3D.movieClipInstance(i,s),c=s.get().getIActor(n),u=c.getITrack("0").asKeyTrack().getIKey(0).getKeyIPointAsQVector3(),d=c.getITrack("1").asKeyTrack().getIKey(0).getKeyIPointAsQVector3(),p="_LocalCamera_RoamByCamera_",m=mapDiv.getSceneNode(e+"/"+p);if(!m){m=mapDiv.createCommonNode(e+"/"+p,Q3D.Enums.sceneNodeType.SNODE_LocalCamera);var h=Q3D.globalCamera();mapObj._gcAbsPos=Q3D.vector3d(h.getAbsPos()),mapObj._gcOrientation=Q3D.vector3(h.getOrientation()),mapObj._localCamera=m.asCamera().asLocalCamera()}return m.setPosition(u),m.setOrientation(d,Q3D.Enums.nodeOrientationType.World),l.setTransformPlayer(n,m),m.asCamera().asLocalCamera().enableBind(1),l._clearMovieClipInstanceOnLastFrame(s.getTotalFrameLength(),function(){mapObj._localCamera.enableBind(0),Q3D.globalCamera().flyTo(mapObj._gcAbsPos,mapObj._gcOrientation,.5),setTimeout(function(){mapObj._localCamera.getArea().destroySceneNode(mapObj._localCamera.getName()),mapObj._localCamera=null},100)}),l.setPlayOptions(0,!1),l},roamByPolyline:function(e,t){var n={CenterLine:[],OffsetDist:[],TotalTime:5,DelayTime:0,IsLoop:!1,IsAutoPlay:!1,IsEndDestroy:!0,PitchAllowed:!0,OnAnimationEndFn:null};Q3D.extend(n,t);try{if(n.CenterLine.length<2||n.CenterLine.length>=3&&n.CenterLine.length!=n.OffsetDist.length)return null;var a=this.getSceneNode(e);if(null==a)return null;for(var o=[n.CenterLine[0]],i=[n.OffsetDist[0]],r=1;r<n.CenterLine.length;++r)n.CenterLine[r].equals(n.CenterLine[r-1])||(o.push(n.CenterLine[r]),i.push(n.OffsetDist[r]));if(n.PitchAllowed)var s=o;else for(var s=[],r=0;r<o.length;++r)s[r]=Q3D.vector3(o[r].x,0,o[r].z);var l=e.split("/"),c=l[l.length-1],u=l[0],d=50,p=.5,m=u+"_"+c+"_MovieClip_RoamByPolyline",h=u+"_"+c+"_MovieClipInst_RoamByPolyline",y=u+"_"+c+"_Actor_RoamByPolyline";this.clearMovieClip(h);var g=Q3D.movieClip(m,d),f=n.TotalTime,E=parseInt(n.DelayTime*d),T=parseInt(E+p*d),O=parseInt((n.DelayTime+n.TotalTime+2*p)*d);if(2==o.length){var D=o[0],v=o[1],_=s[0],C=s[1],b=mapObj._map3d.getMath().directionToEuler(C.clone().subtract(_).get());g.addActorRotateAnimation(y,[{Key:E,Rotate:Q3D.vector3(a.getOrientation(Q3D.Enums.orientationType.World))},{Key:T,Rotate:Q3D.vector3(b)},{Key:O,Rotate:Q3D.vector3(b)}]),g.addActorTranslateAnimation(y,[{Key:E,Pos:Q3D.vector3(a.getPosition())},{Key:T,Pos:D},{Key:O-d*p,Pos:v},{Key:O,Pos:v}])}else{for(var Q=0,A=0;A<o.length-1;A++)Q+=o[A+1].distanceTo(o[A]);var b,I,D,v,_,C,M,N,S,P,L,R,F,j,w,U,x=[],V=[],k=[],B=0,K=Q3D.vector3(.5,.5,.5);x.push({Key:E,Pos:Q3D.vector3(a.getPosition())}),V.push({Key:E,Rotate:Q3D.vector3(a.getOrientation(Q3D.Enums.orientationType.World))}),x.push({Key:T,Pos:o[0]}),_=s[0],C=s[1],b=mapObj._map3d.getMath().directionToEuler(C.clone().subtract(_).get()),V.push({Key:T,Rotate:Q3D.vector3(b)});for(var r=1;r<o.length-1;r++)if(M=o[r-1],N=o[r],S=o[r+1],P=s[r-1],L=s[r],R=s[r+1],F=N.distanceTo(M),j=S.distanceTo(N),B+=F,w=mapObj._map3d.getMath().directionToEuler(L.clone().subtract(P).get()),U=mapObj._map3d.getMath().directionToEuler(R.clone().subtract(L).get()),i[r]>0){var W=3*i[r]<F?i[r]:F/3,H=M.clone().subtract(N).multiply(Q3D.vector3(W/F,W/F,W/F)),z=N.clone().add(H);I=parseInt(T+(B-W)/Q*d*f),x.push({Key:I,Pos:z}),V.push({Key:I,Rotate:Q3D.vector3(w)}),k.push({Key:I,Pos:z.clone().add(N).multiply(K)}),W=3*i[r]<j?i[r]:j/3,H=S.clone().subtract(N).multiply(Q3D.vector3(W/j,W/j,W/j));var G=N.clone().add(H);I=parseInt(T+(B+W)/Q*d*f),x.push({Key:I,Pos:G}),V.push({Key:I,Rotate:Q3D.vector3(U)}),k.push({Key:I,Pos:G.clone().add(N).multiply(K)})}else I=parseInt(T+B/Q*d*f),x.push({Key:I,Pos:N}),V.push({Key:I,Rotate:Q3D.vector3(U)});I=parseInt(T+d*f),x.push({Key:I,Pos:o[r]}),x.push({Key:O,Pos:o[r]}),_=s[r-1],C=s[r],b=mapObj._map3d.getMath().directionToEuler(C.clone().subtract(_).get()),V.push({Key:I,Rotate:Q3D.vector3(b)}),V.push({Key:O,Rotate:Q3D.vector3(b)}),g.addActorTranslateAnimation(y,x);for(var X=0;X<k.length;)g.addActorTrackControlPoint(y,k[X].Key,k[X].Pos,!0),g.addActorTrackControlPoint(y,k[X+1].Key,k[X+1].Pos,!1),X+=2;g.addActorRotateAnimation(y,V)}var q=Q3D.movieClipInstance(h,g);return q.setTransformPlayer(y,a),q.setPlayOptions(0,n.IsLoop),n.IsEndDestroy&&q._clearMovieClipInstanceOnLastFrame(O,n.OnAnimationEndFn),n.IsAutoPlay&&q.play(),q}catch(e){return this.showNotice("错误","roamByPolyline: "+e.message),null}return null},roamByGPSTrack:function(e,t){var n={CenterLine:[],SecsFromStart:[],Heading:null,TotalTime:5,IsLoop:!1,IsAutoPlay:!1,IsEndDestroy:!0,PitchAllowed:!0,BaseGlobalPos:null,OnAnimationEndFn:null};Q3D.extend(n,t);try{var a=n.CenterLine,o=n.SecsFromStart,i=n.Heading,r=n.TotalTime;if(a.length<2||a.length>=3&&a.length!=o.length||null!=i&&i.length!=a.length)return null;var s=this.getSceneNode(e);if(null==s)return null;var l=e.split("/"),c=l[l.length-1],u=l[0];if(Q3D.Util.isQMapObj(a[0].get(),Q3D.Enums.ValueTypeCLSID.QGlobalVec3d)){var d=Q3D.vector3(0,0,0);n.BaseGlobalPos&&(d=Q3D.vector3(BaseGlobalPos.toLocalPos(u)));for(var p=[],m=0;m<a.length;++m){var h=Q3D.vector3(a[m].toLocalPos(u));p.push(h.subtract(d))}}else var p=a;if(n.PitchAllowed)var y=p;else for(var y=[],m=0;m<p.length;++m)y[m]=Q3D.vector3(p[m].x,0,p[m].z);var g=50,f=.02,E=r/o[o.length-1],T=u+"_"+c+"_MovieClip_RoamByGPSTrack",O=u+"_"+c+"_MovieClipInst_RoamByGPSTrack",D=u+"_"+c+"_Actor_RoamByGPSTrack";this.clearMovieClip(O);var v,_,C,b=Q3D.movieClip(T,g),Q=[],A=[];if(null==i){for(var m=0;m<p.length-1;m++){Q.push({Key:parseInt(o[m]*g*E),Pos:p[m]}),Q.push({Key:parseInt((o[m]+f)*g*E),Pos:p[m]}),A.push({Key:parseInt(o[m]*g*E),Rotate:0==A.length?Q3D.vector3(s.getOrientation(Q3D.Enums.orientationType.World)):A[A.length-1].Rotate}),v=y[m],_=y[m+1];var I=_.clone().subtract(v);C=Math.abs(I.x)<1e-9&&Math.abs(I.y)<1e-9&&Math.abs(I.z)<1e-9?A[A.length-1].Rotate:Q3D.vector3(mapObj._map3d.getMath().directionToEuler(I.get())),A.push({Key:parseInt((o[m]+f)*g*E),Rotate:C})}Q.push({Key:parseInt(r*g),Pos:p[p.length-1]}),A.push({Key:parseInt(r*g),Rotate:C})}else{s.setOrientation(Q3D.vector3(0,i[0],0).get(),Q3D.Enums.orientationType.World),Q.push({Key:parseInt(o[0]*g*E),Pos:p[0]}),A.push({Key:parseInt(o[0]*g*E),Rotate:Q3D.vector3(0,i[0],0)});for(var m=1;m<p.length;m++)Q.push({Key:parseInt((o[m]-f)*g*E),Pos:p[m]}),Q.push({Key:parseInt(o[m]*g*E),Pos:p[m]}),A.push({Key:parseInt((o[m]-f)*g*E),Rotate:A[A.length-1].Rotate}),A.push({Key:parseInt(o[m]*g*E),Rotate:Q3D.vector3(0,i[m],0)})}b.addActorTranslateAnimation(D,Q),b.addActorRotateAnimation(D,A);var M=Q3D.movieClipInstance(O,b);return M.setTransformPlayer(D,s),M.setPlayOptions(0,n.IsLoop),n.IsEndDestroy&&M._clearMovieClipInstanceOnLastFrame(parseInt(r*g),n.OnAnimationEndFn),n.IsAutoPlay&&M.play(),M}catch(e){return this.showNotice("错误","roamByGPSTrack: "+e.message),null}return null},clearMovieClip:function(e,t,n){var a=mapObj._map3d.getWorldManager().getMovieClipInstance(e);if(null==a)return null;if(a.stop(),a.gotoFrame(t||0),this._widgetEvents!=undefined){var o=mapObj._widgetEvents.onMovieClipInstancePassFrame;if(o)for(var i=0,r=o.length;i<r;){var s=o[i].key.split("/");s[0]!=e?++i:(a.unregisterFrameEvent(s[s.length-1]),mapObj.detachUIEvent("onMovieClipInstancePassFrame",o[i].key),r-=1)}}var n=n||!1;if(!n){var l=a.getMovieClipCName();mapObj._map3d.getWorldManager().destroyMovieClip(l)}return mapObj._map3d.getWorldManager().destroyMovieClipInstance(e),this},createRoamRoute:function(e,t){var n={Material:null,SpecialTransparent:!0,LinePoints:[],OffsetDist:[],LineOptions:{Subdivision:20,LineWidth:2,WrapLen:2,Color:Q3D.colourValue("#0000FF",1),Alpha:1},OnLineCreated:null};if(Q3D.Util.jQueryExtend(!0,n,t),n.LinePoints.length<2||n.LinePoints.length>=3&&n.LinePoints.length!=n.OffsetDist.length)return null;for(var a=[n.LinePoints[0]],o=[n.OffsetDist[0]],i=1;i<n.LinePoints.length;++i)n.LinePoints[i].equals(n.LinePoints[i-1])||(a.push(n.LinePoints[i]),o.push(n.OffsetDist[i]));var r,s,l,c,u,d,p,m,h,y=[],g=Q3D.vector3(.5,.5,.5);y.push(a[0].clone()),y.push(Q3D.vector3(2*a[0].x/3,2*a[0].y/3,2*a[0].z/3)),y.push(Q3D.vector3(1*a[0].x/3,1*a[0].y/3,1*a[0].z/3));for(var i=1,f=a.length;i<f-1;++i)if(o[i]>0){r=a[i-1],l=a[i],s=a[i+1],p=l.distanceTo(r),h=3*o[i]<p?o[i]:p/3,d=r.clone().subtract(l).multiply(Q3D.vector3(h/p,h/p,h/p)),c=l.clone().add(d),m=s.distanceTo(l),h=3*o[i]<m?o[i]:m/3,d=s.clone().subtract(l).multiply(Q3D.vector3(h/m,h/m,h/m)),u=l.clone().add(d);var E=y.length;y[E-2].add(Q3D.vector3(1*c.x/3,1*c.y/3,1*c.z/3).get()),y[E-1].add(Q3D.vector3(2*c.x/3,2*c.y/3,2*c.z/3).get()),y.push(c),y.push(c.clone().add(l).multiply(g)),y.push(u.clone().add(l).multiply(g)),y.push(u),y.push(Q3D.vector3(2*u.x/3,2*u.y/3,2*u.z/3)),y.push(Q3D.vector3(1*u.x/3,1*u.y/3,1*u.z/3))}else{var E=y.length;y[E-2].add(Q3D.vector3(1*a[i].x/3,1*a[i].y/3,1*a[i].z/3)),y[E-1].add(Q3D.vector3(2*a[i].x/3,2*a[i].y/3,2*a[i].z/3)),y.push(a[i].clone()),y.push(Q3D.vector3(2*a[i].x/3,2*a[i].y/3,2*a[i].z/3)),y.push(Q3D.vector3(1*a[i].x/3,1*a[i].y/3,1*a[i].z/3))}var E=y.length,i=f-1;y[E-2].add(Q3D.vector3(1*a[i].x/3,1*a[i].y/3,1*a[i].z/3)),y[E-1].add(Q3D.vector3(2*a[i].x/3,2*a[i].y/3,2*a[i].z/3)),y.push(a[i].clone());var T={Material:n.Material,SpecialTransparent:n.SpecialTransparent,LinePoints:[y],LineOptions:{LineType:Q3D.Enums.lineType.Bessel,BesselDim:3,Subdivision:n.LineOptions.Subdivision,LineWidth:n.LineOptions.LineWidth,WrapLen:n.LineOptions.WrapLen,Color:n.LineOptions.Color,Alpha:n.LineOptions.Alpha},OnLineCreated:n.OnLineCreated};return this.createPolyLine(e,T)},firstPersonView:function(e,t,n){var a={Postion:Q3D.vector3(0,0,0),Orientation:Q3D.vector3(0,180,0),OrientationType:Q3D.Enums.nodeOrientationType.Self};Q3D.Util.jQueryExtend(!0,a,n);var o=mapObj.getSceneNode(e);if(!o)return null;var i=e.split("/"),r=i[i.length-1],s=i[0],l=s+"/"+r+"/"+t,c=mapObj.getSceneNode(s,t);c||(c=mapObj.createCommonNode(l,Q3D.Enums.sceneNodeType.SNODE_LocalCamera));var u=c.asCamera().asLocalCamera();u.setPosition(a.Postion.get()),u.setOrientation(a.Orientation.get(),a.OrientationType);var d=mapObj.getOcx().getWorldManager().getMainCamera(0);return u.bindCamera(d),u.enableBind(1),c},thirdPersonView:function(e,t){var n=mapObj.getSceneNode(e,t);return null!=n&&(n.asCamera().asLocalCamera().unbindCamera(),mapObj.getArea(e).destroySceneNode(t)),this},startRealTimeTrack:function(e,t){var n={TimeDiff:null,Location:null,Heading:null,PitchAllowed:!0};Q3D.extend(n,t);var a=this.getSceneNode(e);if(null==a||a.getNodeType()!=Q3D.Enums.sceneNodeType.SNODE_Model)return null;var o=e.split("/"),i=o[o.length-1],r=o[0],s=r+"_"+i+"_MovieClip_RealTimeGPSTrack",l=r+"_"+i+"_MovieClipInst_RealTimeGPSTrack",c=r+"_"+i+"_Actor_RealTimeGPSTrack",u=50,d=.1,p=mapObj._map3d.getWorldManager(),m=p.getMovieClip(s);m||(m=p.createMovieClip(s),m.setFPS(u));var h=p.getMovieClipInstance(l);h||(h=p.createMovieClipInstance(l),h.setMovieClip(s),mapObj._map3d.setMovieClipInstanceEventListener(h));var y=null,g=null,f=Q3D.Util.isQMapObj(n.Location.get(),Q3D.Enums.ValueTypeCLSID.QVector3)?n.Location:Q3D.vector3(n.Location.toLocalPos(r)),E=m.getIActor(c);if(null==E){if(mapObj._gTrackInfo=mapObj._gTrackInfo||{},mapObj._prevDirection=mapObj._prevDirection||{},E=m.addIActor(c),!E)throw new Error("添加Actor失败");y=E.addITrack(Q3D.Enums.actorTrackType.TransformMove,Q3D.Enums.actorKeyType.KeyAuto).asKeyTrack(),g=E.addITrack(Q3D.Enums.actorTrackType.TransformRotate,Q3D.Enums.actorKeyType.KeyAuto).asKeyTrack();var T=y.addIKey(0);T.setKeyIPointAsQVector3(f.get()),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.EaseOut);var O=Q3D.vector3(a.getOrientation(0));null!=n.Heading&&(O.y=n.Heading),T=g.addIKey(0),T.setKeyIPointAsQVector3(O.get()),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Point),mapObj._gTrackInfo[s]=[0],mapObj._prevDirection[s]=O,h.setPlayer(c,Q3D.Enums.playerType.Node,r+"/"+i),h.setLoop(0),h.play()}else{y=E.getITrack(Q3D.Enums.actorTrackType.TransformMove).asKeyTrack(),g=E.getITrack(Q3D.Enums.actorTrackType.TransformRotate).asKeyTrack();var D=mapObj._gTrackInfo[s].length,v=mapObj._gTrackInfo[s][D-1],_=y.getIKey(v),C=_.getKeyIPointAsQVector3(),b=Q3D.vector3(C),Q=f.clone();n.PitchAllowed||(b.y=0,Q.y=0);var A=Q.clone().subtract(b),I=Math.abs(A.x)<1e-9&&Math.abs(A.y)<1e-9&&Math.abs(A.z)<1e-9?mapObj._prevDirection[s]:Q3D.vector3(mapObj._map3d.getMath().directionToEuler(A.get()));if(n.TimeDiff*u>v+d*u){var T=null,M=0;null==n.Heading?(M=Math.round(v+d*u),T=y.addIKey(M),T.setKeyIPointAsQVector3(C),T.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T=g.addIKey(M),T.setKeyIPointAsQVector3(I.get()),T.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),mapObj._gTrackInfo[s].push(M)):(M=Math.round(n.TimeDiff*u-d*u),T=y.addIKey(M),T.setKeyIPointAsQVector3(f.get()),T.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T=g.addIKey(M),T.setKeyIPointAsQVector3(mapObj._prevDirection[s].get()),T.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),mapObj._gTrackInfo[s].push(M)),M=Math.round(n.TimeDiff*u),T=y.addIKey(M),T.setKeyIPointAsQVector3(f.get()),T.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),null==n.Heading?(T=g.addIKey(M),T.setKeyIPointAsQVector3(I.get()),T.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear)):(T=g.addIKey(M),I=mapObj._prevDirection[s],I.y=n.Heading,T.setKeyIPointAsQVector3(I.get()),T.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear)),mapObj._gTrackInfo[s].push(M),mapObj._prevDirection[s]=I}for(var N=h.getCurrFrameNo(),S=0,D=mapObj._gTrackInfo[s].length;S<D;++S)if(mapObj._gTrackInfo[s][S]>N){if(0===S)break;for(var P=0;P<S-1;++P){var M=mapObj._gTrackInfo[s][P];y.removeKey(M),g.removeKey(M)}mapObj._gTrackInfo[s].splice(0,S-1);break}h.play()}return this},startRealTimeTrackEx:function(e,t){var n={TimeDiff:null,LocationArr:null,Heading:null,PitchAllowed:!0};if(Q3D.extend(n,t),null!=n.Heading&&n.Heading.length!=n.LocationArr.length)return null;var a=this.getSceneNode(e);if(null==a||a.getNodeType()!=Q3D.Enums.sceneNodeType.SNODE_Model)return null;var o=e.split("/"),i=o[o.length-1],r=o[0],s=r+"_"+i+"_MovieClip_RealTimeGPSTrack",l=r+"_"+i+"_MovieClipInst_RealTimeGPSTrack",c=r+"_"+i+"_Actor_RealTimeGPSTrack",u=50,d=.04,p=mapObj._map3d.getWorldManager(),m=p.getMovieClip(s);m||(m=p.createMovieClip(s),m.setFPS(u));var h=p.getMovieClipInstance(l);h||(h=p.createMovieClipInstance(l),h.setMovieClip(s),mapObj._map3d.setMovieClipInstanceEventListener(h));var y=null,g=null,f=m.getIActor(c);if(null==f){if(mapObj._gTrackInfo=mapObj._gTrackInfo||{},mapObj._prevDirection=mapObj._prevDirection||{},f=m.addIActor(c),!f)throw new Error("添加Actor失败");y=f.addITrack(Q3D.Enums.actorTrackType.TransformMove,Q3D.Enums.actorKeyType.KeyAuto).asKeyTrack(),g=f.addITrack(Q3D.Enums.actorTrackType.TransformRotate,Q3D.Enums.actorKeyType.KeyAuto).asKeyTrack();var E=Q3D.Util.isQMapObj(n.LocationArr[0].get(),Q3D.Enums.ValueTypeCLSID.QVector3)?n.LocationArr[0]:Q3D.vector3(n.LocationArr[0].toLocalPos(r)),T=y.addIKey(0);T.setKeyIPointAsQVector3(E.get()),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.EaseOut);var O=Q3D.vector3(a.getOrientation(0));null!=n.Heading&&(O.y=n.Heading[0]),T=g.addIKey(0),T.setKeyIPointAsQVector3(O.get()),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Point),mapObj._gTrackInfo[s]=[0],mapObj._prevDirection[s]=O,h.setPlayer(c,Q3D.Enums.playerType.Node,r+"/"+i),h.setLoop(0),h.play()}else{y=f.getITrack(Q3D.Enums.actorTrackType.TransformMove).asKeyTrack(),g=f.getITrack(Q3D.Enums.actorTrackType.TransformRotate).asKeyTrack();for(var D=mapObj._gTrackInfo[s].length,v=mapObj._gTrackInfo[s][D-1],_=y.getIKey(v),C=_.getKeyIPointAsQVector3(),b=Q3D.vector3(C),Q=n.TimeDiff*u,A=Q-v,I=n.LocationArr,M=I.length,N=[I[0].distanceTo(C)],S=N[0],P=0;P<M-1;++P)N.push(I[P+1].distanceTo(I[P])),S+=N[P+1];for(var P=0;P<M;++P){var L=Q3D.Util.isQMapObj(I[P].get(),Q3D.Enums.ValueTypeCLSID.QVector3)?I[P]:Q3D.vector3(I[P].toLocalPos(r)),R=v+parseInt(N[P]/S*A),F=L.clone();n.PitchAllowed||(b.y=0,F.y=0);var j=F.clone().subtract(b),O=Math.abs(j.x)<1e-9&&Math.abs(j.y)<1e-9&&Math.abs(j.z)<1e-9?mapObj._prevDirection[s]:Q3D.vector3(mapObj._map3d.getMath().directionToEuler(j.get()));if(R>v+d*u){var T=null,w=0;null==n.Heading?(w=Math.round(v+d*u),T=y.addIKey(w),T.setKeyIPointAsQVector3(C),T.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T=g.addIKey(w),T.setKeyIPointAsQVector3(O.get()),T.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),mapObj._gTrackInfo[s].push(w)):(w=Math.round(R-d*u),T=y.addIKey(w),T.setKeyIPointAsQVector3(L.get()),T.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T=g.addIKey(w),T.setKeyIPointAsQVector3(mapObj._prevDirection[s].get()),T.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),mapObj._gTrackInfo[s].push(w)),T=y.addIKey(R),T.setKeyIPointAsQVector3(L.get()),T.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),null==n.Heading?(T=g.addIKey(R),T.setKeyIPointAsQVector3(O.get()),T.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear)):(T=g.addIKey(R),O=mapObj._prevDirection[s],O.y=n.Heading[P],T.setKeyIPointAsQVector3(O.get()),T.setLeftTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setRightTimeCtrlType(Q3D.Enums.timeCtrlType.Linear),T.setLeftCurveCtrlType(Q3D.Enums.curveCtrlType.Linear),T.setRightCurveCtrlType(Q3D.Enums.curveCtrlType.Linear)),mapObj._gTrackInfo[s].push(R),mapObj._prevDirection[s]=O}v=R,b=F,C=L.get()}for(var U=h.getCurrFrameNo(),x=0,D=mapObj._gTrackInfo[s].length;x<D;++x)if(mapObj._gTrackInfo[s][x]>U){if(0===x)break;for(var V=0;V<x-1;++V){var w=mapObj._gTrackInfo[s][V];y.removeKey(w),g.removeKey(w)}mapObj._gTrackInfo[s].splice(0,x-1);break}h.play()}return this},stopRealTimeTrack:function(e){var t=e.split("/"),n=t[t.length-1],a=t[0],o=a+"_"+n+"_MovieClip_RealTimeGPSTrack",i=a+"_"+n+"_MovieClipInst_RealTimeGPSTrack";return this.clearMovieClip(i)&&(delete mapObj._gTrackInfo[o],delete mapObj._prevDirection[o]),this},drawTrackLine:function(e,t){var n={Material:null,Color:Q3D.colourValue("#FF0000",1),Alpha:1,LineWidth:2,WrapLen:2,SpecialTransparent:!0,TimeInterval:300};Q3D.Util.jQueryExtend(!0,n,t);var a=mapObj.getSceneNode(e);if(!a)return null;var o=e.split("/"),i=o[o.length-1],r=o[0],s="TrackLineOf_"+r+"_"+i,l=r+"/"+s;this.stopAndRemoveTrackLine(e);var c=this.createCommonNode(l,Q3D.Enums.sceneNodeType.SNODE_Line);if(!c)return null;var u=c.asLine();if(null!=n.Material)u.setMaterial(n.Material);else{var d="defaultMaterialForLine-"+this.guid(),p=this._map3d.getResourceManager().getResource(Q3D.Enums.resourceType.MATERIAL,d);null==p?p=this.createSimpleMaterial(d,{Alpha:n.Alpha,EmissiveColor:n.Color}):(p=p.asMaterial(),p.setAlpha(n.Alpha),p.setEmissiveColor(n.Color.get())),u.setMaterial(d)}var m=a.getAbsPos();u.setAbsPos(m);var h=u.addLine();return h.setLineType(0),h.setLineWidth(n.LineWidth),h.setWrapLen(n.WrapLen),h.addPoint(Q3D.vector3(0,0,0).get()),this._timeOutIdForTrackLine=this._timeOutIdForTrackLine||{},this._timeOutIdForTrackLine[s]=setTimeout(function(){if(""===a.getName())return clearTimeout(mapObj._timeOutIdForTrackLine[s]),this;var e=a.getAbsPos();e.subtract(m);var t=Q3D.vector3(e.x,e.y,e.z).get(),o=h.getPointCount(),i=h.getPoint(o-1),r=Math.max(Math.abs(t.x-i.x),Math.abs(t.y-i.y),Math.abs(t.z-i.z));r>1e-9&&h.addPoint(t),mapObj._timeOutIdForTrackLine[s]=setTimeout(arguments.callee,n.TimeInterval)},n.TimeInterval),this},stopDrawingTrackLine:function(e){var t=e.split("/"),n=t[t.length-1],a=t[0],o="TrackLineOf_"+a+"_"+n;return this._timeOutIdForTrackLine!=undefined&&this._timeOutIdForTrackLine[o]!=undefined&&clearTimeout(this._timeOutIdForTrackLine[o]),this},stopAndRemoveTrackLine:function(e){var t=e.split("/"),n=t[t.length-1],a=t[0],o="TrackLineOf_"+a+"_"+n;return this._timeOutIdForTrackLine!=undefined&&this._timeOutIdForTrackLine[o]!=undefined&&(clearTimeout(this._timeOutIdForTrackLine[o]),delete this._timeOutIdForTrackLine[o]),this.destroySceneNode(a,o),this},drawTrackLineByPipe:function(e,t){var n={Material:null,Color:Q3D.colourValue("#FF0000",1),Alpha:1,OuterRadius:.5,InnerRadius:.4,Radius:1,Angle:20,HeightOffset:0,TimeInterval:500};Q3D.Util.jQueryExtend(!0,n,t);var a=mapObj.getSceneNode(e);if(!a)return null;var o=e.split("/"),i=o[o.length-1],r=o[0],s="TrackLineByPipe_"+r+"_"+i,l=r+"/"+s;this.stopAndRemoveTrackLineByPipe(e);var c=this.createCommonNode(l,Q3D.Enums.sceneNodeType.SNODE_VecModel);if(!c)return null;var u=c.asVecModel(),d=u.createVecModel(Q3D.Enums.vecModelType.QPipe).asPipe();if(null!=n.Material)if(Q3D.Util.isArray(n.Material))for(var p=0;p<=n.Material.length&&(u.setMaterial(p,n.Material[p]),3!=p);p++);else u.setMaterial(0,n.Material),u.setMaterial(1,n.Material),u.setMaterial(2,n.Material),u.setMaterial(3,n.Material);else{var m="defaultMaterialForPipe-"+this.guid(),h=this._map3d.getResourceManager().getResource(Q3D.Enums.resourceType.MATERIAL,m);if(null==h)var y=this.createSimpleMaterial(m,{Alpha:n.Alpha,DiffuseColor:n.Color});else{var y=h.asMaterial();y.setAlpha(n.Alpha),y.setEmissiveColor(n.Color.get())}u.setMaterial(0,m),u.setMaterial(1,m),u.setMaterial(2,m),u.setMaterial(3,m)}var g=a.getAbsPos();return u.setAbsPos(g),d.setRadiusInner(n.InnerRadius),d.setRadiusOuter(n.OuterRadius),d.setCrossPieces(24),d.addPoint(Q3D.arcVertex(0,0+n.HeightOffset,0,n.Radius,n.Angle).get()),this._timeOutIdForTrackLineByPipe=this._timeOutIdForTrackLineByPipe||{},this._timeOutIdForTrackLineByPipe[s]=setTimeout(function(){if(""===a.getName())return clearTimeout(mapObj._timeOutIdForTrackLineByPipe[s]),this;var e=a.getAbsPos();e.subtract(g);var t=Q3D.arcVertex(e.x,e.y+n.HeightOffset,e.z,n.Radius,n.Angle).get(),o=d.getCount(),i=t.getPos(),r=d.getPoint(o-1).getPos(),l=Math.max(Math.abs(i.x-r.x),Math.abs(i.y-r.y),Math.abs(i.z-r.z));l>1e-9&&d.addPoint(t),mapObj._timeOutIdForTrackLineByPipe[s]=setTimeout(arguments.callee,n.TimeInterval)},n.TimeInterval),this},stopDrawingTrackLineByPipe:function(e){var t=e.split("/"),n=t[t.length-1],a=t[0],o="TrackLineByPipe_"+a+"_"+n;return this._timeOutIdForTrackLineByPipe!=undefined&&this._timeOutIdForTrackLineByPipe[o]!=undefined&&clearTimeout(this._timeOutIdForTrackLineByPipe[o]),this},stopAndRemoveTrackLineByPipe:function(e){var t=e.split("/"),n=t[t.length-1],a=t[0],o="TrackLineByPipe_"+a+"_"+n;return this._timeOutIdForTrackLineByPipe!=undefined&&this._timeOutIdForTrackLineByPipe[o]!=undefined&&(clearTimeout(this._timeOutIdForTrackLineByPipe[o]),
delete this._timeOutIdForTrackLineByPipe[o]),this.destroySceneNode(a,o),this},drawTrackLineByWall:function(e,t){var n={Material:null,Color:Q3D.colourValue("#FF0000",1),Alpha:1,IgnoreFloor:!0,IgnoreCeil:!1,Height:.01,Width:.5,HeightOffset:0,TimeInterval:500};Q3D.Util.jQueryExtend(!0,n,t);var a=mapObj.getSceneNode(e);if(!a)return null;var o=e.split("/"),i=o[o.length-1],r=o[0],s="TrackLineByWall_"+r+"_"+i,l=r+"/"+s;this.stopAndRemoveTrackLineByWall(e);var c=this.createCommonNode(l,Q3D.Enums.sceneNodeType.SNODE_VecModel);if(!c)return null;var u=c.asVecModel(),d=u.createVecModel(Q3D.Enums.vecModelType.QWalls).asWalls();if(null!=n.Material)if(Q3D.Util.isArray(n.Material))for(var p=0;p<=n.Material.length;p++)p<=4?u.setMaterial(p,n.Material[p]):u.addMaterial(n.Material[p]);else for(var p=0;p<5;++p)u.setMaterial(p,n.Material);else{var m="defaultMaterialForWalls-"+this.guid(),h=this._map3d.getResourceManager().getResource(Q3D.Enums.resourceType.MATERIAL,m);if(null==h)var y=this.createSimpleMaterial(m,{Alpha:n.Alpha,DiffuseColor:n.Color});else{var y=h.asMaterial();y.setAlpha(n.Alpha),y.setEmissiveColor(n.Color.get())}for(var p=0;p<5;++p)u.setMaterial(p,m)}d.setDefaultSize(n.Width,n.Height),n.IgnoreCeil&&d.ignoreCeil(1),n.IgnoreFloor&&d.ignoreFloor(1);var g=a.getAbsPos();return u.setAbsPos(g),d.addCorner(0,Q3D.vector3(0,n.HeightOffset,0).get()),this._timeOutIdForTrackLineByWall=this._timeOutIdForTrackLineByWall||{},this._timeOutIdForTrackLineByWall[s]=setTimeout(function(){if(""===a.getName())return clearTimeout(mapObj._timeOutIdForTrackLineByWall[s]),this;var e=a.getAbsPos();e.subtract(g);var t=Q3D.vector3(e.x,e.y+n.HeightOffset,e.z).get(),o=d.getCornerCount(),i=d.getCornerID(o-1),r=d.getCornerPos(i),l=Math.max(Math.abs(t.x-r.x),Math.abs(t.y-r.y),Math.abs(t.z-r.z));l>1e-9&&(d.addCorner(i+1,t),d.constructWall(o-1,i,i+1)),mapObj._timeOutIdForTrackLineByWall[s]=setTimeout(arguments.callee,n.TimeInterval)},n.TimeInterval),this},stopDrawingTrackLineByWall:function(e){var t=e.split("/"),n=t[t.length-1],a=t[0],o="TrackLineByWall_"+a+"_"+n;return this._timeOutIdForTrackLineByWall!=undefined&&this._timeOutIdForTrackLineByWall[o]!=undefined&&clearTimeout(this._timeOutIdForTrackLineByWall[o]),this},stopAndRemoveTrackLineByWall:function(e){var t=e.split("/"),n=t[t.length-1],a=t[0],o="TrackLineByWall_"+a+"_"+n;return this._timeOutIdForTrackLineByWall!=undefined&&this._timeOutIdForTrackLineByWall[o]!=undefined&&(clearTimeout(this._timeOutIdForTrackLineByWall[o]),delete this._timeOutIdForTrackLineByWall[o]),this.destroySceneNode(a,o),this},_getRandomNum:function(e,t){var n=t-e,a=Math.random();return e+a*n},_addVehicle:function(e,t){var n={Position:null,Orientation:null,OrientationType:Q3D.Enums.nodeOrientationType.Self,Mesh:null,RoutePtsV3Array:[],Velocity:400/36,StartTime:0};Q3D.Util.jQueryExtend(!0,n,t);var a=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_Model);if(null==a)return null;var o=a.asModel();null!=n.Position&&o.setPosition(n.Position.get()),null!=n.Orientation&&o.setOrientation(n.Orientation.get(),n.OrientationType),null!=n.Mesh&&o.setMesh(n.Mesh);var i=o.getActiveCtrlObj(),r=n.Velocity;i.beginAddKey();for(var s=0;s<n.RoutePtsV3Array.length;++s)0==s?i.addKey(n.StartTime,n.RoutePtsV3Array[s].get()):i.addKeyByVel(r,n.RoutePtsV3Array[s].get());return i.endAddKey(),i.setLoop(1),mapObj._map3d.setActiveCtrlObjListener(i),this},_getTotalRoadLength:function(e){for(var t=0,n=1;n<e.length;++n){var a=e[n].x-e[n-1].x,o=e[n].y-e[n-1].y,i=e[n].z-e[n-1].z;t+=Math.sqrt(a*a+o*o+i*i)}return t},createOneRoadwayTraffic:function(e,t){var n={Velocity:40,RoutePtsGV3d:null,RoutePtsV3:null,AverageDistance:5,MinDistance:5,VehicleMeshArray:[],BaseGlobalPos:null,IsLabeled:!1};if(Q3D.Util.jQueryExtend(!0,n,t),!n.RoutePtsGV3d&&!n.RoutePtsV3||!n.VehicleMeshArray.length||!n.MinDistance)return null;var a=e.split("/"),o=a[a.length-1],i=a[0],r=i+"/"+o,s=mapObj.createCommonNode(r,Q3D.Enums.sceneNodeType.SNODE_Group);if(!s)return null;if(null!=n.RoutePtsV3)var l=n.RoutePtsV3;else if(null!=n.RoutePtsGV3d){var c=Q3D.vector3(0,0,0);n.BaseGlobalPos&&(c="string"==typeof n.BaseGlobalPos?Q3D.vector3(n.BaseGlobalPos.toGlobalVec3d().toLocalPos(i)):Q3D.vector3(n.BaseGlobalPos.toLocalPos(i)));var u=null,l=[],d=null;if("string"==typeof n.RoutePtsGV3d){u=n.RoutePtsGV3d.split(";");for(var p=0;p<u.length;++p)d=Q3D.vector3(u[p].toGlobalVec3d().toLocalPos(i)),d.subtract(c),l.push(d)}else for(var p=0;p<n.RoutePtsGV3d.length;++p)d=Q3D.vector3(n.RoutePtsGV3d[p].toLocalPos(i)),d.subtract(c),l.push(d)}for(var m=this._getTotalRoadLength(l),h=n.AverageDistance<n.MinDistance?n.MinDistance:n.AverageDistance,y=1e3*n.Velocity/3600,g=n.MinDistance/y,f=h/y,E=m/y,T=-g,O=g,D=2*f-g,v=0;T<E-O;){var _=r+"/"+o+"Vehicle"+v;T>E-O-D?T=E-O:T+=this._getRandomNum(O,D);var t={Position:Q3D.vector3(Q3D.globalVec3d(0,0,0).toLocalPos(i)),Orientation:Q3D.vector3(0,0,0),OrientationType:Q3D.Enums.nodeOrientationType.Self,Mesh:n.VehicleMeshArray[Math.floor(Math.random()*n.VehicleMeshArray.length)],RoutePtsV3Array:l,Velocity:y,StartTime:T};if(this._addVehicle(_,t),n.IsLabeled){var C={POIOptions:{FontName:"Arial",FontSize:16,FontColor:Q3D.colourValue("#ff0000",1),POILayout:Q3D.Enums.poiLayOut.Left,CharScale:1,Text:"Vehicle"+v,FontOutLine:1,FontEdgeColor:Q3D.colourValue(1,1,.5,1)}};this.createPOI(i+"/"+o+"Vehicle"+v+"/POI_"+o+"_Vehicle_"+v,C)}++v}return E},clearOneRoadwayTraffic:function(e){return mapObj.destroySceneNode(e)},addVehicleByGPSInfo:function(e,t){var n={Position:null,Orientation:null,OrientationType:Q3D.Enums.nodeOrientationType.Self,Mesh:null,MeshType:1,RoutePtsV3Array:[],SecsFromStart:[],OnActCtrlObjAniEnd:null};if(Q3D.Util.jQueryExtend(!0,n,t),!n.RoutePtsV3Array||!n.SecsFromStart||n.RoutePtsV3Array.length!=n.SecsFromStart.length)return null;var a=e.split("/"),o=a[0],i=a[a.length-1],r=!0,s=this.getSceneNode(o,i);if(!s){s=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_Model);var l=s.asModel();if(null!=n.Position&&l.setPosition(n.Position.get()),null!=n.Orientation&&l.setOrientation(n.Orientation.get(),n.OrientationType),null!=n.Mesh)switch(n.MeshType){case 1:l.setMesh(n.Mesh);break;case 2:l.setLodGroup(n.Mesh),l.loadAllResource()}r=!1}var c=s.getActiveCtrlObj();c.beginAddKey();for(var u=0;u<n.RoutePtsV3Array.length;++u)c.addKey(n.SecsFromStart[u],n.RoutePtsV3Array[u].get());return c.endAddKey(),r||(c.setMaxKeyframeBufferSize(0),mapObj._map3d.setActiveCtrlObjListener(c),n.OnActCtrlObjAniEnd&&Q3D.Util.isFunction(n.OnActCtrlObjAniEnd)&&mapObj.attachUIEvent("onActCtrlObjAniEnd",i,n.OnActCtrlObjAniEnd)),c},addVehicleByGPSInfoEx:function(e,t){var n={Position:null,Orientation:null,OrientationType:Q3D.Enums.nodeOrientationType.Self,Mesh:null,MeshType:1,LocInfos:null,OnActCtrlObjAniEnd:null};if(Q3D.Util.jQueryExtend(!0,n,t),!n.LocInfos||0==n.LocInfos.length)return null;var a=e.split("/"),o=a[0],i=a[a.length-1],r=!0,s=this.getSceneNode(o,i);if(!s){s=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_Model);var l=s.asModel();if(null!=n.Position&&l.setPosition(n.Position.get()),null!=n.Orientation&&l.setOrientation(n.Orientation.get(),n.OrientationType),null!=n.Mesh)switch(n.MeshType){case 1:l.setMesh(n.Mesh);break;case 2:l.setLodGroup(n.Mesh),l.loadAllResource()}r=!1}var c=s.getActiveCtrlObj();c.beginAddKey();for(var u=0;u<n.LocInfos.length;++u){var d=n.LocInfos[u],p=Q3D.vector3(d[1],0,d[2]).get();c.addKey(parseFloat(d[0]),p)}return c.endAddKey(),r||(c.setMaxKeyframeBufferSize(0),mapObj._map3d.setActiveCtrlObjListener(c),n.OnActCtrlObjAniEnd&&Q3D.Util.isFunction(n.OnActCtrlObjAniEnd)&&mapObj.attachUIEvent("onActCtrlObjAniEnd",i,n.OnActCtrlObjAniEnd)),c},removeVehicle:function(e){var t=e.split("/"),n=t[0],a=t[t.length-1],o=this.getSceneNode(n,a);if(o){var i=o.getActiveCtrlObj();mapObj._map3d.removeActiveCtrlObjListener(i),mapObj.detachUIEvent("onActCtrlObjAniEnd",a),mapObj.destroySceneNode(n,a)}}}),Q3D.Map.include({getWidgetOffspring:function(e,t){var n=e.getChildren();if(null!==n)for(var a=n.getItemSize();a>0;--a){var o=n.getItem(a-1);t.push(o),this.getWidgetOffspring(o,t)}},getLayoutAllWidgets:function(e){var t=mapObj._map3d.getUISystem(),n=t.getLayout(e),a=null,o=null,i=[];if(null!==n){a=n.getRootWidgets();for(var r=a.getItemSize();r>0;--r)o=a.getItem(r-1),i.push(o),this.getWidgetOffspring(o,i)}return i},setLayoutVisible:function(e,t){var n=mapObj._map3d.getUISystem(),a=n.getLayout(e),o=null,i=null;if(null!==a){o=a.getRootWidgets();for(var r=o.getItemSize();r>0;--r)i=o.getItem(r-1).setVisible(t?1:0);return this}},loadLayout:function(e,t,n,a,o,i,r){var s=mapObj._map3d.getUISystem(),l=s.getLayout(e);if(null===l){var c=[];l=s.loadRootLayout(e,n),c=this.getLayoutAllWidgets(e),c.forEach(function(e){var t=e.asButton();null!==t&&t.getName()&&mapObj._map3d.setUIMouseButtonClickEventListener(t)})}return"number"==typeof a&&"number"==typeof o&&l.getMainWidget().setPosition(a,o),"number"==typeof i&&"number"==typeof r&&l.getMainWidget().setSize(i,r),this.setLayoutVisible(e,t),l},unloadLayout:function(e,t){var n=mapObj._map3d.getUISystem(),a=n.getLayout(e);if(null!==a){var o=[];return o=this.getLayoutAllWidgets(e),o.forEach(function(e){var t=e.asButton();null!==t&&t.getName()&&(mapObj.detachUIEvent("onNotifyMouseButtonClick",t.getName()),mapObj._map3d.removeUIMouseButtonClickEventListener(t))}),"undefined"==typeof t?n.unloadLayout(e):n.fadeout(e,t),this}},alertDialog:function(e,t,n,a){n=n||380,a=a||140;var o=document.documentElement.clientWidth,i=document.documentElement.clientHeight,r={left:o>n?Math.floor((o-n)/2):0,top:i>a?Math.floor((i-a)/2):0,message:"This is a message",dialogTitle:"Alert Dialog"},s=this.loadLayout("_alertDialog",1,"_alertDialog.layout",r.left,r.top),l=s.getWidget("_editBoxMessageADialog").asTextBox(),c=s.getWidget("_windowADialog").asTextBox();return e="undefined"==typeof e?r.message:e,t="undefined"==typeof t?r.dialogTitle:t,l.setCaption(e),c.setCaption(t),this.attachUIEvent("onNotifyMouseButtonClick","_buttonOKADialog",function(e){mapObj.unloadLayout("_mask"),mapObj.unloadLayout("_alertDialog")}),this},confirmDialog:function(e,t,n,a,o,i){o=o||380,i=i||140;var r=document.documentElement.clientWidth,s=document.documentElement.clientHeight,l={left:r>o?Math.floor((r-o)/2):0,top:s>i?Math.floor((s-i)/2):0,message:"This is a message",dialogTitle:"Confirm Dialog"},c=this.loadLayout("_confirmDialog",1,"_confirmDialog.layout",l.left,l.top),u=c.getWidget("_editBoxMessageCDialog").asTextBox(),d=c.getWidget("_windowCDialog").asTextBox();return e="undefined"==typeof e?l.message:e,t="undefined"==typeof t?l.dialogTitle:t,u.setCaption(e),d.setCaption(t),this.attachUIEvent("onNotifyMouseButtonClick","_buttonCancelCDialog",function(e){mapObj.unloadLayout("_confirmDialog"),mapObj.unloadLayout("_mask"),a()&&Q3D.Util.isFunction(a())&&a()}),this.attachUIEvent("onNotifyMouseButtonClick","_buttonOKCDialog",function(e){mapObj.unloadLayout("_confirmDialog"),mapObj.unloadLayout("_mask"),n&&Q3D.Util.isFunction(n)&&n()}),this},promptDialog:function(e,t,n,a,o){a=a||380,o=o||140;var i=document.documentElement.clientWidth,r=document.documentElement.clientHeight,s={left:i>a?Math.floor((i-a)/2):0,top:r>o?Math.floor((r-o)/2):0},l=this.loadLayout("_promptDialog",1,"_promptDialog.layout",s.left,s.top),c=l.getWidget("_textBoxInputTitlePDialog").asTextBox(),u=l.getWidget("_windowPDialog").asTextBox();return c.setCaption(e),u.setCaption(t),this.attachUIEvent("onNotifyMouseButtonClick","_buttonOKPDialog",function(e){var t=mapObj._map3d.getUISystem(),a=t.getLayout("_promptDialog").getWidget("_editBoxInputPDialog").asTextBox().getCaption();mapObj.unloadLayout("_promptDialog"),mapObj.unloadLayout("_mask"),n&&Q3D.Util.isFunction(n)&&n(a)}),this.attachUIEvent("onNotifyMouseButtonClick","_buttonCancelPDialog",function(e){mapObj.unloadLayout("_promptDialog"),mapObj.unloadLayout("_mask")}),this},videoDialog:function(e,t){var n={VideoPath:null,VideoType:Q3D.Enums.videoSourceType.VIDSRC_NETSTREAM,Title:{Text:"",Color:Q3D.colourValue("#000000",1),Height:20},Left:document.documentElement.clientWidth-200,Top:0,Width:200,Height:200,TargetNode:null,TargetPosition:null,AttachNode:null,IsIndicatrixVisible:!0,IndicatrixWidth:2,IndicatrixMatrial:"",IndicatrixLocation:1,OnVideoCtrlClose:null};Q3D.Util.jQueryExtend(!0,n,t);var a=mapObj._map3d.getUISystem(),o=a.createVideoCtrlWithName(e,n.VideoPath,n.VideoType);if(o){o.setTitle(n.Title.Text,n.Title.Color.get(),n.Title.Height),o.setLeftTop(n.Left,n.Top),o.setSize(n.Width,n.Height);var i=!1;return null!=n.TargetNode&&(o.targetNode(n.TargetNode),i=!0),null!=n.TargetPosition&&(o.targetPosition(n.TargetPosition),i=!0),null!=n.AttachNode&&(o.attachNode(n.AttachNode),i=!0),n.IsIndicatrixVisible&&i?(o.setIndicatrixVisible(1),o.setIndicatrixWidth(n.IndicatrixWidth),null!=n.IndicatrixMatrial&&o.setIndicatrixMatrial(n.IndicatrixMatrial),o.setIndicatrixLocation(n.IndicatrixLocation)):o.setIndicatrixVisible(0),null!=n.OnVideoCtrlClose&&(mapObj._map3d.setUIVideoCtrlListener(o),mapObj.attachUIEvent("onVideoCtrlClose",e,n.OnVideoCtrlClose)),this}},removeVideo:function(e){var t=mapObj._map3d.getUISystem(),n=t.getVideoCtrl(e);if(n)return mapObj._map3d.removeUIVideoCtrlListener(n),mapObj.detachUIEvent("onVideoCtrlClose",e),t.removeVideoCtrl(e),this},getVideoCtrl:function(e){var t=mapObj._map3d.getUISystem();return t.getVideoCtrl(e)},setUIBtnState:function(e,t,n){var a=mapObj._map3d.getUISystem(),o=a.getLayout(e);if(null!=o){var i=o.getWidget(t).asButton();i.setStateSelected(n?1:0)}return this},createHtmlWidget:function(e,t){var n={Name:null,BackImageUrl:"",TitleImageUrl:"",HtmlUrl:null,Layout:0,Position:null,Size:null,ClientRectPosition:null,ClientRectSize:null,TitlePosition:null,TitleSize:null,CloseRectPosition:null,CloseRectSize:null,Alpha:1,FadeIn:.5,ZOrder:null,TooltipOptions:{TriFillColor:Q3D.colourValue("#000000",1),TriAlpha:.5,EdgeColor:null,EdgeWidth:0},OnHtmlWidgetClosed:null,OnUserNotify:null};Q3D.Util.jQueryExtend(!0,n,t);try{var a=mapObj._map3d.getExternUIWidgetSys();if(null==a)return null;var o=a.createHtmlWidget(n.Name,n.BackImageUrl,n.TitleImageUrl);if(null!=o){o.setLayout(n.Layout),null!=n.Position&&o.setPos(n.Position.x,n.Position.y),null!=n.Size&&o.setSize(n.Size.x,n.Size.y),null!=n.ClientRectPosition&&o.setClientPos(n.ClientRectPosition.x,n.ClientRectPosition.y),null!=n.ClientRectSize&&o.setClientSize(n.ClientRectSize.x,n.ClientRectSize.y),null!=n.TitlePosition&&o.setTitlePos(n.TitlePosition.x,n.TitlePosition.y),null!=n.TitleSize&&o.setTitleSize(n.TitleSize.x,n.TitleSize.y),null!=n.Alpha&&"number"==typeof n.Alpha&&o.setAlpha(n.Alpha),null!=n.FadeIn&&"number"==typeof n.FadeIn&&o.fadeIn(n.FadeIn),null!=n.ZOrder&&"number"==typeof n.ZOrder&&o.setZOrder(n.ZOrder),null!=n.CloseRectPosition&&null!=n.CloseRectSize&&o.setCloseRect(n.CloseRectPosition.x,n.CloseRectPosition.y,n.CloseRectSize.x,n.CloseRectSize.y),null!=n.HtmlUrl&&"string"==typeof n.HtmlUrl&&o.setHtml(n.HtmlUrl),o.setAutoUpdate(1),o.setReceiveInput(1);var i=this.getSceneNode(e);if(null!=i){var r=o.asTooltipWidget();r.setTriFillColor(n.TooltipOptions.TriFillColor.get()),r.setTriAlpha(n.TooltipOptions.TriAlpha),r.setEdgeWidth(n.TooltipOptions.EdgeWidth),n.TooltipOptions.EdgeWidth>0&&null!=n.TooltipOptions.EdgeColor&&r.setEdgeColor(n.TooltipOptions.EdgeColor.get()),r.createRectLinks(0,0,n.Size.x,n.Size.y),r.setAutoObserveObj(i)}setTimeout(function(){Q3D.Util.isFunction(n.OnHtmlWidgetClosed)&&mapObj.attachUIEvent("onWidgetClose",n.Name,n.OnHtmlWidgetClosed),Q3D.Util.isFunction(n.OnUserNotify)&&mapObj.attachUIEvent("onUserNotifyEX",n.Name,n.OnUserNotify)},100)}return o}catch(e){return null}},createImageWidget:function(e,t){var n={ImageUrl:"",LeftTop:Q3D.vector2(0,0),Size:Q3D.vector2(300,200),Alpha:1,ZOrder:1,FadeIn:.5,Visible:!0,LoadingOptions:{ImageUrl:"",FrameClip:Q3D.vector2(2,2),Interval:.2},VideoOptions:{VideoPath:"",VideoType:Q3D.Enums.videoSourceType.VIDSRC_NETSTREAM,IsLoop:!0}};Q3D.Util.jQueryExtend(!0,n,t);try{var a=this._map3d.getWorldManager().getUIWindowSys(0),o=a.getWidget(e);o||(o=a.createImageWidget(e));var i=o.asImageWidget();if(""!=n.ImageUrl&&i.setImage(n.ImageUrl),i.setMarginLeft(n.LeftTop.x),i.setMarginTop(n.LeftTop.y),i.setLayoutWidth(n.Size.x),i.setLayoutHeight(n.Size.y),i.setAlpha(n.Alpha),i.setVisible(n.Visible?1:0),i.setZOrder(n.ZOrder),i.fadeIn(n.FadeIn),""!=n.VideoOptions.VideoPath){if(""!=n.LoadingOptions.ImageUrl){i.setImage(n.LoadingOptions.ImageUrl);var r=i.getMaterial(),s=r.getTextureUnit(Q3D.Enums.textureUnit.DIFFUSE);s.setFrameXClip(n.LoadingOptions.FrameClip.x),s.setFrameYClip(n.LoadingOptions.FrameClip.y),s.setFrameInterval(n.LoadingOptions.Interval)}var l=e+"_videoSrc",c=this._map3d.getResourceManager(),u=c.getResource(Q3D.Enums.resourceType.VIDEO,l);null==u?(u=c.registerResource(Q3D.Enums.resourceType.VIDEO,l).asVideo(),u.createEmpty()):(u=u.asVideo(),u.stop()),u.setVideoSource(n.VideoOptions.VideoPath,n.VideoOptions.VideoType),u.setWidth(n.Size.x),u.setHeight(n.Size.y),u.setAutoPlay(1),u.setLoop(n.VideoOptions.IsLoop?1:0),u.play();var r=i.getMaterial(),s=r.getTextureUnit(Q3D.Enums.textureUnit.DIFFUSE);s.setVideo(l,1)}return i}catch(e){return null}},createTooltipWidget:function(e,t){var n={Name:null,Layout:0,Position:null,Size:Q3D.vector2(1,1),Alpha:1,FadeIn:.5,ZOrder:null,TooltipOptions:{TriFillColor:Q3D.colourValue("#000000",1),TriAlpha:.5,EdgeColor:null,EdgeWidth:0}};Q3D.Util.jQueryExtend(!0,n,t);try{var a=mapObj._map3d.getWorldManager().getUIWindowSys(0);if(null==a)return null;var o=a.createTooltipWidget(n.Name);if(null!=o){if(null!=n.Position)switch(n.Layout){case 0:o.setMarginLeft(n.Position.x),o.setMarginTop(n.Position.y);break;case 1:o.setMarginRight(n.Position.x),o.setMarginTop(n.Position.y);break;case 2:o.setMarginLeft(n.Position.x),o.setMarginBottom(n.Position.y);break;case 3:o.setMarginRight(n.Position.x),o.setMarginBottom(n.Position.y)}null!=n.Size&&(o.setLayoutWidth(n.Size.x),o.setLayoutHeight(n.Size.y)),null!=n.Alpha&&"number"==typeof n.Alpha&&o.setAlpha(n.Alpha),null!=n.FadeIn&&"number"==typeof n.FadeIn&&o.fadeIn(n.FadeIn),null!=n.ZOrder&&"number"==typeof n.ZOrder&&o.setZOrder(n.ZOrder),o.setVisible(1);var i=this.getSceneNode(e);null!=i&&(o.setTriFillColor(n.TooltipOptions.TriFillColor.get()),o.setTriAlpha(n.TooltipOptions.TriAlpha),o.setEdgeWidth(n.TooltipOptions.EdgeWidth),n.TooltipOptions.EdgeWidth>0&&null!=n.TooltipOptions.EdgeColor&&o.setEdgeColor(n.TooltipOptions.EdgeColor.get()),o.createRectLinks(0,0,n.Size.x,n.Size.y),o.setAutoObserveObj(i))}return o}catch(e){return null}},removeHtmlWidget:function(e){var t=mapObj._map3d.getExternUIWidgetSys();return null!=t&&t.destroyWidget(e),this},removeTooltipWidget:function(e){var t=mapObj._map3d.getWorldManager().getUIWindowSys(0);return t.destroyTooltipWidget(e),this},removeImageWidget:function(e){var t=mapObj._map3d.getWorldManager().getUIWindowSys(0);return t.destroyWidget(e),this},createHtmlWidgetToTexture:function(e){var t={Name:null,HtmlUrl:null,Size:null,Material:null};Q3D.extend(t,e);try{var n=this._map3d.getExternUIWidgetSys();if(null==n)return null;var a=this._map3d.getResourceManager(),o=a.getResource(Q3D.Enums.resourceType.MATERIAL,t.Material);null==o?(o=a.registerResource(Q3D.Enums.resourceType.MATERIAL,t.Material).asMaterial(),o.createEmpty()):o=o.asMaterial();var i=Q3D.colourValue(1,1,1,1);o.setDiffuseColor(i.get());var r=o.getTextureUnit(Q3D.Enums.textureUnit.DIFFUSE),s=n.createHtmlTextureWidget(t.Name,r,t.Size.x,t.Size.y);return null!=s&&(s.setAutoUpdate(1),s.setHtml(t.HtmlUrl),s.setReceiveInput(0)),s}catch(e){return null}},createUILayoutToTexture:function(e){var t={Name:null,FileName:null,RTTName:null,Material:null,UIOptions:{AlphaBlend:!0,Alpha:1,DepthCheck:!0,BackCull:!1}};Q3D.Util.jQueryExtend(!0,t,e);try{var n=this.loadLayout(t.Name,!0,t.FileName,0,0);if(null==n)return null;var a=this._map3d.getResourceManager(),o=a.getResource(Q3D.Enums.resourceType.MATERIAL,t.Material);null==o?(o=a.registerResource(Q3D.Enums.resourceType.MATERIAL,t.Material).asMaterial(),o.createEmpty()):o=o.asMaterial();var i=Q3D.colourValue(1,1,1,1);o.setDiffuseColor(i.get());var r=o.getTextureUnit(Q3D.Enums.textureUnit.DIFFUSE);return r.setTexture(t.RTTName,0),o.setAlphaBlendEnable(t.UIOptions.AlphaBlend?1:0),t.UIOptions.AlphaBlend&&o.setAlpha(t.UIOptions.Alpha),o.setDepthCheck(t.UIOptions.DepthCheck?1:0),o.setCullMode(t.UIOptions.BackCull?2:1),n}catch(e){return null}},createIRHeatmap:function(e,t){var n={GridSize:Q3D.vector2(80,80),HeatPoints:[],Range:10,ColorBandKey:[],ColorBandValue:[],BaseHeight:0,IsContinuousColor:!0,IsPlane:!0,AlgType:Q3D.Enums.heatMapCalcType.SquaredWeighted,BorderPoints:[]};Q3D.Util.jQueryExtend(!0,n,t);try{var a=mapObj._map3d.getHeatMapManager(),o=a.getHeatMapByID(e);null!=o&&a.destoryHeatMapByID(e),o=a.createHeatMap(e,3).asHeatMapIrregular(),o.setNxNz(n.GridSize.x,n.GridSize.y);var i;for(i=0;i<n.HeatPoints.length;i++){var r=e+"_pi_"+i;o.addPoint(n.HeatPoints[i].get(),n.Range,r)}for(i=0;i<n.ColorBandKey.length;i++)o.addColorBand(n.ColorBandKey[i],n.ColorBandValue[i].get());o.setUseContinuousColor(n.IsContinuousColor?1:0),o.setHeight(n.BaseHeight),o.setScapple(n.IsPlane?1:0),o.setAlgType(n.AlgType),o.build();var s=mapObj._map3d.getWorldManager().createEmptyQVector3List();for(i=0;i<n.BorderPoints.length;i++)s.add(n.BorderPoints[i].get());return n.BorderPoints.length>0&&(o.setBorderPoints(s),o.render()),o}catch(e){return null}}}),Q3D.Map.include({_restoreModelMaterial:function(e){var t=this.getSceneNode(e);if(null==t)return null;var n=t.getNodeType();if(n!=Q3D.Enums.sceneNodeType.SNODE_Model&&n!=Q3D.Enums.sceneNodeType.SNODE_VecModel)return null;var a=null;return a=n==Q3D.Enums.sceneNodeType.SNODE_Model?t.asModel():t.asVecModel(),a.restoreAloneMaterials(),this},createSimpleMaterial:function(e,t){var n={DiffuseColor:null,EmissiveColor:null,SpecularColor:null,Alpha:null};Q3D.extend(n,t);var a=this._map3d.getResourceManager(),o=a.getResource(Q3D.Enums.resourceType.MATERIAL,e);return null!=o?o:(o=a.registerResource(Q3D.Enums.resourceType.MATERIAL,e).asMaterial(),o.createEmpty(),o.setShadowFactor(1),o.setLightEnable(1),n.DiffuseColor&&o.setDiffuseColor(n.DiffuseColor.get()),n.SpecularColor&&o.setSpecularColor(n.SpecularColor.get()),n.EmissiveColor&&(o.setEmissiveColor(n.EmissiveColor.get()),o.setDiffuseColor(Q3D.colourValue("#000000",1).get()),o.setLightEnable(0)),n.Alpha&&n.Alpha<1&&(o.setAlphaBlendEnable(1),o.setAlpha(n.Alpha),o.setDepthWriteEnable(0)),o)},createModel:function(e,t,n){var a={Position:null,Orientation:null,OrientationType:Q3D.Enums.nodeOrientationType.Self,Scale:null,SkeletonAnimation:null,OnLoaded:null};Q3D.extend(a,n);try{var o=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_Model);if(null!=o){a.OnLoaded&&(mapObj._map3d.setSceneNodeListener(o),mapObj.attachUIEvent("onSceneNodeAllResourceCompleted",mapObj.getSceneNodeFullName(o),a.OnLoaded)),o.trackAllResource();var i=o.asModel();return i.setMesh(t),null!=a.Position&&i.setPosition(a.Position.get()),null!=a.Orientation&&i.setOrientation(a.Orientation.get(),a.OrientationType),null!=a.Scale&&i.setScale(a.Scale.get()),null!=a.SkeletonAnimation&&i.setSkeletonAnimation(a.SkeletonAnimation),i}}catch(e){return this.showNotice("错误","createModel: "+e.message),null}return null},playModelSkeletonAnimation:function(e,t){var n=this.getSceneNode(e);if(null==n||n.getNodeType()!=Q3D.Enums.sceneNodeType.SNODE_Model)return null;var a=n.asModel();t!==undefined&&(a.setSkeletonAnimation(t),a.loadAllResource());var o=a.getSkeletonAnimationState();return null==o?null:(o.setLoop(1),o.setAutoPlay(1),o.play(),this)},stopModelSkeletonAnimation:function(e){var t=this.getSceneNode(e);if(null==t||t.getNodeType()!=Q3D.Enums.sceneNodeType.SNODE_Model)return null;var n=t.asModel(),a=n.getSkeletonAnimationState();return null==a?null:(a.stop(),this)},setModelHighlight:function(e,t){var n=this.getSceneNode(e);if(null==n)return null;var a=n.getNodeType();if(a!=Q3D.Enums.sceneNodeType.SNODE_Model&&a!=Q3D.Enums.sceneNodeType.SNODE_VecModel)return null;var o=a==Q3D.Enums.sceneNodeType.SNODE_Model?n.asModel():n.asVecModel();o.makeAloneMaterialsEx(2);for(var i=0;i<=o.getMaterialCount()-1;i++)t?o.getMaterial(i).setEmissiveColor(Q3D.colourValue(1,0,1,1).get()):o.getMaterial(i).setEmissiveColor(Q3D.colourValue(0,0,0,0).get());return t||o.restoreAloneMaterials(),this},setModelColor:function(e,t,n){var a="model_color_"+t.toWebColor(),o=Q3D.nodeContainer(a);return o.setTargetVal(Q3D.Enums.nodeContainerType.Color,t),n?o.addSceneNode(e):o.removeSceneNode(e),this},clearModelsColor:function(e){return Q3D.Util.isArray(e)?(e.forEach(function(e){var t="model_color_"+e.toWebColor();Q3D.nodeContainer(t).clear(),mapObj._map3d.getWorldManager().destroyContainer(t)}),this):null},setBatchModelMaterial:function(e,t){if(!Q3D.Util.isArray(e)||"string"!=typeof e[0])return null;var n=Q3D.nodeContainer("model_with_"+t);n.setTargetVal(Q3D.Enums.nodeContainerType.Material,t);for(var a=0;a<e.length;a++)n.addSceneNode(e[a]);return this},clearBatchModelMaterial:function(e){return Q3D.nodeContainer("model_with_"+e).clear(),mapObj._map3d.getWorldManager().destroyContainer("model_with_"+e),this},setBatchModelColorFlash:function(e,t,n,a,o){if(!Q3D.Util.isArray(e)||"string"!=typeof e[0])return null;"undefined"==typeof this._clrFlashObj&&(this._clrFlashObj=[]),this.clearBatchModelColorFlash(e);for(var i=50,r=0;r<e.length;r++){var s=this.getSceneNode(e[r]);if(null!=s){this._clrFlashObj.push(e[r]);var l=Q3D.movieClip(e[r].replace("/","@^")+"_colorFlashMovieclip",i),c=Q3D.movieClipInstance(e[r].replace("/","@^")+"_colorFlashInstance",l);o===undefined?(c.setMaterialColorFlashPlayer(s,t,a,1,n),c.setPlayOptions(0,!0),c.play()):(c.setMaterialColorFlashPlayer(s,t,a,o,n),c._clearMovieClipInstanceOnLastFrame(i*a*o*2,function(e,t){for(var n=e.getCName(),a=n.substring(0,n.length-19).replace("@^","/"),o=0;o<mapObj._clrFlashObj.length;o++)a===mapObj._clrFlashObj[o]&&(mapObj._restoreModelMaterial(mapObj._clrFlashObj[o]),mapObj._clrFlashObj.splice(o,1))}),c.setPlayOptions(0,!1),c.play())}}return this},clearBatchModelColorFlash:function(e){if("undefined"==typeof this._clrFlashObj||0==this._clrFlashObj.length)return null;if("undefined"==typeof e){for(var t=0;t<this._clrFlashObj.length;t++){var n=this._clrFlashObj[t],a=n.replace("/","@^")+"_colorFlashInstance";this._restoreModelMaterial(n),this.clearMovieClip(a,0,!1)}delete this._clrFlashObj}else{if(!Q3D.Util.isArray(e)||"string"!=typeof e[0])return null;for(var o=0;o<e.length;o++)for(var i=e[o],t=0;t<this._clrFlashObj.length;t++)if(i===this._clrFlashObj[t]){this._restoreModelMaterial(i),this.clearMovieClip(i.replace("/","@^")+"_colorFlashInstance",0,!1),this._clrFlashObj.splice(t,1);break}}return this},setBatchModelTransparentFlash:function(e,t,n){if(!Q3D.Util.isArray(e)||"string"!=typeof e[0])return null;"undefined"==typeof this._transFlashObj&&(this._transFlashObj=[]),this.clearBatchModelTransparentFlash(e);for(var a=50,o=0;o<e.length;o++){var i=this.getSceneNode(e[o]);if(null!=i){this._transFlashObj.push(e[o]);var r=Q3D.movieClip(e[o].replace("/","@^")+"_transparentFlashMovieclip",a),s=Q3D.movieClipInstance(e[o].replace("/","@^")+"_transparentFlashInstance",r);n==undefined?(s.setMaterialFadePlayer(i,Q3D.Enums.fadeType.fadeFlash,t,1),s.setPlayOptions(0,!0),s.play()):(s.setMaterialFadePlayer(i,Q3D.Enums.fadeType.fadeFlash,t,n),s._clearMovieClipInstanceOnLastFrame(a*t*n*2,function(e,t){for(var n=e.getCName(),a=n.substring(0,n.length-25).replace("@^","/"),o=0;o<mapObj._transFlashObj.length;o++)a===mapObj._transFlashObj[o]&&(mapObj._restoreModelMaterial(mapObj._transFlashObj[o]),mapObj._transFlashObj.splice(o,1))}),s.setPlayOptions(0,!1),s.play())}}return this},clearBatchModelTransparentFlash:function(e){if("undefined"==typeof this._transFlashObj||0==this._transFlashObj.length)return null;if("undefined"==typeof e){for(var t=0;t<this._transFlashObj.length;t++){var n=this._transFlashObj[t],a=n+"_transparentFlashInstance";this._restoreModelMaterial(n),this.clearMovieClip(a,0,!1)}delete this._transFlashObj}else{if(!Q3D.Util.isArray(e)||"string"!=typeof e[0])return null;for(var o=0;o<e.length;o++)for(var i=e[o],t=0;t<this._transFlashObj.length;t++)if(i===this._transFlashObj[t]){this._restoreModelMaterial(i),this.clearMovieClip(i.replace("/","@^")+"_transparentFlashInstance",0,!1),this._transFlashObj.splice(t,1);break}}return this},setModelFadeIn:function(e,t,n){var a=this.getSceneNode(e);if(null==a)return null;var o=a.getNodeType();o==Q3D.Enums.sceneNodeType.SNODE_Model?a.asModel().setCastShadow(1):a.asVecModel().setCastShadow(1);var i=Q3D.movieClip(e.replace("/","@^")+"_fadeInMovieclip",50),r=Q3D.movieClipInstance(e.replace("/","@^")+"_fadeInInstance",i);return r.setMaterialFadePlayer(a,Q3D.Enums.fadeType.fadeIn,t,1),r.onMovieClipInstancePassFrame(50*t,function(e,t){var a=e.getCName();setTimeout(function(){if(mapObj.clearMovieClip(a,t,!1),n){var e=a.substring(0,a.length-15);mapObj._restoreModelMaterial(e.replace("@^","/"))}},100)}),r.setPlayOptions(0,!1),r.play(),this},setModelFadeOut:function(e,t,n){var a=this.getSceneNode(e);if(null==a)return null;var o=a.getNodeType();o==Q3D.Enums.sceneNodeType.SNODE_Model?a.asModel().setCastShadow(0):a.asVecModel().setCastShadow(0);var i=Q3D.movieClip(e.replace("/","@^")+"_fadeOutMovieclip",50),r=Q3D.movieClipInstance(e.replace("/","@^")+"_fadeOutInstance",i);return r.setMaterialFadePlayer(a,Q3D.Enums.fadeType.fadeOut,t,1),r.onMovieClipInstancePassFrame(50*t,function(e,t){var a=e.getCName();setTimeout(function(){if(mapObj.clearMovieClip(a,t,!1),n){var e=a.substring(0,a.length-16);mapObj._restoreModelMaterial(e.replace("@^","/"))}},100)}),r.setPlayOptions(0,!1),r.play(),this},proportionHeightStretching:function(e,t,n){var a={StartHeightScale:null,EndHeightScale:1,Duration:5,OnAnimationEnd:null};Q3D.Util.jQueryExtend(!0,a,n);var o=this.getSceneNode(e);if(null==o)return null;var i={Translate:o.getPosition(),Rotate:o.getOrientation(1),Scale:o.getScale(1)};o.setNodeAnimationName("");var r=this._map3d.getResourceManager(),s=r.getResource(Q3D.Enums.resourceType.ANINODE,t);null==s?(s=r.registerResource(Q3D.Enums.resourceType.ANINODE,t).asNodeAnimation(),s.createEmpty()):(s=s.asNodeAnimation(),s.removeAllKeyframes());var l=Q3D.vector3(i.Scale);a.StartHeightScale&&(l=Q3D.vector3(1,a.StartHeightScale,1),o.setScale(l.get()));var c=Q3D.vector3(l.x,l.y*a.EndHeightScale,l.z);s.addKeyframe(i.Translate,i.Rotate,l.get(),0),s.addKeyframe(i.Translate,i.Rotate,c.get(),a.Duration),s.setLineType(0,0,1),o.setNodeAnimationName(t),o.setAlwaysHoldResource(1),o.loadAllResource();var u=o.getNodeAnimationState();return u.setAutoPlay(1),u.play(),Q3D.Util.isFunction(a.OnAnimationEnd)&&(mapObj._map3d.setOnAnimationEndListener(u),mapObj.on("onAnimationEnd",a.OnAnimationEnd)),s}}),Q3D.Map.include({createPOI:function(e,t){var n={Position:null,Orientation:null,OrientationType:Q3D.Enums.nodeOrientationType.Self,Scale:null,POIOptions:{FontSize:20,FontName:"宋体",FontColor:Q3D.colourValue("#000000",1),CharScale:1,Text:null,Icon:null,IconSize:null,POILayout:Q3D.Enums.poiLayOut.Left,POILayoutCustom:null,UIType:Q3D.Enums.poiUIType.CameraOrientedKeepSize,IconAlphaEnabled:!0,FontOutLine:null,FontEdgeColor:null,AlphaTestRef:null,Location:Q3D.Enums.poiImagePositionType.POI_LOCATE_BOTTOM,LocationOffset:null,BackFrameBorderSize:null,BackBorderColor:null,BackFillColor:null,LabelMargin:null,IconLabelMargin:null,SpecialTransparent:!0,AlwaysOnScreen:!1,AbsPriority:null,RelPriority:null},OnLoaded:null};Q3D.Util.jQueryExtend(!0,n,t);try{var a=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_POI);if(null!=a){n.OnLoaded&&(mapObj._map3d.setSceneNodeListener(a),mapObj.attachUIEvent("onSceneNodeAllResourceCompleted",mapObj.getSceneNodeFullName(a),n.OnLoaded)),a.trackAllResource();var o=a.asPOI();return null!=n.Position&&o.setPosition(n.Position.get()),null!=n.Orientation&&o.setOrientation(n.Orientation.get(),n.OrientationType),null!=n.Scale&&o.setScale(n.Scale.get()),o.setFontName(n.POIOptions.FontName),o.setFontSize(n.POIOptions.FontSize),o.setFontColor(n.POIOptions.FontColor.revise().get()),o.setCharScale(n.POIOptions.CharScale),
null!=n.POIOptions.FontOutLine&&(o.setFontOutLine(n.POIOptions.FontOutLine),null!=n.POIOptions.FontEdgeColor&&o.setFontEdgeColor(n.POIOptions.FontEdgeColor.revise().get())),null!=n.POIOptions.Text?o.setText(n.POIOptions.Text):o.setText(e.split("/")[1]),null!=n.POIOptions.Icon&&o.setIcon(n.POIOptions.Icon),null!=n.POIOptions.IconSize&&o.setIconSize(n.POIOptions.IconSize.get()),o.setPOILayout(n.POIOptions.POILayout),n.POIOptions.POILayout>=Q3D.Enums.poiLayOut.LeftCustom&&n.POIOptions.POILayout<=Q3D.Enums.poiLayOut.BottomCustom&&null!=n.POIOptions.POILayoutCustom&&o.setPOILayoutCustom(n.POIOptions.POILayoutCustom),o.setUIType(n.POIOptions.UIType),o.setIconAlphaEnabled(n.POIOptions.IconAlphaEnabled),null!=n.POIOptions.AlphaTestRef&&o.setAlphaTestRef(n.POIOptions.AlphaTestRef),n.POIOptions.Location==Q3D.Enums.poiImagePositionType.POI_LOCATE_CUSTOM&&null!=n.POIOptions.LocationOffset?(o.setLocation(Q3D.Enums.poiImagePositionType.POI_LOCATE_CUSTOM),o.setLocationOffset(n.POIOptions.LocationOffset.get())):o.setLocation(n.POIOptions.Location),null!=n.POIOptions.BackFrameBorderSize&&(o.showBackFrame(1),o.setBackFrameBorderSize(n.POIOptions.BackFrameBorderSize),null!=n.POIOptions.BackBorderColor&&o.setBackBorderColor(n.POIOptions.BackBorderColor.revise().get())),null!=n.POIOptions.BackFillColor&&o.setBackFillColor(n.POIOptions.BackFillColor.revise().get()),null!=n.POIOptions.LabelMargin&&o.setLabelMargin(n.POIOptions.LabelMargin.get()),null!=n.POIOptions.IconLabelMargin&&o.setIconLabelMargin(n.POIOptions.IconLabelMargin.get()),n.POIOptions.SpecialTransparent&&o.setSpecialTransparent(n.POIOptions.SpecialTransparent?1:0),n.POIOptions.AlwaysOnScreen&&o.setAlwaysOnScreen(n.POIOptions.AlwaysOnScreen?1:0),Q3D.Util.isInteger(n.POIOptions.AbsPriority)&&o.setAbsPriority(n.POIOptions.AbsPriority),Q3D.Util.isInteger(n.POIOptions.RelPriority)&&o.setRelPriority(n.POIOptions.RelPriority),o}}catch(e){return this.showNotice("错误","createPOI: "+e.message),null}return null},setBatchPOIJump:function(e,t,n,a){this._poiJumpObj&&this.clearPOIJump(),this._poiJumpObj=[];var o=50;a=a||1;for(var i=Q3D.movieClip("poi_jump_movieclip",o),r=0;r<e.length;r++){var s=this.getSceneNode(e[r]);if(null!=s&&s.getNodeType()==Q3D.Enums.sceneNodeType.SNODE_POI){var l=s.asPOI();this._poiJumpObj.push(e[r]);var c=Q3D.movieClipInstance(e[r].replace("/","@^")+"_poiJumpInstance",i),u=Q3D.vector3(l.getPosition()),d=Q3D.vector3(u.x,u.y+t,u.z),p=[{Key:0,Pos:u},{Key:a*o/2,Pos:d},{Key:a*o,Pos:u}];if(n!=undefined)for(var m=2;m<2*n;m++){var h={};h.Key=(m+1)*a*o/2,h.Pos=m%2==0?d:u,p.push(h)}if(i.addActorTranslateAnimation("poi_jump_ani_"+r,p),c.setTransformPlayer("poi_jump_ani_"+r,l),n==undefined)c.setPlayOptions(0,!0),c.play();else{var y=p[p.length-1].Key;c._clearMovieClipInstanceOnLastFrame(y),c.setPlayOptions(0,!1),c.play()}}}return this},setBatchPOIGravityJump:function(e,t){for(var n=t,a=n/7,o=n/35,i=n/105,r=1/2.28917,s=2*n/(r*r),l=Math.sqrt(2*a/s),c=Math.sqrt(2*o/s),u=Math.sqrt(2*i/s),d=50,p=Q3D.movieClip("poi_gravity_jump_movieclip",d),m=0;m<e.length;m++){var h=this.getSceneNode(e[m]);if(null!=h&&h.getNodeType()==Q3D.Enums.sceneNodeType.SNODE_POI){var y=h.asPOI(),g=this.guid(),f=Q3D.movieClipInstance("poi_gravity_jump_instance_"+g,p),E=Q3D.vector3(y.getPosition()),T=Q3D.vector3(E.x,E.y+n,E.z),O=Q3D.vector3(E.x,E.y+a,E.z),D=Q3D.vector3(E.x,E.y+o,E.z),v=Q3D.vector3(E.x,E.y+i,E.z),_=[{Key:0,Pos:T},{Key:r*d,Pos:E},{Key:(r+l)*d,Pos:O},{Key:(r+2*l)*d,Pos:E},{Key:(r+2*l+c)*d,Pos:D},{Key:(r+2*l+2*c)*d,Pos:E},{Key:(r+2*l+2*c+u)*d,Pos:v},{Key:d,Pos:E}];p._addActorTranslateGravityAnimation("poi_gravity_ani_"+g,_),f.setTransformPlayer("poi_gravity_ani_"+g,y),f._clearMovieClipInstanceOnLastFrame(d),f.setPlayOptions(0,!1),f.play()}}return this},clearPOIJump:function(){if(!this._poiJumpObj)return null;for(var e=mapObj._map3d.getWorldManager(),t=0;t<this._poiJumpObj.length;t++){var n=this._poiJumpObj[t],a=n.replace("/","@^")+"_poiJumpInstance";this.clearMovieClip(a,0,!0)}return e.destroyMovieClip("poi_jump_movieclip"),delete this._poiJumpObj,this},setPOIColorAni:function(e,t,n,a,o){var i=this.getSceneNode(e);if(null==i||i.getNodeType()!=Q3D.Enums.sceneNodeType.SNODE_POI)return null;var r=i.asPOI();return o=o||!1,r.setAlwaysOnScreen(1),r.getText()&&(r.enableFontColorAni(1),r.setFontColorAni(a,t.get(),n.get(),o?1:0)),r.getIcon()&&(r.enableIconColorAni(1),r.setIconColorAni(a,t.get(),n.get(),o?1:0)),this},clearPOIColorAni:function(e){var t=this.getSceneNode(e);if(null==t||t.getNodeType()!=Q3D.Enums.sceneNodeType.SNODE_POI)return null;var n=t.asPOI();return n.setAlwaysOnScreen(0),n.getText()&&n.enableFontColorAni(0),n.getIcon()&&n.enableIconColorAni(0),this}}),Q3D.Map.include({enableCullPlane:function(e,t){var n={VMin:null,VMax:null,MeshHeight:7.5,HandlerMesh:"Mesh/lxlan.mesh",MeshScale:Q3D.vector3(1,1,1)};Q3D.extend(n,t);try{var a=this.getArea(e);if(null==a)return null;if(null==n.VMin||null==n.VMax){var o=Q3D.vector3(0,0,0).get(),i=Q3D.vector3(0,0,0).get();a.getAABB(0,o,i),n.VMin=Q3D.vector3(o),n.VMax=Q3D.vector3(i)}this._map3d.createCullPlanes(e,n.VMin.get(),n.VMax.get(),n.MeshHeight,n.HandlerMesh,n.MeshScale.get()),this._cullMode=!1,this.attachMouseEvent("OnLButtonDown","_startCullPlanes",function(e){var t=this._map3d.getInputManager();null!=e.NearestNode&&(e.NearestNode.showAux(0,0),"Handler"==e.NearestNode.getAlias()&&(this._cullMode=!0,t.sendActionMsg(Q3D.Enums.actionType.OBJECTSELECT_MOVAUX,Q3D.Enums.actionMsg.SWITCH_USAGE,0,0),t.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.LBUTTON,Q3D.Enums.actionType.OBJECTSELECT_MOVAUX)))}.bind(this)),this.attachMouseEvent("OnLButtonUp","_endCullPlanes",function(e){this._cullMode&&this._map3d.updateCullPlanes(),this._cullMode=!1;var t=this._map3d.getInputManager();t.bindControlAction(Q3D.Enums.device.MOUSE,Q3D.Enums.mouse.LBUTTON,Q3D.Enums.actionType.TRANS_SCENE),t.sendActionMsg(Q3D.Enums.actionType.OBJECTSELECT_MOVAUX,Q3D.Enums.actionMsg.SWITCH_USAGE,1,0)}.bind(this)),this.attachMouseEvent("OnMouseMove","_updateCullPlanes",function(e){this._cullMode&&this._map3d.updateCullPlanes()}.bind(this))}catch(e){return this.showNotice("错误","enableCullPlane: "+e.message),null}return this},disableCullPlane:function(){return this._map3d.destroyCullPlanes(),this.detachMouseEvent("OnLButtonDown","_startCullPlanes"),this.detachMouseEvent("OnLButtonUp","_endCullPlanes"),this.detachMouseEvent("OnMouseMove","_updateCullPlanes"),this},enableLaserDistance:function(e){return e||(e=Q3D.colourValue("#ff0000",1)),this._rulerColor=e,this.attachMouseEvent("OnLButtonDown","_laserDist",function(e){var t=Q3D.vector2I(e.logX,e.logY).get();this._map3d.getLaserDist(t,this._rulerColor.get())}.bind(this)),this},enableRulerDistance:function(e){return e||(e=Q3D.colourValue("#ff0000",1)),this._rulerColor=e,this._rulerStatus=1,this.attachMouseEvent("OnLButtonDown","_rulerDist",function(e){var t=Q3D.vector2I(e.logX,e.logY).get();1==this._rulerStatus?(this._map3d.setRulerDistStart(t,this._rulerColor.get(),-1),this._rulerStatus=2):2==this._rulerStatus&&(this._map3d.rulerDist(t,-1),this._rulerStatus=1)}.bind(this)),this.attachMouseEvent("OnMouseMove","_rulerDist",function(e){var t=Q3D.vector2I(e.logX,e.logY).get();2==this._rulerStatus&&this._map3d.rulerDist(t,-1)}.bind(this)),this},drawPolyline:function(e,t){var n={Material:null,Color:Q3D.colourValue("#FF0000",1),Alpha:1,LineWidth:2,POIOptions:{Icon:null,IconSize:null,FontSize:16,FontName:"宋体",FontColor:Q3D.colourValue("#FFFFFF",1),FontEdgeColor:Q3D.colourValue("#000000",1),FontOutLine:1},ShowDistance:!0};Q3D.Util.jQueryExtend(!0,n,t);var a="_rulerPolylinesAndPOI",o=e+"/"+a,i=this.getSceneNode(e,a);i||(i=this.getArea(e).createTopNode(Q3D.Enums.sceneNodeType.SNODE_Group,a));var r="_rulerPolyline"+this.guid(),s=o+"/"+r,l=this.createCommonNode(s,Q3D.Enums.sceneNodeType.SNODE_Line);if(!l)return null;var c=l.asLine();if(null!=n.Material)c.setMaterial(n.Material);else{var u="defaultMaterialForLine-"+this.guid(),d=this._map3d.getResourceManager().getResource(Q3D.Enums.resourceType.MATERIAL,u);null==d?d=this.createSimpleMaterial(u,{Alpha:n.Alpha,EmissiveColor:n.Color}):(d=d.asMaterial(),d.setAlpha(n.Alpha),d.setEmissiveColor(n.Color.get())),c.setMaterial(u)}this.detachMouseEvent("OnLButtonDown","_drawRulerPolyline"),this.detachMouseEvent("OnMouseMove","_drawRulerPolyline"),this.detachMouseEvent("OnRButtonDblClk","_drawRulerPolyline"),this.detachMouseEvent("OnRButtonDown","_drawRulerPolyline"),this._drawPolyLineStatus=0,this.attachMouseEvent("OnLButtonDown","_drawRulerPolyline",function(t){if(null!=t.GroundCoord){var a=mapObj.getArea(e),i=a.toLocalPos(t.GroundCoord),r={Position:null,POIOptions:{Icon:n.POIOptions.Icon,IconSize:n.POIOptions.IconSize,Text:"",FontSize:n.POIOptions.FontSize,FontName:n.POIOptions.FontName,FontColor:n.POIOptions.FontColor,UIType:Q3D.Enums.poiUIType.CameraOrientedKeepSize,POILayout:Q3D.Enums.poiLayOut.Left,Location:Q3D.Enums.poiImagePositionType.POI_LOCATE_VCENTER,FontOutLine:n.POIOptions.FontOutLine,FontEdgeColor:n.POIOptions.FontEdgeColor,AlwaysOnScreen:!0}};switch(mapObj._drawPolyLineStatus){case 0:c.setPosition(i),mapObj._currentLine=null;case 1:mapObj._currentLine=c.addLine();var s=mapObj._currentLine;s.setLineType(0),s.setLineWidth(n.LineWidth);var l=Q3D.vector3(i),u=Q3D.vector3(c.getPosition());l.subtract(u),s.addPoint(l.get()),s.addPoint(l.get()),mapObj._poiParentName="_rulerPOIParent"+mapObj.guid(),mapObj.createCommonNode(o+"/"+mapObj._poiParentName,Q3D.Enums.sceneNodeType.SNODE_Group),r.Position=Q3D.vector3(i),n.ShowDistance&&(r.POIOptions.Text="起点"),r.POIOptions.AlwaysOnScreen=!0,mapObj.createPOI(e+"/"+mapObj._poiParentName+"/_rulerPOI"+mapObj.guid(),r),r.Position=Q3D.vector3(i),r.POIOptions.Text="右键双击结束",r.POIOptions.AlwaysOnScreen=!1,mapObj.createPOI(e+"/"+mapObj._poiParentName+"/"+mapObj._poiParentName+"_end",r),mapObj._drawPolyLineStatus=2;break;case 2:var s=mapObj._currentLine,l=Q3D.vector3(i),u=Q3D.vector3(c.getPosition());l.subtract(u),s.addPoint(l.get());var d=s.getPointCount();if(s.setPoint(d-2,l.get()),n.ShowDistance){var p=s.getPoint(d-3),m=s.getPoint(d-2),h=m.x-p.x,y=m.y-p.y,g=m.z-p.z,f=Math.sqrt(h*h+y*y+g*g);r.POIOptions.Text=Q3D.Util.formatNum(f,2)+" 米"}r.Position=Q3D.vector3(i),mapObj.createPOI(e+"/"+mapObj._poiParentName+"/_rulerPOI"+mapObj.guid(),r)}}}),this.attachMouseEvent("OnMouseMove","_drawRulerPolyline",function(t){if(2===mapObj._drawPolyLineStatus&&null!=t.GroundCoord){var n=mapObj.getArea(e),a=n.toLocalPos(t.GroundCoord),o=mapObj._currentLine,i=Q3D.vector3(a),r=Q3D.vector3(c.getPosition()),s=o.getPointCount();i.subtract(r),o.setPoint(s-1,i.get());var l=mapObj.getSceneNode(e,mapObj._poiParentName+"_end");null!=l&&l.setPosition(a)}}),this.attachMouseEvent("OnRButtonDblClk","_drawRulerPolyline",function(t){if(2===mapObj._drawPolyLineStatus&&null!=t.GroundCoord){var a=mapObj.getArea(e),o=a.toLocalPos(t.GroundCoord);mapObj.setMouseEvent("OnMouseMove","_drawRulerPolyline",!1);var i=mapObj._currentLine,r=Q3D.vector3(o),s=Q3D.vector3(c.getPosition()),l=i.getPointCount();r.subtract(s),i.setPoint(l-1,r.get());var u="";if(n.ShowDistance){for(var d=0,p=1;p<=l-1;++p){var m=i.getPoint(p-1),h=i.getPoint(p),y=h.x-m.x,g=h.y-m.y,f=h.z-m.z;d+=Math.sqrt(y*y+g*g+f*f)}u="总长："+Q3D.Util.formatNum(d,2)+" 米"}var E=mapObj.getSceneNode(e,mapObj._poiParentName+"_end");null!=E&&(E.setPosition(o),E.asPOI().setAlwaysOnScreen(1),E.asPOI().setText(u)),mapObj._currentLine=null,mapObj._poiParentName="",mapObj._drawPolyLineStatus=1,mapObj.setMouseEvent("OnMouseMove","_drawRulerPolyline",!0)}}),this.attachMouseEvent("OnRButtonDown","_drawRulerPolyline",function(t){if(2===mapObj._drawPolyLineStatus&&t.CtrlPressDown){var n=c.getLineCount(),a=mapObj._currentLine;n>0&&(null!=a&&a.removeAll(),c.removeLine(n-1)),mapObj.destroySceneNode(e,mapObj._poiParentName),mapObj._currentLine=null,mapObj._poiParentName="",mapObj._drawPolyLineStatus=1}})},clearPolyline:function(e){return this.destroySceneNode(e,"_rulerPolylinesAndPOI"),this.detachMouseEvent("OnLButtonDown","_drawRulerPolyline"),this.detachMouseEvent("OnMouseMove","_drawRulerPolyline"),this.detachMouseEvent("OnRButtonDblClk","_drawRulerPolyline"),this.detachMouseEvent("OnRButtonDown","_drawRulerPolyline"),delete this._currentLine,delete this._poiParentName,delete this._drawPolyLineStatus,this},disableDistanceTool:function(){return this._map3d.clearDist(),this.detachMouseEvent("OnLButtonDown","_laserDist"),this.detachMouseEvent("OnLButtonDown","_rulerDist"),this.detachMouseEvent("OnMouseMove","_rulerDist"),this},createEagleEyeMap:function(e,t){var n={EagleEyePosition:null,EagleEyeAbsPos:null,EagleEyeOrient:null,IndicatorOptions:{Icon:"",IconSize:null,Scale:null},ViewPortOptions:{Left:0,Top:.7,Width:.3,Height:.3,ZOrder:2},InvisibleIDArray:null,BackgroundColor:null};Q3D.Util.jQueryExtend(!0,n,t);var a=e.split("/"),o=a[a.length-1],i=a[0],r=this.createCommonNode(i+"/"+o,Q3D.Enums.sceneNodeType.SNODE_LocalViewCamera);if(r){r=r.asCamera();var s=r.asLocalViewCamera();null!=n.EagleEyePosition?s.setPosition(n.EagleEyePosition.get()):null!=n.EagleEyeAbsPos&&s.setAbsPos(n.EagleEyeAbsPos.get()),null!=n.EagleEyeOrient&&s.setOrientation(n.EagleEyeOrient.get(),Q3D.Enums.orientationType.World);var l=this._map3d.getRenderTargetManager();l.getMainTarget().addViewport(s,n.ViewPortOptions.Left,n.ViewPortOptions.Top,n.ViewPortOptions.Width,n.ViewPortOptions.Height,n.ViewPortOptions.ZOrder);var c=r.getViewport();null!=n.BackgroundColor&&c.setBackgroundColour(n.BackgroundColor.get());var u=this._map3d.getWorldManager().getMainCamera(0),d=u.getAbsPos(),p=u.getOrientation(Q3D.Enums.orientationType.World);this._map3d.setCameraListener(u),d.y=5;var m={Position:Q3D.vector3(Q3D.vector3d(d).toLocalPos(i)),Orientation:Q3D.vector3(-90,0,p.z),OrientationType:Q3D.Enums.nodeOrientationType.World,Scale:n.IndicatorOptions.Scale,POIOptions:{Icon:n.IndicatorOptions.Icon,IconSize:n.IndicatorOptions.IconSize,Text:"",POILayout:Q3D.Enums.poiLayOut.Center,UIType:Q3D.Enums.poiUIType.Normal,Location:Q3D.Enums.poiImagePositionType.POI_LOCATE_NONE,AlwaysOnScreen:!0}},h=i+"/"+o+"_eagleEyeIndicator",y=this.createPOI(h,m);if(y.setObjectVisibleID(0),u.enableVisID(0,0),null!=n.InvisibleIDArray)for(var g=0,f=n.InvisibleIDArray.length;g<f;++g)s.enableVisID(n.InvisibleIDArray[g],0);return this._eagleEyeIndicatorPath=h,this.on("OnCameraUpdate",function(){var e=mapObj.getSceneNode(mapObj._eagleEyeIndicatorPath);if(null!=e){var t=mapObj._map3d.getWorldManager().getMainCamera(0),n=t.getAbsPos(),a=t.getOrientation(Q3D.Enums.orientationType.World);n.y=10,e.setAbsPos(n),e.setOrientation(Q3D.vector3(-90,0,a.z).get(),Q3D.Enums.nodeOrientationType.World)}}),this}},removeEagleEyeMap:function(e){var t=this.getSceneNode(e);if(t){var n=e.split("/"),a=n[n.length-1],o=n[0];this.off("OnCameraUpdate");var i=this._map3d.getRenderTargetManager();return i.getMainTarget().removeViewport(t.asCamera()),this.destroySceneNode(o,a),this.destroySceneNode(o,a+"_eagleEyeIndicator"),delete this._eagleEyeIndicatorPath,this}}}),Q3D.Map.include({rayCasting:function(e,t){if(!Q3D.Util.isArray(e)||e.length<3)return null;for(var n=t.x,a=t.z,o=!1,i=0,r=e.length,s=r-1;i<r;s=i,i++){var l=e[i].x,c=e[i].z,u=e[s].x,d=e[s].z;if(l===n&&c===a||u===n&&d===a)return"on";if(c<a&&d>=a||c>=a&&d<a){var p=l+(a-c)*(u-l)/(d-c);if(p===n)return"on";p>n&&(o=!o)}}return o?"in":"out"},windingNumber:function(e,t){if(!Q3D.Util.isArray(e)||e.length<3)return null;for(var n=t.x,a=t.z,o=0,i=0,r=e.length,s=r-1;i<r;s=i,i++){var l=e[i].x,c=e[i].z,u=e[s].x,d=e[s].z;if((l-n)*(n-u)>=0&&(c-a)*(a-d)>=0&&(n-l)*(d-c)===(a-c)*(u-l))return"on";var p=Math.atan2(c-a,l-n)-Math.atan2(d-a,u-n);p>=Math.PI?p-=2*Math.PI:p<=-Math.PI&&(p+=2*Math.PI),o+=p}return 0===Math.round(o/Math.PI)?"out":"in"},guid:function(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},createPolyLine:function(e,t){var n={Material:null,SpecialTransparent:!1,LinePoints:[],LineOptions:{LineType:Q3D.Enums.lineType.StraightLine,BesselDim:2,Subdivision:20,LineWidth:2,WrapLen:2,Color:Q3D.colourValue("#0000FF",1),Alpha:1},OnLineCreated:null};Q3D.Util.jQueryExtend(!0,n,t);try{if(n.LinePoints.length<1)return null;for(var a=0;a<n.LinePoints.length;a++)if(n.LinePoints[a].length<2)return null;var o=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_Line);if(null!=o){n.OnLineCreated&&(mapObj._map3d.setSceneNodeListener(o),mapObj.attachUIEvent("onSceneNodeAllResourceCompleted",mapObj.getSceneNodeFullName(o),n.OnLineCreated)),o.trackAllResource();var i=o.asLine();i.setSpecialTransparent(n.SpecialTransparent?1:0);var r=null,s=this._map3d.getResourceManager();if(null!=n.Material)i.setMaterial(n.Material);else{var l="defaultMaterialForLine-"+this.guid(),c=s.getResource(Q3D.Enums.resourceType.MATERIAL,l);null==c?r=this.createSimpleMaterial(l,{Alpha:n.LineOptions.Alpha,EmissiveColor:n.LineOptions.Color}):(r=c.asMaterial(),r.setAlpha(n.LineOptions.Alpha),r.setEmissiveColor(n.LineOptions.Color.get())),i.setMaterial(l)}for(var u=[],d=null,a=0;a<n.LinePoints.length;a++){var p=i.addLine();p.setLineType(n.LineOptions.LineType),n.LineOptions.LineType==Q3D.Enums.lineType.Bessel&&(p.setBesselDim(n.LineOptions.BesselDim),p.setSubdivision(n.LineOptions.Subdivision)),p.setLineWidth(n.LineOptions.LineWidth),p.setWrapLen(n.LineOptions.WrapLen);for(var m=n.LinePoints[a],h=0;h<m.length;h++){var y=null;y="string"==typeof m[h]?m[h].toVector3():m[h],0==a&&0==h&&(d=y.clone()),p.addPoint(y.subtract(d).get())}u.push(p)}return null!=d&&(i.setPosition(d.get()),i.centralize()),i}return null}catch(e){return this.showNotice("错误","createPolyLine: "+e.message),null}return null},createPolygon:function(e,t){var n={Material:null,SpecialTransparent:!1,Points:[],Color:Q3D.colourValue("#0000FF",1),Alpha:1,Direction:1,OnPolygonCreated:null};Q3D.Util.jQueryExtend(!0,n,t);try{if(n.Points.length<3)return null;var a=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_VecModel);if(null!=a){n.OnPolygonCreated&&(mapObj._map3d.setSceneNodeListener(a),mapObj.attachUIEvent("onSceneNodeAllResourceCompleted",mapObj.getSceneNodeFullName(a),n.OnPolygonCreated)),a.trackAllResource();var o=a.asVecModel(),i=o.createVecModel(Q3D.Enums.vecModelType.QPolygon).asPolygon();o.setSpecialTransparent(n.SpecialTransparent?1:0);for(var r=null,s=n.Points.length,l=0;l<s;l++){var c=null;if(c="string"==typeof n.Points[l]?n.Points[l].toVector3():n.Points[l],0==l)r=c.clone();else if(l==s-1&&r.equals(c))continue;i.addPoint(c.subtract(r).get())}null!=r&&o.setPosition(r.get()),i.setDirection(n.Direction),o.resetCenter();var u=null,d=this._map3d.getResourceManager();if(null!=n.Material)o.setMaterial(0,n.Material);else{var p="defaultMaterialForPolygon-"+this.guid(),m=d.getResource(Q3D.Enums.resourceType.MATERIAL,p);null==m?u=this.createSimpleMaterial(p,{Alpha:n.Alpha,EmissiveColor:n.Color}):(u=m.asMaterial(),u.setAlpha(n.Alpha),u.setEmissiveColor(n.Color.get())),o.setMaterial(0,p)}return o}}catch(e){return this.showNotice("错误","createPolygon: "+e.message),null}return null},createPrism:function(e,t){var n={Material:null,SpecialTransparent:!1,Color:Q3D.colourValue("#0000FF",1),Alpha:1,Points:[],Anchor:null,IgnoreFloor:!0,Height:5,OnPrismCreated:null};Q3D.Util.jQueryExtend(!0,n,t);try{if(n.Points.length<3)return null;var a=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_VecModel);if(null!=a){n.OnPrismCreated&&(mapObj._map3d.setSceneNodeListener(a),mapObj.attachUIEvent("onSceneNodeAllResourceCompleted",mapObj.getSceneNodeFullName(a),n.OnPrismCreated)),a.trackAllResource();var o=a.asVecModel(),i=o.createVecModel(Q3D.Enums.vecModelType.QPrism).asPrism();o.setSpecialTransparent(n.SpecialTransparent?1:0);for(var r=null,s=0;s<n.Points.length;s++){var l=null;l="string"==typeof n.Points[s]?n.Points[s].toVector3():n.Points[s],0==s&&(r=l.clone()),i.addPoint(l.subtract(r).get())}null!=r&&o.setPosition(r.get()),o.resetCenter(),n.Anchor?i.setAnchor(n.Anchor.get()):(i.keepVertical(),i.setHeight(n.Height)),i.ignoreFloor(n.IgnoreFloor);var c=null,u=this._map3d.getResourceManager();if(null!=n.Material)if(Q3D.Util.isArray(n.Material))for(var s=0;s<=n.Material.length&&(o.setMaterial(s,n.Material[s]),2!=s);s++);else o.setMaterial(0,n.Material),o.setMaterial(1,n.Material),o.setMaterial(2,n.Material);else{var d="defaultMaterialForPrism-"+this.guid(),p=u.getResource(Q3D.Enums.resourceType.MATERIAL,d);null==p?c=this.createSimpleMaterial(d,{Alpha:n.Alpha,DiffuseColor:n.Color}):(c=p.asMaterial(),c.setAlpha(n.Alpha),c.setEmissiveColor(n.Color.get())),o.setMaterial(0,d),o.setMaterial(1,d),o.setMaterial(2,d)}return o}}catch(e){return this.showNotice("错误","createPrism: "+e.message),null}return null},createPipe:function(e,t){var n={Material:null,SpecialTransparent:!1,Color:Q3D.colourValue("#0000FF",1),Alpha:1,Points:[],Radius:[],CrossPieces:24,OnPipeCreated:null};Q3D.Util.jQueryExtend(!0,n,t);try{if(n.Points.length<2||0==n.Radius.length||n.Radius.length>2)return null;var a=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_VecModel);if(null!=a){n.OnPipeCreated&&(mapObj._map3d.setSceneNodeListener(a),mapObj.attachUIEvent("onSceneNodeAllResourceCompleted",mapObj.getSceneNodeFullName(a),n.OnPipeCreated)),a.trackAllResource();var o=a.asVecModel(),i=o.createVecModel(Q3D.Enums.vecModelType.QPipe).asPipe();o.setSpecialTransparent(n.SpecialTransparent?1:0);for(var r=null,s=0;s<n.Points.length;s++){var l=null;l="string"==typeof n.Points[s]?n.Points[s].toArcVertex():n.Points[s],0==s&&(r=l.clone()),i.addPoint(l.subtract(r).get())}null!=r&&o.setPosition(r.getPos()),o.resetCenter(),1==n.Radius.length?(i.setRadiusInner(0),i.setRadiusOuter(n.Radius[0])):(i.setRadiusInner(Math.min(+n.Radius[0],+n.Radius[1])),i.setRadiusOuter(Math.max(+n.Radius[0],+n.Radius[1]))),i.setCrossPieces(n.CrossPieces);var c=null,u=this._map3d.getResourceManager();if(null!=n.Material)if(Q3D.Util.isArray(n.Material))for(var s=0;s<=n.Material.length&&(o.setMaterial(s,n.Material[s]),3!=s);s++);else o.setMaterial(0,n.Material),o.setMaterial(1,n.Material),o.setMaterial(2,n.Material),o.setMaterial(3,n.Material);else{var d="defaultMaterialForPipe-"+this.guid(),p=u.getResource(Q3D.Enums.resourceType.MATERIAL,d);null==p?c=this.createSimpleMaterial(d,{Alpha:n.Alpha,DiffuseColor:n.Color}):(c=p.asMaterial(),c.setAlpha(n.Alpha),c.setEmissiveColor(n.Color.get())),o.setMaterial(0,d),o.setMaterial(1,d),o.setMaterial(2,d),o.setMaterial(3,d)}return o}}catch(e){return this.showNotice("错误","createPipe: "+e.message),null}return null},createWalls:function(e,t){var n={Material:null,SpecialTransparent:!1,Color:Q3D.colourValue("#0000FF",1),Alpha:1,IgnoreFloor:!1,IgnoreCeil:!1,Height:5,Width:2,Corners:[],IsClosed:!1,SizeOfWalls:[],MatOfWalls:[],OnWallsCreated:null};Q3D.Util.jQueryExtend(!0,n,t);try{if(n.Corners.length<2)return null;var a=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_VecModel);if(null!=a){n.OnWallsCreated&&(mapObj._map3d.setSceneNodeListener(a),mapObj.attachUIEvent("onSceneNodeAllResourceCompleted",mapObj.getSceneNodeFullName(a),n.OnWallsCreated)),a.trackAllResource();var o=a.asVecModel(),i=o.createVecModel(Q3D.Enums.vecModelType.QWalls).asWalls();o.setSpecialTransparent(n.SpecialTransparent?1:0),i.setDefaultSize(n.Width,n.Height),n.IgnoreCeil&&i.ignoreCeil(1),n.IgnoreFloor&&i.ignoreFloor(1);var r=null,s=this._map3d.getResourceManager();if(null!=n.Material)if(Q3D.Util.isArray(n.Material))for(var l=0;l<=n.Material.length;l++)l<=4?o.setMaterial(l,n.Material[l]):o.addMaterial(n.Material[l]);else o.setMaterial(0,n.Material),o.setMaterial(1,n.Material),o.setMaterial(2,n.Material),o.setMaterial(3,n.Material),o.setMaterial(4,n.Material);else{var c="defaultMaterialForWalls-"+this.guid(),u=s.getResource(Q3D.Enums.resourceType.MATERIAL,c);null==u?r=this.createSimpleMaterial(c,{Alpha:n.Alpha,DiffuseColor:n.Color}):(r=u.asMaterial(),r.setAlpha(n.Alpha),r.setEmissiveColor(n.Color.get())),o.setMaterial(0,c),o.setMaterial(1,c),o.setMaterial(2,c),o.setMaterial(3,c),o.setMaterial(4,c)}for(var d=null,l=0;l<n.Corners.length;l++){var p=null;p="string"==typeof n.Corners[l]?n.Corners[l].toVector3():n.Corners[l],0==l&&(d=p.clone()),i.addCorner(l,p.subtract(d).get()),l>0&&i.constructWall(l-1,l-1,l)}if(n.IsClosed&&i.constructWall(n.Corners.length-1,n.Corners.length-1,0),null!=d&&o.setPosition(d.get()),o.resetCenter(),n.SizeOfWalls.length>0)for(var m=0;m<n.SizeOfWalls.length;m++){var h=n.SizeOfWalls[m];i.setWallSize(h.wallID,h.width,h.height)}if(n.MatOfWalls.length>0)for(var m=0;m<n.MatOfWalls.length;m++)for(var y=n.MatOfWalls[m],g=y.wallID,f=y.data,E=0;E<f.length;E++)i.setWallMaterial(g,f[E].compID,f[E].mtrID);return o}}catch(e){return this.showNotice("错误","createWalls: "+e.message),null}return null},createCylinder:function(e,t){var n={Material:null,SpecialTransparent:!1,Color:Q3D.colourValue("#0000FF",1),Alpha:1,Center:null,Anchor:null,Radius:10,Height:50,Pieces:36,OnCylinderCreated:null};Q3D.Util.jQueryExtend(!0,n,t);try{var a=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_VecModel);if(null!=a){n.OnCylinderCreated&&(mapObj._map3d.setSceneNodeListener(a),mapObj.attachUIEvent("onSceneNodeAllResourceCompleted",mapObj.getSceneNodeFullName(a),n.OnCylinderCreated)),a.trackAllResource();var o=a.asVecModel(),i=o.createVecModel(Q3D.Enums.vecModelType.QCylinder).asCylinder();o.setSpecialTransparent(n.SpecialTransparent?1:0),n.Center&&a.setPosition(n.Center.get()),n.Anchor?i.setAnchor(n.Anchor.get()):(i.keepVertical(),i.setHeight(n.Height)),i.setRadius(n.Radius),i.setPieces(n.Pieces);var r=null,s=this._map3d.getResourceManager();if(null!=n.Material)if(Q3D.Util.isArray(n.Material))for(var l=0;l<=n.Material.length&&(o.setMaterial(l,n.Material[l]),2!=l);l++);else o.setMaterial(0,n.Material),o.setMaterial(1,n.Material),o.setMaterial(2,n.Material);else{var c="defaultMaterialForCylinder-"+this.guid(),u=s.getResource(Q3D.Enums.resourceType.MATERIAL,c);null==u?r=this.createSimpleMaterial(c,{Alpha:n.Alpha,DiffuseColor:n.Color}):(r=u.asMaterial(),r.setAlpha(n.Alpha),r.setEmissiveColor(n.Color.get())),o.setMaterial(0,c),o.setMaterial(1,c),o.setMaterial(2,c)}return o}}catch(e){return this.showNotice("错误","createCylinder: "+e.message),null}return null},createSphere:function(e,t){var n={Material:null,SpecialTransparent:!1,Color:Q3D.colourValue("#0000FF",1),Alpha:1,Center:null,Radius:10,OnSphereCreated:null};Q3D.Util.jQueryExtend(!0,n,t);try{var a=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_VecModel);if(null!=a){n.OnSphereCreated&&(mapObj._map3d.setSceneNodeListener(a),mapObj.attachUIEvent("onSceneNodeAllResourceCompleted",mapObj.getSceneNodeFullName(a),n.OnSphereCreated)),a.trackAllResource();var o=a.asVecModel(),i=o.createVecModel(Q3D.Enums.vecModelType.QSphere).asSphere();o.setSpecialTransparent(n.SpecialTransparent?1:0),null!=n.Center&&a.setPosition(n.Center.get()),i.setRadius(n.Radius);var r=null,s=this._map3d.getResourceManager();if(null!=n.Material)o.setMaterial(0,n.Material);else{var l="defaultMaterialForSphere-"+this.guid(),c=s.getResource(Q3D.Enums.resourceType.MATERIAL,l);null==c?r=this.createSimpleMaterial(l,{Alpha:n.Alpha,DiffuseColor:n.Color}):(r=c.asMaterial(),r.setAlpha(n.Alpha),r.setEmissiveColor(n.Color.get())),o.setMaterial(0,l)}return o}}catch(e){return this.showNotice("错误","createSphere: "+e.message),null}return null},createCone:function(e,t){var n={Material:null,SpecialTransparent:!1,Color:Q3D.colourValue("#0000FF",1),Alpha:1,Center:null,Anchor:null,Radius:10,Height:50,Pieces:36,OnConeCreated:null};Q3D.Util.jQueryExtend(!0,n,t);try{var a=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_VecModel);if(null!=a){n.OnConeCreated&&(mapObj._map3d.setSceneNodeListener(a),mapObj.attachUIEvent("onSceneNodeAllResourceCompleted",mapObj.getSceneNodeFullName(a),n.OnCylinderCreated)),a.trackAllResource();var o=a.asVecModel(),i=o.createVecModel(Q3D.Enums.vecModelType.QCone).asCone();o.setSpecialTransparent(n.SpecialTransparent?1:0),n.Center&&a.setPosition(n.Center.get()),n.Anchor?i.setAnchor(n.Anchor.get()):(i.keepVertical(),i.setHeight(n.Height)),i.setRadius(n.Radius),i.setPieces(n.Pieces);var r=null,s=this._map3d.getResourceManager();if(null!=n.Material)if(Q3D.Util.isArray(n.Material))for(var l=0;l<=n.Material.length&&(o.setMaterial(l,n.Material[l]),2!=l);l++);else o.setMaterial(0,n.Material),o.setMaterial(1,n.Material);else{var c="defaultMaterialForCone-"+this.guid(),u=s.getResource(Q3D.Enums.resourceType.MATERIAL,c);null==u?r=this.createSimpleMaterial(c,{Alpha:n.Alpha,DiffuseColor:n.Color}):(r=u.asMaterial(),r.setAlpha(n.Alpha),r.setEmissiveColor(n.Color.get())),o.setMaterial(0,c),o.setMaterial(1,c)}return o}}catch(e){return this.showNotice("错误","createCone: "+e.message),null}return null},createParticle:function(e,t){var n={Position:null,Orientation:null,OrientationType:Q3D.Enums.nodeOrientationType.Self,ParticleFile:null,OnParticleCreated:null};Q3D.Util.jQueryExtend(!0,n,t);try{var a=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_ParticleSystem);if(null!=a){n.OnParticleCreated&&(mapObj._map3d.setSceneNodeListener(a),mapObj.attachUIEvent("onSceneNodeAllResourceCompleted",mapObj.getSceneNodeFullName(a),n.OnParticleCreated)),a.trackAllResource();var o=a.asParticle();return o.loadParticleSystem(n.ParticleFile),null!=n.Position&&o.setPosition(n.Position.get()),null!=n.Orientation&&o.setOrientation(n.Orientation,n.OrientationType),o}}catch(e){return this.showNotice("错误","createParticle: "+e.message),null}return null},createDirectLight:function(e,t){var n={OnDirectLightCreated:null};Q3D.Util.jQueryExtend(!0,n,t);try{var a=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_Light);if(null!=a){n.OnDirectLightCreated&&(mapObj._map3d.setSceneNodeListener(a),mapObj.attachUIEvent("onSceneNodeAllResourceCompleted",mapObj.getSceneNodeFullName(a),n.OnDirectLightCreated)),a.trackAllResource();var o=a.asLight();return o.setLightType(Q3D.Enums.lightType.Parallel),o}}catch(e){return this.showNotice("错误","createDirectLight: "+e.message),null}return null},createDecal:function(e,t){var n={Points:[],Resolution:1,MaxHeight:100,BackColor:null,FillColor:Q3D.colourValue("#0000FF",.6),LineColor:Q3D.colourValue("#0000FF",1),LineWidth:1,FillMode:Q3D.Enums.DecalTexFillMode.FillAndFrame,OnDecalCreated:null};Q3D.Util.jQueryExtend(!0,n,t);try{if(n.Points.length<3)return null;for(var a=n.Points.slice(),o=a[0].x,i=a[0].x,r=a[0].z,s=a[0].z,l=1;l<a.length;l++)o=Math.min(o,a[l].x),r=Math.min(r,a[l].z),i=Math.max(i,a[l].x),s=Math.max(s,a[l].z);for(var c=i-o,u=s-r,d=Q3D.vector3((i+o)/2,n.MaxHeight,(s+r)/2),p=this._map3d.getWorldManager().createEmptyQVector3List(),l=0;l<a.length;l++)p.add(Q3D.vector3((a[l].x-o)/n.Resolution,(a[l].z-r)/n.Resolution,0).get());var m=c/n.Resolution,h=u/n.Resolution,y=this._map3d.getResourceManager(),g="DecalTexture-"+this.guid(),f=y.registerResource(Q3D.Enums.resourceType.TEXTURE,g).asTexture(),E=f.createEmpty2DWithCanvas(m,h);null!=n.BackColor&&E.clear(n.BackColor.get()),E.setFillColor(n.FillColor.get()),E.setLineColor(n.LineColor.get()),E.setFillMode(n.FillMode),E.setLineWidth(n.LineWidth),E.drawPolygon(p),f.flushCanvas();var T=this.createCommonNode(e,Q3D.Enums.sceneNodeType.SNODE_Decal);if(null!=T){n.OnDecalCreated&&(mapObj._map3d.setSceneNodeListener(T),mapObj.attachUIEvent("onSceneNodeAllResourceCompleted",mapObj.getSceneNodeFullName(T),n.OnDecalCreated)),T.trackAllResource();var O=T.asDecal();return O.setPosition(d.get()),O.pitch(-90,0),O.setWidth(c),O.setHeight(u),O.setLength(n.MaxHeight+10),O.setMode(Q3D.Enums.DecalMode.OpBlendAlpha),O.setMainTexture(g),O}}catch(e){return this.showNotice("错误","createDecal: "+e.message),null}return null}})}(window,document);